(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{110:function(e,t,i){"use strict";i.d(t,"a",function(){return a});var r=i(1),n=i(6),o=i(18),s=i(4),a=(i(302),i(303),function(e){function t(t,i,r,o,a,c,h){void 0===r&&(r=null),void 0===h&&(h=s.a.TEXTURETYPE_UNSIGNED_INT);var l=e.call(this,t,"fxaa",["texelSize"],null,i,r,o||n.a.BILINEAR_SAMPLINGMODE,a,c,null,h,"fxaa",void 0,!0)||this,u=l._getDefines();return l.updateEffect(u),l.onApplyObservable.add(function(e){var t=l.texelSize;e.setFloat2("texelSize",t.x,t.y)}),l}return r.d(t,e),t.prototype._getDefines=function(){var e=this.getEngine();if(!e)return null;var t=e.getGlInfo();return t&&t.renderer&&t.renderer.toLowerCase().indexOf("mali")>-1?"#define MALI 1\n":null},t}(o.a))},115:function(e,t,i){"use strict";i.d(t,"a",function(){return s});var r=i(14),n=i(3),o=i(4),s=function(){function e(e){this._vertexBuffers={},this._scene=e}return e.prototype._prepareBuffers=function(){if(!this._vertexBuffers[n.VertexBuffer.PositionKind]){var e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[n.VertexBuffer.PositionKind]=new n.VertexBuffer(this._scene.getEngine(),e,n.VertexBuffer.PositionKind,!1,!1,2),this._buildIndexBuffer()}},e.prototype._buildIndexBuffer=function(){var e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)},e.prototype._rebuild=function(){var e=this._vertexBuffers[n.VertexBuffer.PositionKind];e&&(e._rebuild(),this._buildIndexBuffer())},e.prototype._prepareFrame=function(e,t){void 0===e&&(e=null),void 0===t&&(t=null);var i=this._scene.activeCamera;return!!i&&(!(!(t=t||i._postProcesses.filter(function(e){return null!=e}))||0===t.length||!this._scene.postProcessesEnabled)&&(t[0].activate(i,e,null!=t),!0))},e.prototype.directRender=function(e,t,i,n,o){void 0===t&&(t=null),void 0===i&&(i=!1),void 0===n&&(n=0),void 0===o&&(o=0);for(var s=this._scene.getEngine(),a=0;a<e.length;a++){a<e.length-1?e[a+1].activate(this._scene.activeCamera,t):t?s.bindFramebuffer(t,n,void 0,void 0,i,void 0,o):s.restoreDefaultFramebuffer();var c=e[a],h=c.apply();h&&(c.onBeforeRenderObservable.notifyObservers(h),this._prepareBuffers(),s.bindBuffers(this._vertexBuffers,this._indexBuffer,h),s.drawElementsType(r.a.TriangleFillMode,0,6),c.onAfterRenderObservable.notifyObservers(h))}s.setDepthBuffer(!0),s.setDepthWrite(!0)},e.prototype._finalizeFrame=function(e,t,i,n,s){void 0===s&&(s=!1);var a=this._scene.activeCamera;if(a&&0!==(n=n||a._postProcesses.filter(function(e){return null!=e})).length&&this._scene.postProcessesEnabled){for(var c=this._scene.getEngine(),h=0,l=n.length;h<l;h++){var u=n[h];if(h<l-1?u._outputTexture=n[h+1].activate(a,t):t?(c.bindFramebuffer(t,i,void 0,void 0,s),u._outputTexture=t):(c.restoreDefaultFramebuffer(),u._outputTexture=null),e)break;var p=u.apply();p&&(u.onBeforeRenderObservable.notifyObservers(p),this._prepareBuffers(),c.bindBuffers(this._vertexBuffers,this._indexBuffer,p),c.drawElementsType(r.a.TriangleFillMode,0,6),u.onAfterRenderObservable.notifyObservers(p))}c.setDepthBuffer(!0),c.setDepthWrite(!0),c.setAlphaMode(o.a.ALPHA_DISABLE)}},e.prototype.dispose=function(){var e=this._vertexBuffers[n.VertexBuffer.PositionKind];e&&(e.dispose(),this._vertexBuffers[n.VertexBuffer.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)},e}()},133:function(e,t,i){"use strict";i.d(t,"a",function(){return h});var r=i(1),n=i(2),o=i(40),s=i(18),a=i(21),c=i(4),h=(i(275),i(214),function(e){function t(t,i,r,n,o,s,a,h){void 0===r&&(r=null),void 0===a&&(a=c.a.TEXTURETYPE_UNSIGNED_INT);var l=e.call(this,t,"imageProcessing",[],[],i,r,n,o,s,null,a,"postprocess",null,!0)||this;return l._fromLinearSpace=!0,l._defines={IMAGEPROCESSING:!1,VIGNETTE:!1,VIGNETTEBLENDMODEMULTIPLY:!1,VIGNETTEBLENDMODEOPAQUE:!1,TONEMAPPING:!1,TONEMAPPING_ACES:!1,CONTRAST:!1,COLORCURVES:!1,COLORGRADING:!1,COLORGRADING3D:!1,FROMLINEARSPACE:!1,SAMPLER3DGREENDEPTH:!1,SAMPLER3DBGRMAP:!1,IMAGEPROCESSINGPOSTPROCESS:!1,EXPOSURE:!1},h?(h.applyByPostProcess=!0,l._attachImageProcessingConfiguration(h,!0),l.fromLinearSpace=!1):(l._attachImageProcessingConfiguration(null,!0),l.imageProcessingConfiguration.applyByPostProcess=!0),l.onApply=function(e){l.imageProcessingConfiguration.bind(e,l.aspectRatio)},l}return r.d(t,e),Object.defineProperty(t.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(e){this._attachImageProcessingConfiguration(e)},enumerable:!0,configurable:!0}),t.prototype._attachImageProcessingConfiguration=function(e,t){var i=this;if(void 0===t&&(t=!1),e!==this._imageProcessingConfiguration){if(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e)this._imageProcessingConfiguration=e;else{var r=null,n=this.getEngine(),o=this.getCamera();if(o)r=o.getScene();else if(n&&n.scenes){var s=n.scenes;r=s[s.length-1]}else r=a.a.LastCreatedScene;this._imageProcessingConfiguration=r.imageProcessingConfiguration}this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(function(){i._updateParameters()})),t||this._updateParameters()}},Object.defineProperty(t.prototype,"colorCurves",{get:function(){return this.imageProcessingConfiguration.colorCurves},set:function(e){this.imageProcessingConfiguration.colorCurves=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"colorCurvesEnabled",{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(e){this.imageProcessingConfiguration.colorCurvesEnabled=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"colorGradingTexture",{get:function(){return this.imageProcessingConfiguration.colorGradingTexture},set:function(e){this.imageProcessingConfiguration.colorGradingTexture=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"colorGradingEnabled",{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(e){this.imageProcessingConfiguration.colorGradingEnabled=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"exposure",{get:function(){return this.imageProcessingConfiguration.exposure},set:function(e){this.imageProcessingConfiguration.exposure=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"toneMappingEnabled",{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(e){this._imageProcessingConfiguration.toneMappingEnabled=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"contrast",{get:function(){return this.imageProcessingConfiguration.contrast},set:function(e){this.imageProcessingConfiguration.contrast=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"vignetteStretch",{get:function(){return this.imageProcessingConfiguration.vignetteStretch},set:function(e){this.imageProcessingConfiguration.vignetteStretch=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"vignetteCentreX",{get:function(){return this.imageProcessingConfiguration.vignetteCentreX},set:function(e){this.imageProcessingConfiguration.vignetteCentreX=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"vignetteCentreY",{get:function(){return this.imageProcessingConfiguration.vignetteCentreY},set:function(e){this.imageProcessingConfiguration.vignetteCentreY=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"vignetteWeight",{get:function(){return this.imageProcessingConfiguration.vignetteWeight},set:function(e){this.imageProcessingConfiguration.vignetteWeight=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"vignetteColor",{get:function(){return this.imageProcessingConfiguration.vignetteColor},set:function(e){this.imageProcessingConfiguration.vignetteColor=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"vignetteCameraFov",{get:function(){return this.imageProcessingConfiguration.vignetteCameraFov},set:function(e){this.imageProcessingConfiguration.vignetteCameraFov=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"vignetteBlendMode",{get:function(){return this.imageProcessingConfiguration.vignetteBlendMode},set:function(e){this.imageProcessingConfiguration.vignetteBlendMode=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"vignetteEnabled",{get:function(){return this.imageProcessingConfiguration.vignetteEnabled},set:function(e){this.imageProcessingConfiguration.vignetteEnabled=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fromLinearSpace",{get:function(){return this._fromLinearSpace},set:function(e){this._fromLinearSpace!==e&&(this._fromLinearSpace=e,this._updateParameters())},enumerable:!0,configurable:!0}),t.prototype.getClassName=function(){return"ImageProcessingPostProcess"},t.prototype._updateParameters=function(){this._defines.FROMLINEARSPACE=this._fromLinearSpace,this.imageProcessingConfiguration.prepareDefines(this._defines,!0);var e="";for(var t in this._defines)this._defines[t]&&(e+="#define "+t+";\r\n");var i=["textureSampler"],r=["scale"];o.a&&(o.a.PrepareSamplers(i,this._defines),o.a.PrepareUniforms(r,this._defines)),this.updateEffect(e,r,i)},t.prototype.dispose=function(t){e.prototype.dispose.call(this,t),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration&&(this.imageProcessingConfiguration.applyByPostProcess=!1)},r.c([Object(n.c)()],t.prototype,"_fromLinearSpace",void 0),t}(s.a))},146:function(e,t,i){"use strict";i.d(t,"a",function(){return a});var r=i(1),n=i(0),o=i(6),s=i(18),a=(i(274),function(e){function t(t,i,r,s){var a=e.call(this,t,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,s.postProcessScaleFactor,i,o.a.BILINEAR_SAMPLINGMODE)||this;return a._isRightEye=r,a._distortionFactors=s.distortionK,a._postProcessScaleFactor=s.postProcessScaleFactor,a._lensCenterOffset=s.lensCenterOffset,a.adaptScaleToCurrentViewport=!0,a.onSizeChangedObservable.add(function(){a._scaleIn=new n.Vector2(2,2/a.aspectRatio),a._scaleFactor=new n.Vector2(1/a._postProcessScaleFactor*.5,1/a._postProcessScaleFactor*.5*a.aspectRatio),a._lensCenter=new n.Vector2(a._isRightEye?.5-.5*a._lensCenterOffset:.5+.5*a._lensCenterOffset,.5)}),a.onApplyObservable.add(function(e){e.setFloat2("LensCenter",a._lensCenter.x,a._lensCenter.y),e.setFloat2("Scale",a._scaleFactor.x,a._scaleFactor.y),e.setFloat2("ScaleIn",a._scaleIn.x,a._scaleIn.y),e.setFloat4("HmdWarpParam",a._distortionFactors[0],a._distortionFactors[1],a._distortionFactors[2],a._distortionFactors[3])}),a}return r.d(t,e),t}(s.a))},164:function(e,t,i){"use strict";i.d(t,"a",function(){return o});var r=i(1),n=i(18),o=(i(272),function(e){function t(t,i,r,n,o,s){var a=e.call(this,t,"anaglyph",null,["leftSampler"],i,r[1],n,o,s)||this;return a._passedProcess=r[0]._rigPostProcess,a.onApplyObservable.add(function(e){e.setTextureFromPostProcess("leftSampler",a._passedProcess)}),a}return r.d(t,e),t}(n.a))},165:function(e,t,i){"use strict";i.d(t,"a",function(){return s});var r=i(1),n=i(0),o=i(18),s=(i(273),function(e){function t(t,i,r,o,s,a){var c=e.call(this,t,"stereoscopicInterlace",["stepSize"],["camASampler"],1,i[1],o,s,a,r?"#define IS_STEREOSCOPIC_HORIZ 1":void 0)||this;return c._passedProcess=i[0]._rigPostProcess,c._stepSize=new n.Vector2(1/c.width,1/c.height),c.onSizeChangedObservable.add(function(){c._stepSize=new n.Vector2(1/c.width,1/c.height)}),c.onApplyObservable.add(function(e){e.setTextureFromPostProcess("camASampler",c._passedProcess),e.setFloat2("stepSize",c._stepSize.x,c._stepSize.y)}),c}return r.d(t,e),t}(o.a))},18:function(e,t,i){"use strict";i.d(t,"a",function(){return c});var r=i(5),n=i(36),o=i(7),s=i(0),a=i(4),c=(i(214),function(){function e(e,t,i,r,c,h,l,u,p,d,f,_,m,g){void 0===l&&(l=a.a.TEXTURE_NEAREST_SAMPLINGMODE),void 0===d&&(d=null),void 0===f&&(f=a.a.TEXTURETYPE_UNSIGNED_INT),void 0===_&&(_="postprocess"),void 0===g&&(g=!1),this.name=e,this.width=-1,this.height=-1,this._outputTexture=null,this.autoClear=!0,this.alphaMode=a.a.ALPHA_DISABLE,this.animations=new Array,this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=a.a.SCALEMODE_FLOOR,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._reusable=!1,this._textures=new n.a(2),this._currentRenderTextureInd=0,this._scaleRatio=new s.Vector2(1,1),this._texelSize=s.Vector2.Zero(),this.onActivateObservable=new o.c,this.onSizeChangedObservable=new o.c,this.onApplyObservable=new o.c,this.onBeforeRenderObservable=new o.c,this.onAfterRenderObservable=new o.c,null!=h?(this._camera=h,this._scene=h.getScene(),h.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this)):u&&(this._engine=u,this._engine.postProcesses.push(this)),this._options=c,this.renderTargetSamplingMode=l||a.a.TEXTURE_NEAREST_SAMPLINGMODE,this._reusable=p||!1,this._textureType=f,this._samplers=r||[],this._samplers.push("textureSampler"),this._fragmentUrl=t,this._vertexUrl=_,this._parameters=i||[],this._parameters.push("scale"),this._indexParameters=m,g||this.updateEffect(d)}return Object.defineProperty(e.prototype,"samples",{get:function(){return this._samples},set:function(e){var t=this;this._samples=e,this._textures.forEach(function(e){e.samples!==t._samples&&t._engine.updateRenderTargetTextureSampleCount(e,t._samples)})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onActivate",{set:function(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onSizeChanged",{set:function(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onApply",{set:function(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onBeforeRender",{set:function(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onAfterRender",{set:function(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"inputTexture",{get:function(){return this._textures.data[this._currentRenderTextureInd]},set:function(e){this._forcedOutputTexture=e},enumerable:!0,configurable:!0}),e.prototype.getCamera=function(){return this._camera},Object.defineProperty(e.prototype,"texelSize",{get:function(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)},enumerable:!0,configurable:!0}),e.prototype.getEngine=function(){return this._engine},e.prototype.getEffect=function(){return this._effect},e.prototype.shareOutputWith=function(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this},e.prototype.useOwnOutput=function(){0==this._textures.length&&(this._textures=new n.a(2)),this._shareOutputWithPostProcess=null},e.prototype.updateEffect=function(e,t,i,r,n,o){void 0===e&&(e=null),void 0===t&&(t=null),void 0===i&&(i=null),this._effect=this._engine.createEffect({vertex:this._vertexUrl,fragment:this._fragmentUrl},["position"],t||this._parameters,i||this._samplers,null!==e?e:"",void 0,n,o,r||this._indexParameters)},e.prototype.isReusable=function(){return this._reusable},e.prototype.markTextureDirty=function(){this.width=-1},e.prototype.activate=function(e,t,i){var n=this;void 0===t&&(t=null);var o=(e=e||this._camera).getScene(),s=o.getEngine(),c=s.getCaps().maxTextureSize,h=(t?t.width:this._engine.getRenderWidth(!0))*this._options|0,l=(t?t.height:this._engine.getRenderHeight(!0))*this._options|0,u=e.parent;!u||u.leftCamera!=e&&u.rightCamera!=e||(h/=2);var p,d=this._options.width||h,f=this._options.height||l;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){var _=s.currentViewport;_&&(d*=_.width,f*=_.height)}if((this.renderTargetSamplingMode===a.a.TEXTURE_TRILINEAR_SAMPLINGMODE||this.alwaysForcePOT)&&(this._options.width||(d=s.needPOTTextures?r.h.GetExponentOfTwo(d,c,this.scaleMode):d),this._options.height||(f=s.needPOTTextures?r.h.GetExponentOfTwo(f,c,this.scaleMode):f)),this.width!==d||this.height!==f){if(this._textures.length>0){for(var m=0;m<this._textures.length;m++)this._engine._releaseTexture(this._textures.data[m]);this._textures.reset()}this.width=d,this.height=f;var g={width:this.width,height:this.height},y={generateMipMaps:!1,generateDepthBuffer:i||0===e._postProcesses.indexOf(this),generateStencilBuffer:(i||0===e._postProcesses.indexOf(this))&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType};this._textures.push(this._engine.createRenderTargetTexture(g,y)),this._reusable&&this._textures.push(this._engine.createRenderTargetTexture(g,y)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}this._textures.forEach(function(e){e.samples!==n.samples&&n._engine.updateRenderTargetTextureSampleCount(e,n.samples)})}return this._shareOutputWithPostProcess?p=this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?(p=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height):p=this.inputTexture,this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(h/d,l/f),this._engine.bindFramebuffer(p,0,h,l,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(p,0,void 0,void 0,this.forceFullscreenViewport)),this.onActivateObservable.notifyObservers(e),this.autoClear&&this.alphaMode===a.a.ALPHA_DISABLE&&this._engine.clear(this.clearColor?this.clearColor:o.clearColor,o._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),p},Object.defineProperty(e.prototype,"isSupported",{get:function(){return this._effect.isSupported},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"aspectRatio",{get:function(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height},enumerable:!0,configurable:!0}),e.prototype.isReady=function(){return this._effect&&this._effect.isReady()},e.prototype.apply=function(){return this._effect&&this._effect.isReady()?(this._engine.enableEffect(this._effect),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._engine.setAlphaMode(this.alphaMode),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a),e=this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?this._forcedOutputTexture:this.inputTexture,this._effect._bindTexture("textureSampler",e),this._effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._effect),this._effect):null;var e},e.prototype._disposeTextures=function(){if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this._textures.length>0)for(var e=0;e<this._textures.length;e++)this._engine._releaseTexture(this._textures.data[e]);this._textures.dispose()}},e.prototype.dispose=function(e){if(e=e||this._camera,this._disposeTextures(),this._scene){var t=this._scene.postProcesses.indexOf(this);-1!==t&&this._scene.postProcesses.splice(t,1)}else{var i=this._engine.postProcesses.indexOf(this);-1!==i&&this._engine.postProcesses.splice(i,1)}if(e){if(e.detachPostProcess(this),0===e._postProcesses.indexOf(this)&&e._postProcesses.length>0){var r=this._camera._getFirstPostProcess();r&&r.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear()}},e}())},199:function(e,t,i){"use strict";i.d(t,"a",function(){return h});var r=i(9),n=i(0),o=i(3),s=i(37),a=i(45),c=i(93),h=function(){function e(e,t,i){void 0===e&&(e=!0),void 0===t&&(t=10),void 0===i&&(i=CANNON),this._useDeltaForWorldStep=e,this.name="CannonJSPlugin",this._physicsMaterials=new Array,this._fixedTimeStep=1/60,this._minus90X=new n.Quaternion(-.7071067811865475,0,0,.7071067811865475),this._plus90X=new n.Quaternion(.7071067811865475,0,0,.7071067811865475),this._tmpPosition=n.Vector3.Zero(),this._tmpDeltaPosition=n.Vector3.Zero(),this._tmpUnityRotation=new n.Quaternion,this.BJSCANNON=i,this.isSupported()?(this._extendNamespace(),this.world=new this.BJSCANNON.World,this.world.broadphase=new this.BJSCANNON.NaiveBroadphase,this.world.solver.iterations=t):r.a.Error("CannonJS is not available. Please make sure you included the js file.")}return e.prototype.setGravity=function(e){this.world.gravity.copy(e)},e.prototype.setTimeStep=function(e){this._fixedTimeStep=e},e.prototype.getTimeStep=function(){return this._fixedTimeStep},e.prototype.executeStep=function(e){this.world.step(this._fixedTimeStep,this._useDeltaForWorldStep?e:0,3)},e.prototype.applyImpulse=function(e,t,i){var r=new this.BJSCANNON.Vec3(i.x,i.y,i.z),n=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyImpulse(n,r)},e.prototype.applyForce=function(e,t,i){var r=new this.BJSCANNON.Vec3(i.x,i.y,i.z),n=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyForce(n,r)},e.prototype.generatePhysicsBody=function(e){if(e.parent)e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());else{if(e.isBodyInitRequired()){var t=this._createShape(e),i=e.physicsBody;i&&this.removePhysicsBody(e);var r=this._addMaterial("mat-"+e.uniqueId,e.getParam("friction"),e.getParam("restitution")),n={mass:e.getParam("mass"),material:r},o=e.getParam("nativeOptions");for(var s in o)o.hasOwnProperty(s)&&(n[s]=o[s]);e.physicsBody=new this.BJSCANNON.Body(n),e.physicsBody.addEventListener("collide",e.onCollide),this.world.addEventListener("preStep",e.beforeStep),this.world.addEventListener("postStep",e.afterStep),e.physicsBody.addShape(t),this.world.add(e.physicsBody),i&&["force","torque","velocity","angularVelocity"].forEach(function(t){e.physicsBody[t].copy(i[t])}),this._processChildMeshes(e)}this._updatePhysicsBodyTransformation(e)}},e.prototype._processChildMeshes=function(e){var t=this,i=e.object.getChildMeshes?e.object.getChildMeshes(!0):[],r=e.object.rotationQuaternion;if(i.length){var o=function(i,s){if(r&&s.rotationQuaternion){var a=s.getPhysicsImpostor();if(a)if(a.parent!==e){var c=s.getAbsolutePosition().subtract(e.object.getAbsolutePosition()),h=s.rotationQuaternion.multiply(n.Quaternion.Inverse(r));a.physicsBody&&(t.removePhysicsBody(a),a.physicsBody=null),a.parent=e,a.resetUpdateFlags(),e.physicsBody.addShape(t._createShape(a),new t.BJSCANNON.Vec3(c.x,c.y,c.z),new t.BJSCANNON.Quaternion(h.x,h.y,h.z,h.w)),e.physicsBody.mass+=a.getParam("mass")}r.multiplyInPlace(s.rotationQuaternion),s.getChildMeshes(!0).filter(function(e){return!!e.physicsImpostor}).forEach(o.bind(t,s.getAbsolutePosition()))}};i.filter(function(e){return!!e.physicsImpostor}).forEach(o.bind(this,e.object.getAbsolutePosition()))}},e.prototype.removePhysicsBody=function(e){e.physicsBody.removeEventListener("collide",e.onCollide),this.world.removeEventListener("preStep",e.beforeStep),this.world.removeEventListener("postStep",e.afterStep),this.world.remove(e.physicsBody)},e.prototype.generateJoint=function(e){var t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(t&&i){var r,n=e.joint.jointData,o={pivotA:n.mainPivot?(new this.BJSCANNON.Vec3).copy(n.mainPivot):null,pivotB:n.connectedPivot?(new this.BJSCANNON.Vec3).copy(n.connectedPivot):null,axisA:n.mainAxis?(new this.BJSCANNON.Vec3).copy(n.mainAxis):null,axisB:n.connectedAxis?(new this.BJSCANNON.Vec3).copy(n.connectedAxis):null,maxForce:n.nativeParams.maxForce,collideConnected:!!n.collision};switch(e.joint.type){case a.e.HingeJoint:case a.e.Hinge2Joint:r=new this.BJSCANNON.HingeConstraint(t,i,o);break;case a.e.DistanceJoint:r=new this.BJSCANNON.DistanceConstraint(t,i,n.maxDistance||2);break;case a.e.SpringJoint:var s=n;r=new this.BJSCANNON.Spring(t,i,{restLength:s.length,stiffness:s.stiffness,damping:s.damping,localAnchorA:o.pivotA,localAnchorB:o.pivotB});break;case a.e.LockJoint:r=new this.BJSCANNON.LockConstraint(t,i,o);break;case a.e.PointToPointJoint:case a.e.BallAndSocketJoint:default:r=new this.BJSCANNON.PointToPointConstraint(t,o.pivotA,i,o.pivotB,o.maxForce)}r.collideConnected=!!n.collision,e.joint.physicsJoint=r,e.joint.type!==a.e.SpringJoint?this.world.addConstraint(r):(e.joint.jointData.forceApplicationCallback=e.joint.jointData.forceApplicationCallback||function(){r.applyForce()},e.mainImpostor.registerAfterPhysicsStep(e.joint.jointData.forceApplicationCallback))}},e.prototype.removeJoint=function(e){e.joint.type!==a.e.SpringJoint?this.world.removeConstraint(e.joint.physicsJoint):e.mainImpostor.unregisterAfterPhysicsStep(e.joint.jointData.forceApplicationCallback)},e.prototype._addMaterial=function(e,t,i){var r,n;for(r=0;r<this._physicsMaterials.length;r++)if((n=this._physicsMaterials[r]).friction===t&&n.restitution===i)return n;var o=new this.BJSCANNON.Material(e);return o.friction=t,o.restitution=i,this._physicsMaterials.push(o),o},e.prototype._checkWithEpsilon=function(e){return e<c.a.Epsilon?c.a.Epsilon:e},e.prototype._createShape=function(e){var t,i=e.object,a=e.getObjectExtendSize();switch(e.type){case s.a.SphereImpostor:var c=a.x,h=a.y,l=a.z;t=new this.BJSCANNON.Sphere(Math.max(this._checkWithEpsilon(c),this._checkWithEpsilon(h),this._checkWithEpsilon(l))/2);break;case s.a.CylinderImpostor:var u=e.getParam("nativeOptions"),p=void 0!==u.radiusTop?u.radiusTop:this._checkWithEpsilon(a.x)/2,d=void 0!==u.radiusBottom?u.radiusBottom:this._checkWithEpsilon(a.x)/2,f=void 0!==u.height?u.height:this._checkWithEpsilon(a.y)/2,_=void 0!==u.numSegments?u.numSegments:16;t=new this.BJSCANNON.Cylinder(p,d,f,_);break;case s.a.BoxImpostor:var m=a.scale(.5);t=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(this._checkWithEpsilon(m.x),this._checkWithEpsilon(m.y),this._checkWithEpsilon(m.z)));break;case s.a.PlaneImpostor:r.a.Warn("Attention, PlaneImposter might not behave as you expect. Consider using BoxImposter instead"),t=new this.BJSCANNON.Plane;break;case s.a.MeshImpostor:var g=i.getVerticesData?i.getVerticesData(o.VertexBuffer.PositionKind):[],y=i.getIndices?i.getIndices():[];if(!g)return;var P=i.position.clone(),b=i.rotation&&i.rotation.clone(),v=i.rotationQuaternion&&i.rotationQuaternion.clone();i.position.copyFromFloats(0,0,0),i.rotation&&i.rotation.copyFromFloats(0,0,0),i.rotationQuaternion&&i.rotationQuaternion.copyFrom(e.getParentsRotation()),i.rotationQuaternion&&i.parent&&i.rotationQuaternion.conjugateInPlace();var S,E=i.computeWorldMatrix(!0),x=new Array;for(S=0;S<g.length;S+=3)n.Vector3.TransformCoordinates(n.Vector3.FromArray(g,S),E).toArray(x,S);r.a.Warn("MeshImpostor only collides against spheres."),t=new this.BJSCANNON.Trimesh(x,y),i.position.copyFrom(P),b&&i.rotation&&i.rotation.copyFrom(b),v&&i.rotationQuaternion&&i.rotationQuaternion.copyFrom(v);break;case s.a.HeightmapImpostor:var T=i.position.clone(),A=i.rotation&&i.rotation.clone(),R=i.rotationQuaternion&&i.rotationQuaternion.clone();i.position.copyFromFloats(0,0,0),i.rotation&&i.rotation.copyFromFloats(0,0,0),i.rotationQuaternion&&i.rotationQuaternion.copyFrom(e.getParentsRotation()),i.rotationQuaternion&&i.parent&&i.rotationQuaternion.conjugateInPlace(),i.rotationQuaternion&&i.rotationQuaternion.multiplyInPlace(this._minus90X),t=this._createHeightmap(i),i.position.copyFrom(T),A&&i.rotation&&i.rotation.copyFrom(A),R&&i.rotationQuaternion&&i.rotationQuaternion.copyFrom(R),i.computeWorldMatrix(!0);break;case s.a.ParticleImpostor:t=new this.BJSCANNON.Particle}return t},e.prototype._createHeightmap=function(e,t){var i,r=e.getVerticesData(o.VertexBuffer.PositionKind),s=e.computeWorldMatrix(!0),a=new Array;for(i=0;i<r.length;i+=3)n.Vector3.TransformCoordinates(n.Vector3.FromArray(r,i),s).toArray(a,i);r=a;for(var c=new Array,h=t||~~(Math.sqrt(r.length/3)-1),l=e.getBoundingInfo(),u=Math.min(l.boundingBox.extendSizeWorld.x,l.boundingBox.extendSizeWorld.y),p=l.boundingBox.extendSizeWorld.z,d=2*u/h,f=0;f<r.length;f+=3){var _=Math.round(r[f+0]/d+h/2),m=Math.round(-1*(r[f+1]/d-h/2)),g=-r[f+2]+p;c[_]||(c[_]=[]),c[_][m]||(c[_][m]=g),c[_][m]=Math.max(g,c[_][m])}for(_=0;_<=h;++_){if(!c[_]){for(var y=1;!c[(_+y)%h];)y++;c[_]=c[(_+y)%h].slice()}for(m=0;m<=h;++m)if(!c[_][m]){var P;for(y=1;void 0===P;)P=c[_][(m+y++)%h];c[_][m]=P}}var b=new this.BJSCANNON.Heightfield(c,{elementSize:d});return b.minY=p,b},e.prototype._updatePhysicsBodyTransformation=function(e){var t=e.object;if(t.computeWorldMatrix&&t.computeWorldMatrix(!0),t.getBoundingInfo()){var i=e.getObjectCenter();this._tmpDeltaPosition.copyFrom(t.getAbsolutePivotPoint().subtract(i)),this._tmpDeltaPosition.divideInPlace(e.object.scaling),this._tmpPosition.copyFrom(i);var r=t.rotationQuaternion;if(r){if(e.type!==s.a.PlaneImpostor&&e.type!==s.a.HeightmapImpostor&&e.type!==s.a.CylinderImpostor||(r=r.multiply(this._minus90X),e.setDeltaRotation(this._plus90X)),e.type===s.a.HeightmapImpostor){var o=t,a=o.getBoundingInfo(),c=o.rotationQuaternion;o.rotationQuaternion=this._tmpUnityRotation,o.computeWorldMatrix(!0);var h=i.clone(),l=o.getPivotMatrix();l=l?l.clone():n.Matrix.Identity();var u=n.Matrix.Translation(a.boundingBox.extendSizeWorld.x,0,-a.boundingBox.extendSizeWorld.z);o.setPreTransformMatrix(u),o.computeWorldMatrix(!0);var p=a.boundingBox.centerWorld.subtract(i).subtract(o.position).negate();this._tmpPosition.copyFromFloats(p.x,p.y-a.boundingBox.extendSizeWorld.y,p.z),this._tmpDeltaPosition.copyFrom(a.boundingBox.centerWorld.subtract(h)),this._tmpDeltaPosition.y+=a.boundingBox.extendSizeWorld.y,o.rotationQuaternion=c,o.setPreTransformMatrix(l),o.computeWorldMatrix(!0)}else e.type===s.a.MeshImpostor&&this._tmpDeltaPosition.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpDeltaPosition),e.physicsBody.position.copy(this._tmpPosition),e.physicsBody.quaternion.copy(r)}}},e.prototype.setTransformationFromPhysicsBody=function(e){e.object.position.copyFrom(e.physicsBody.position),e.object.rotationQuaternion&&e.object.rotationQuaternion.copyFrom(e.physicsBody.quaternion)},e.prototype.setPhysicsBodyTransformation=function(e,t,i){e.physicsBody.position.copy(t),e.physicsBody.quaternion.copy(i)},e.prototype.isSupported=function(){return void 0!==this.BJSCANNON},e.prototype.setLinearVelocity=function(e,t){e.physicsBody.velocity.copy(t)},e.prototype.setAngularVelocity=function(e,t){e.physicsBody.angularVelocity.copy(t)},e.prototype.getLinearVelocity=function(e){var t=e.physicsBody.velocity;return t?new n.Vector3(t.x,t.y,t.z):null},e.prototype.getAngularVelocity=function(e){var t=e.physicsBody.angularVelocity;return t?new n.Vector3(t.x,t.y,t.z):null},e.prototype.setBodyMass=function(e,t){e.physicsBody.mass=t,e.physicsBody.updateMassProperties()},e.prototype.getBodyMass=function(e){return e.physicsBody.mass},e.prototype.getBodyFriction=function(e){return e.physicsBody.material.friction},e.prototype.setBodyFriction=function(e,t){e.physicsBody.material.friction=t},e.prototype.getBodyRestitution=function(e){return e.physicsBody.material.restitution},e.prototype.setBodyRestitution=function(e,t){e.physicsBody.material.restitution=t},e.prototype.sleepBody=function(e){e.physicsBody.sleep()},e.prototype.wakeUpBody=function(e){e.physicsBody.wakeUp()},e.prototype.updateDistanceJoint=function(e,t){e.physicsJoint.distance=t},e.prototype.setMotor=function(e,t,i,r){r||(e.physicsJoint.enableMotor(),e.physicsJoint.setMotorSpeed(t),i&&this.setLimit(e,i))},e.prototype.setLimit=function(e,t,i){e.physicsJoint.motorEquation.maxForce=t,e.physicsJoint.motorEquation.minForce=void 0===i?-t:i},e.prototype.syncMeshWithImpostor=function(e,t){var i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.quaternion.x,e.rotationQuaternion.y=i.quaternion.y,e.rotationQuaternion.z=i.quaternion.z,e.rotationQuaternion.w=i.quaternion.w)},e.prototype.getRadius=function(e){return e.physicsBody.shapes[0].boundingSphereRadius},e.prototype.getBoxSizeToRef=function(e,t){var i=e.physicsBody.shapes[0];t.x=2*i.halfExtents.x,t.y=2*i.halfExtents.y,t.z=2*i.halfExtents.z},e.prototype.dispose=function(){},e.prototype._extendNamespace=function(){var e=new this.BJSCANNON.Vec3,t=this.BJSCANNON;this.BJSCANNON.World.prototype.step=function(i,r,n){if(n=n||10,0===(r=r||0))this.internalStep(i),this.time+=i;else{var o=Math.floor((this.time+r)/i)-Math.floor(this.time/i);o=Math.min(o,n)||1;for(var s=performance.now(),a=0;a!==o&&(this.internalStep(i),!(performance.now()-s>1e3*i));a++);this.time+=r;for(var c=this.time%i/i,h=e,l=this.bodies,u=0;u!==l.length;u++){var p=l[u];p.type!==t.Body.STATIC&&p.sleepState!==t.Body.SLEEPING?(p.position.vsub(p.previousPosition,h),h.scale(c,h),p.position.vadd(h,p.interpolatedPosition)):(p.interpolatedPosition.copy(p.position),p.interpolatedQuaternion.copy(p.quaternion))}}}},e}();c.a.DefaultPluginFactory=function(){return new h}},200:function(e,t,i){"use strict";i.d(t,"a",function(){return c});var r=i(37),n=i(45),o=i(93),s=i(0),a=i(9),c=function(){function e(e,t){void 0===t&&(t=OIMO),this.name="OimoJSPlugin",this._tmpImpostorsArray=[],this._tmpPositionVector=s.Vector3.Zero(),this.BJSOIMO=t,this.world=new this.BJSOIMO.World({iterations:e}),this.world.clear()}return e.prototype.setGravity=function(e){this.world.gravity.copy(e)},e.prototype.setTimeStep=function(e){this.world.timeStep=e},e.prototype.getTimeStep=function(){return this.world.timeStep},e.prototype.executeStep=function(e,t){var i=this;t.forEach(function(e){e.beforeStep()}),this.world.step(),t.forEach(function(e){e.afterStep(),i._tmpImpostorsArray[e.uniqueId]=e});for(var r=this.world.contacts;null!==r;)if(!r.touching||r.body1.sleeping||r.body2.sleeping){var n=this._tmpImpostorsArray[+r.body1.name],o=this._tmpImpostorsArray[+r.body2.name];n&&o?(n.onCollide({body:o.physicsBody}),o.onCollide({body:n.physicsBody}),r=r.next):r=r.next}else r=r.next},e.prototype.applyImpulse=function(e,t,i){var r=e.physicsBody.mass;e.physicsBody.applyImpulse(i.scale(this.world.invScale),t.scale(this.world.invScale*r))},e.prototype.applyForce=function(e,t,i){a.a.Warn("Oimo doesn't support applying force. Using impule instead."),this.applyImpulse(e,t,i)},e.prototype.generatePhysicsBody=function(e){var t=this;if(e.parent)e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());else{if(e.isBodyInitRequired()){var i={name:e.uniqueId,config:[e.getParam("mass")||1,e.getParam("friction"),e.getParam("restitution")],size:[],type:[],pos:[],posShape:[],rot:[],rotShape:[],move:0!==e.getParam("mass"),density:e.getParam("mass"),friction:e.getParam("friction"),restitution:e.getParam("restitution"),world:this.world},n=[e];(l=e.object).getChildMeshes&&l.getChildMeshes().forEach(function(e){e.physicsImpostor&&n.push(e.physicsImpostor)});var c=function(e){return Math.max(e,o.a.Epsilon)},h=new s.Quaternion;n.forEach(function(n){if(n.object.rotationQuaternion){var o=n.object.rotationQuaternion;h=o.clone();var s=o.toEulerAngles(),l=n.getObjectExtendSize();if(n===e){var u=e.getObjectCenter();e.object.getAbsolutePivotPoint().subtractToRef(u,t._tmpPositionVector),t._tmpPositionVector.divideInPlace(e.object.scaling),i.pos.push(u.x),i.pos.push(u.y),i.pos.push(u.z),i.posShape.push(0,0,0),i.rotShape.push(0,0,0)}else{var p=n.object.getAbsolutePosition().subtract(e.object.getAbsolutePosition());i.posShape.push(p.x),i.posShape.push(p.y),i.posShape.push(p.z),i.pos.push(0,0,0),i.rotShape.push(57.29577951308232*s.x),i.rotShape.push(57.29577951308232*s.y),i.rotShape.push(57.29577951308232*s.z)}switch(n.type){case r.a.ParticleImpostor:a.a.Warn("No Particle support in OIMO.js. using SphereImpostor instead");case r.a.SphereImpostor:var d=l.x,f=l.y,_=l.z,m=Math.max(c(d),c(f),c(_))/2;i.type.push("sphere"),i.size.push(m),i.size.push(m),i.size.push(m);break;case r.a.CylinderImpostor:var g=c(l.x)/2,y=c(l.y);i.type.push("cylinder"),i.size.push(g),i.size.push(y),i.size.push(y);break;case r.a.PlaneImpostor:case r.a.BoxImpostor:default:g=c(l.x),y=c(l.y);var P=c(l.z);i.type.push("box"),i.size.push(g),i.size.push(y),i.size.push(P)}n.object.rotationQuaternion=o}}),e.physicsBody=this.world.add(i),e.physicsBody.resetQuaternion(h),e.physicsBody.updatePosition(0)}else this._tmpPositionVector.copyFromFloats(0,0,0);var l;e.setDeltaPosition(this._tmpPositionVector)}},e.prototype.removePhysicsBody=function(e){this.world.removeRigidBody(e.physicsBody)},e.prototype.generateJoint=function(e){var t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(t&&i){var r,o=e.joint.jointData,s=o.nativeParams||{},c={body1:t,body2:i,axe1:s.axe1||(o.mainAxis?o.mainAxis.asArray():null),axe2:s.axe2||(o.connectedAxis?o.connectedAxis.asArray():null),pos1:s.pos1||(o.mainPivot?o.mainPivot.asArray():null),pos2:s.pos2||(o.connectedPivot?o.connectedPivot.asArray():null),min:s.min,max:s.max,collision:s.collision||o.collision,spring:s.spring,world:this.world};switch(e.joint.type){case n.e.BallAndSocketJoint:r="jointBall";break;case n.e.SpringJoint:a.a.Warn("OIMO.js doesn't support Spring Constraint. Simulating using DistanceJoint instead");var h=o;c.min=h.length||c.min,c.max=Math.max(c.min,c.max);case n.e.DistanceJoint:r="jointDistance",c.max=o.maxDistance;break;case n.e.PrismaticJoint:r="jointPrisme";break;case n.e.SliderJoint:r="jointSlide";break;case n.e.WheelJoint:r="jointWheel";break;case n.e.HingeJoint:default:r="jointHinge"}c.type=r,e.joint.physicsJoint=this.world.add(c)}},e.prototype.removeJoint=function(e){try{this.world.removeJoint(e.joint.physicsJoint)}catch(e){a.a.Warn(e)}},e.prototype.isSupported=function(){return void 0!==this.BJSOIMO},e.prototype.setTransformationFromPhysicsBody=function(e){e.physicsBody.sleeping||(e.object.position.copyFrom(e.physicsBody.getPosition()),e.object.rotationQuaternion&&e.object.rotationQuaternion.copyFrom(e.physicsBody.getQuaternion()))},e.prototype.setPhysicsBodyTransformation=function(e,t,i){var r=e.physicsBody;r.position.copy(t),r.orientation.copy(i),r.syncShapes(),r.awake()},e.prototype.setLinearVelocity=function(e,t){e.physicsBody.linearVelocity.copy(t)},e.prototype.setAngularVelocity=function(e,t){e.physicsBody.angularVelocity.copy(t)},e.prototype.getLinearVelocity=function(e){var t=e.physicsBody.linearVelocity;return t?new s.Vector3(t.x,t.y,t.z):null},e.prototype.getAngularVelocity=function(e){var t=e.physicsBody.angularVelocity;return t?new s.Vector3(t.x,t.y,t.z):null},e.prototype.setBodyMass=function(e,t){var i=0===t;e.physicsBody.shapes.density=i?1:t,e.physicsBody.setupMass(i?2:1)},e.prototype.getBodyMass=function(e){return e.physicsBody.shapes.density},e.prototype.getBodyFriction=function(e){return e.physicsBody.shapes.friction},e.prototype.setBodyFriction=function(e,t){e.physicsBody.shapes.friction=t},e.prototype.getBodyRestitution=function(e){return e.physicsBody.shapes.restitution},e.prototype.setBodyRestitution=function(e,t){e.physicsBody.shapes.restitution=t},e.prototype.sleepBody=function(e){e.physicsBody.sleep()},e.prototype.wakeUpBody=function(e){e.physicsBody.awake()},e.prototype.updateDistanceJoint=function(e,t,i){e.physicsJoint.limitMotor.upperLimit=t,void 0!==i&&(e.physicsJoint.limitMotor.lowerLimit=i)},e.prototype.setMotor=function(e,t,i,r){var n=r?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;n&&n.setMotor(t,i)},e.prototype.setLimit=function(e,t,i,r){var n=r?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;n&&n.setLimit(t,void 0===i?-t:i)},e.prototype.syncMeshWithImpostor=function(e,t){var i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.orientation.x,e.rotationQuaternion.y=i.orientation.y,e.rotationQuaternion.z=i.orientation.z,e.rotationQuaternion.w=i.orientation.s)},e.prototype.getRadius=function(e){return e.physicsBody.shapes.radius},e.prototype.getBoxSizeToRef=function(e,t){var i=e.physicsBody.shapes;t.x=2*i.halfWidth,t.y=2*i.halfHeight,t.z=2*i.halfDepth},e.prototype.dispose=function(){this.world.clear()},e}()},244:function(e,t,i){"use strict";var r,n=i(164),o=i(1),s=i(18),a=(i(293),function(e){function t(t,i,r,n,o,s){var a=e.call(this,t,"blackAndWhite",["degree"],null,i,r,n,o,s)||this;return a.degree=1,a.onApplyObservable.add(function(e){e.setFloat("degree",a.degree)}),a}return o.d(t,e),t}(s.a)),c=i(5),h=function(){function e(e,t,i,r){this._name=t,this._singleInstance=r||!0,this._getPostProcesses=i,this._cameras={},this._indicesForCamera={},this._postProcesses={}}return Object.defineProperty(e.prototype,"isSupported",{get:function(){for(var e in this._postProcesses)if(this._postProcesses.hasOwnProperty(e))for(var t=this._postProcesses[e],i=0;i<t.length;i++)if(!t[i].isSupported)return!1;return!0},enumerable:!0,configurable:!0}),e.prototype._update=function(){},e.prototype._attachCameras=function(e){var t,i=this,r=c.h.MakeArray(e||this._cameras);if(r)for(var n=0;n<r.length;n++){var o=r[n],s=o.name;if(t=this._singleInstance?0:s,!this._postProcesses[t]){var a=this._getPostProcesses();a&&(this._postProcesses[t]=Array.isArray(a)?a:[a])}this._indicesForCamera[s]||(this._indicesForCamera[s]=[]),this._postProcesses[t].forEach(function(e){var t=o.attachPostProcess(e);i._indicesForCamera[s].push(t)}),this._cameras[s]||(this._cameras[s]=o)}},e.prototype._detachCameras=function(e){var t=c.h.MakeArray(e||this._cameras);if(t)for(var i=0;i<t.length;i++){var r=t[i],n=r.name,o=this._postProcesses[this._singleInstance?0:n];o&&o.forEach(function(e){r.detachPostProcess(e)}),this._cameras[n]&&(this._cameras[n]=null)}},e.prototype._enable=function(e){var t=this,i=c.h.MakeArray(e||this._cameras);if(i)for(var r=0;r<i.length;r++)for(var n=i[r],o=n.name,s=0;s<this._indicesForCamera[o].length;s++)void 0!==n._postProcesses[this._indicesForCamera[o][s]]&&null!==n._postProcesses[this._indicesForCamera[o][s]]||this._postProcesses[this._singleInstance?0:o].forEach(function(e){i[r].attachPostProcess(e,t._indicesForCamera[o][s])})},e.prototype._disable=function(e){var t=c.h.MakeArray(e||this._cameras);if(t)for(var i=0;i<t.length;i++){var r=t[i],n=r.name;this._postProcesses[this._singleInstance?0:n].forEach(function(e){r.detachPostProcess(e)})}},e.prototype.getPostProcesses=function(e){return this._singleInstance?this._postProcesses[0]:e?this._postProcesses[e.name]:null},e}(),l=i(0),u=i(4),p=(i(294),function(e){function t(t,i,r,n,o,s,a,c){void 0===a&&(a=u.a.TEXTURETYPE_UNSIGNED_INT),void 0===c&&(c=!1);var h=e.call(this,t,"extractHighlights",["threshold","exposure"],null,i,r,n,o,s,null,a,void 0,null,c)||this;return h.threshold=.9,h._exposure=1,h._inputPostProcess=null,h.onApplyObservable.add(function(e){h._inputPostProcess&&e.setTextureFromPostProcess("textureSampler",h._inputPostProcess),e.setFloat("threshold",Math.pow(h.threshold,l.ToGammaSpace)),e.setFloat("exposure",h._exposure)}),h}return o.d(t,e),t}(s.a)),d=i(50),f=(i(295),function(e){function t(t,i,r,n,o,s,a,c,h,l,p){void 0===l&&(l=u.a.TEXTURETYPE_UNSIGNED_INT),void 0===p&&(p=!1);var d=e.call(this,t,"bloomMerge",["bloomWeight"],["circleOfConfusionSampler","blurStep0","blurStep1","blurStep2","bloomBlur"],o,s,a,c,h,null,l,void 0,null,!0)||this;return d.weight=n,d.onApplyObservable.add(function(e){e.setTextureFromPostProcess("textureSampler",i),e.setTextureFromPostProcessOutput("bloomBlur",r),e.setFloat("bloomWeight",d.weight)}),p||d.updateEffect(),d}return o.d(t,e),t}(s.a)),_=i(6),m=function(e){function t(t,i,r,n,o,s){void 0===o&&(o=0),void 0===s&&(s=!1);var a=e.call(this,t.getEngine(),"bloom",function(){return a._effects},!0)||this;return a.bloomScale=i,a._effects=[],a._downscale=new p("highlights",1,null,_.a.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,o,s),a._blurX=new d.a("horizontal blur",new l.Vector2(1,0),10,i,null,_.a.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,o,void 0,s),a._blurX.alwaysForcePOT=!0,a._blurX.autoClear=!1,a._blurY=new d.a("vertical blur",new l.Vector2(0,1),10,i,null,_.a.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,o,void 0,s),a._blurY.alwaysForcePOT=!0,a._blurY.autoClear=!1,a.kernel=n,a._effects=[a._downscale,a._blurX,a._blurY],a._merge=new f("bloomMerge",a._downscale,a._blurY,r,i,null,_.a.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,o,s),a._merge.autoClear=!1,a._effects.push(a._merge),a}return o.d(t,e),Object.defineProperty(t.prototype,"threshold",{get:function(){return this._downscale.threshold},set:function(e){this._downscale.threshold=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"weight",{get:function(){return this._merge.weight},set:function(e){this._merge.weight=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"kernel",{get:function(){return this._blurX.kernel/this.bloomScale},set:function(e){this._blurX.kernel=e*this.bloomScale,this._blurY.kernel=e*this.bloomScale},enumerable:!0,configurable:!0}),t.prototype.disposeEffects=function(e){for(var t=0;t<this._effects.length;t++)this._effects[t].dispose(e)},t.prototype._updateEffects=function(){for(var e=0;e<this._effects.length;e++)this._effects[e].updateEffect()},t.prototype._isReady=function(){for(var e=0;e<this._effects.length;e++)if(!this._effects[e].isReady())return!1;return!0},t}(h),g=(i(236),function(e){function t(t,i,r,n,o,s,a,c,h,p){void 0===h&&(h=u.a.TEXTURETYPE_UNSIGNED_INT),void 0===p&&(p=!1);var d=e.call(this,t,"chromaticAberration",["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"],[],n,o,s,a,c,null,h,void 0,null,p)||this;return d.aberrationAmount=30,d.radialIntensity=0,d.direction=new l.Vector2(.707,.707),d.centerPosition=new l.Vector2(.5,.5),d.onApplyObservable.add(function(e){e.setFloat("chromatic_aberration",d.aberrationAmount),e.setFloat("screen_width",i),e.setFloat("screen_height",r),e.setFloat("radialIntensity",d.radialIntensity),e.setFloat2("direction",d.direction.x,d.direction.y),e.setFloat2("centerPosition",d.centerPosition.x,d.centerPosition.y)}),d}return o.d(t,e),t}(s.a)),y=i(9),P=(i(296),function(e){function t(t,i,r,n,o,s,a,c,h){void 0===c&&(c=u.a.TEXTURETYPE_UNSIGNED_INT),void 0===h&&(h=!1);var l=e.call(this,t,"circleOfConfusion",["cameraMinMaxZ","focusDistance","cocPrecalculation"],["depthSampler"],r,n,o,s,a,null,c,void 0,null,h)||this;return l.lensSize=50,l.fStop=1.4,l.focusDistance=2e3,l.focalLength=50,l._depthTexture=null,l._depthTexture=i,l.onApplyObservable.add(function(e){if(l._depthTexture){e.setTexture("depthSampler",l._depthTexture);var t=l.lensSize/l.fStop*l.focalLength/(l.focusDistance-l.focalLength);e.setFloat("focusDistance",l.focusDistance),e.setFloat("cocPrecalculation",t),e.setFloat2("cameraMinMaxZ",l._depthTexture.activeCamera.minZ,l._depthTexture.activeCamera.maxZ)}else y.a.Warn("No depth texture set on CircleOfConfusionPostProcess")}),l}return o.d(t,e),Object.defineProperty(t.prototype,"depthTexture",{set:function(e){this._depthTexture=e},enumerable:!0,configurable:!0}),t}(s.a)),b=(i(297),function(e){function t(t,i,r,n,o,s,a){var c=e.call(this,t,"colorCorrection",null,["colorTable"],r,n,o,s,a)||this;return c._colorTableTexture=new _.a(i,n.getScene(),!0,!1,_.a.TRILINEAR_SAMPLINGMODE),c._colorTableTexture.anisotropicFilteringLevel=1,c._colorTableTexture.wrapU=_.a.CLAMP_ADDRESSMODE,c._colorTableTexture.wrapV=_.a.CLAMP_ADDRESSMODE,c.onApply=function(e){e.setTexture("colorTable",c._colorTableTexture)},c}return o.d(t,e),t}(s.a)),v=(i(298),function(e){function t(t,i,r,n,o,s,a,c){void 0===c&&(c=u.a.TEXTURETYPE_UNSIGNED_INT);var h=e.call(this,t,"convolution",["kernel","screenSize"],null,r,n,o,s,a,null,c)||this;return h.kernel=i,h.onApply=function(e){e.setFloat2("screenSize",h.width,h.height),e.setArray("kernel",h.kernel)},h}return o.d(t,e),t.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1],t.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0],t.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1],t.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0],t.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2],t.GaussianKernel=[0,1,0,1,1,1,0,1,0],t}(s.a)),S=function(e){function t(t,i,r,n,o,s,a,c,h,l,p,d,f){void 0===c&&(c=null),void 0===h&&(h=_.a.BILINEAR_SAMPLINGMODE),void 0===d&&(d=u.a.TEXTURETYPE_UNSIGNED_INT),void 0===f&&(f=!1);var m=e.call(this,t,r,n,o,s,h=u.a.TEXTURE_BILINEAR_SAMPLINGMODE,l,p,d=u.a.TEXTURETYPE_UNSIGNED_INT,"#define DOF 1\r\n",f)||this;return m.direction=r,m.onApplyObservable.add(function(e){null!=c&&e.setTextureFromPostProcess("textureSampler",c),e.setTextureFromPostProcessOutput("circleOfConfusionSampler",a),i.activeCamera&&e.setFloat2("cameraMinMaxZ",i.activeCamera.minZ,i.activeCamera.maxZ)}),m}return o.d(t,e),t}(d.a),E=(i(299),function(){return function(){}}()),x=function(e){function t(t,i,r,n,o,s,a,c,h,l,p){void 0===l&&(l=u.a.TEXTURETYPE_UNSIGNED_INT),void 0===p&&(p=!1);var d=e.call(this,t,"depthOfFieldMerge",[],["circleOfConfusionSampler","blurStep0","blurStep1","blurStep2"],o,s,a,c,h,null,l,void 0,null,!0)||this;return d.blurSteps=n,d.onApplyObservable.add(function(e){e.setTextureFromPostProcess("textureSampler",i),e.setTextureFromPostProcessOutput("circleOfConfusionSampler",r),n.forEach(function(t,i){e.setTextureFromPostProcessOutput("blurStep"+(n.length-i-1),t)})}),p||d.updateEffect(),d}return o.d(t,e),t.prototype.updateEffect=function(t,i,r,n,o,s){void 0===t&&(t=null),void 0===i&&(i=null),void 0===r&&(r=null),t||(t="",t+="#define BLUR_LEVEL "+(this.blurSteps.length-1)+"\n"),e.prototype.updateEffect.call(this,t,i,r,n,o,s)},t}(s.a);!function(e){e[e.Low=0]="Low",e[e.Medium=1]="Medium",e[e.High=2]="High"}(r||(r={}));var T=function(e){function t(t,i,n,o,s){void 0===n&&(n=r.Low),void 0===o&&(o=0),void 0===s&&(s=!1);var a=e.call(this,t.getEngine(),"depth of field",function(){return a._effects},!0)||this;a._effects=[],a._circleOfConfusion=new P("circleOfConfusion",i,1,null,_.a.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,o,s),a._depthOfFieldBlurY=[],a._depthOfFieldBlurX=[];var c=1,h=15;switch(n){case r.High:c=3,h=51;break;case r.Medium:c=2,h=31;break;default:h=15,c=1}for(var u=h/Math.pow(2,c-1),p=1,d=0;d<c;d++){var f=new S("verticle blur",t,new l.Vector2(0,1),u,p,null,a._circleOfConfusion,0==d?a._circleOfConfusion:null,_.a.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,o,s);f.autoClear=!1,p=.75/Math.pow(2,d);var m=new S("horizontal blur",t,new l.Vector2(1,0),u,p,null,a._circleOfConfusion,null,_.a.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,o,s);m.autoClear=!1,a._depthOfFieldBlurY.push(f),a._depthOfFieldBlurX.push(m)}a._effects=[a._circleOfConfusion];for(d=0;d<a._depthOfFieldBlurX.length;d++)a._effects.push(a._depthOfFieldBlurY[d]),a._effects.push(a._depthOfFieldBlurX[d]);return a._dofMerge=new x("dofMerge",a._circleOfConfusion,a._circleOfConfusion,a._depthOfFieldBlurX,p,null,_.a.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,o,s),a._dofMerge.autoClear=!1,a._effects.push(a._dofMerge),a}return o.d(t,e),Object.defineProperty(t.prototype,"focalLength",{get:function(){return this._circleOfConfusion.focalLength},set:function(e){this._circleOfConfusion.focalLength=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fStop",{get:function(){return this._circleOfConfusion.fStop},set:function(e){this._circleOfConfusion.fStop=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"focusDistance",{get:function(){return this._circleOfConfusion.focusDistance},set:function(e){this._circleOfConfusion.focusDistance=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lensSize",{get:function(){return this._circleOfConfusion.lensSize},set:function(e){this._circleOfConfusion.lensSize=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"depthTexture",{set:function(e){this._circleOfConfusion.depthTexture=e},enumerable:!0,configurable:!0}),t.prototype.disposeEffects=function(e){for(var t=0;t<this._effects.length;t++)this._effects[t].dispose(e)},t.prototype._updateEffects=function(){for(var e=0;e<this._effects.length;e++)this._effects[e].updateEffect()},t.prototype._isReady=function(){for(var e=0;e<this._effects.length;e++)if(!this._effects[e].isReady())return!1;return!0},t}(h),A=(i(300),function(e){function t(t,i,r,n,o,s){return e.call(this,t,"displayPass",["passSampler"],["passSampler"],i,r,n,o,s)||this}return o.d(t,e),t}(s.a)),R=(i(301),function(e){function t(t,i,r,n,o,s,a){var c=e.call(this,t,"filter",["kernelMatrix"],null,r,n,o,s,a)||this;return c.kernelMatrix=i,c.onApply=function(e){e.setMatrix("kernelMatrix",c.kernelMatrix)},c}return o.d(t,e),t}(s.a)),C=i(110),O=(i(304),function(e){function t(t,i,r,n,o,s,a,c){void 0===a&&(a=u.a.TEXTURETYPE_UNSIGNED_INT),void 0===c&&(c=!1);var h=e.call(this,t,"grain",["intensity","animatedSeed"],[],i,r,n,o,s,null,a,void 0,null,c)||this;return h.intensity=30,h.animated=!1,h.onApplyObservable.add(function(e){e.setFloat("intensity",h.intensity),e.setFloat("animatedSeed",h.animated?Math.random()+1:1)}),h}return o.d(t,e),t}(s.a)),B=(i(305),function(e){function t(t,i,r,n,o,s,a){return void 0===a&&(a=u.a.TEXTURETYPE_UNSIGNED_INT),e.call(this,t,"highlights",null,null,i,r,n,o,s,null,a)||this}return o.d(t,e),t}(s.a)),I=i(133),D=i(120),F=(i(306),function(e){function t(t,i,r,n,o,s,a,c,h){void 0===c&&(c=u.a.TEXTURETYPE_UNSIGNED_INT),void 0===h&&(h=!1);var p=e.call(this,t,"motionBlur",["motionStrength","motionScale","screenSize"],["velocitySampler"],r,n,o,s,a,"#define GEOMETRY_SUPPORTED\n#define SAMPLES 64.0",c,void 0,null,h)||this;return p.motionStrength=1,p._motionBlurSamples=32,p._geometryBufferRenderer=i.enableGeometryBufferRenderer(),p._geometryBufferRenderer?(p._geometryBufferRenderer.enableVelocity=!0,p.onApply=function(e){if(e.setVector2("screenSize",new l.Vector2(p.width,p.height)),e.setFloat("motionScale",i.getAnimationRatio()),e.setFloat("motionStrength",p.motionStrength),p._geometryBufferRenderer){var t=p._geometryBufferRenderer.getTextureIndex(D.a.VELOCITY_TEXTURE_TYPE);e.setTexture("velocitySampler",p._geometryBufferRenderer.getGBuffer().textures[t])}}):(y.a.Warn("Multiple Render Target support needed to compute object based motion blur"),p.updateEffect()),p}return o.d(t,e),Object.defineProperty(t.prototype,"motionBlurSamples",{get:function(){return this._motionBlurSamples},set:function(e){this._motionBlurSamples=e,this._geometryBufferRenderer&&this.updateEffect("#define GEOMETRY_SUPPORTED\n#define SAMPLES "+e.toFixed(1))},enumerable:!0,configurable:!0}),t.prototype.dispose=function(t){this._geometryBufferRenderer&&(this._geometryBufferRenderer._previousTransformationMatrices={}),e.prototype.dispose.call(this,t)},t}(s.a)),G=i(69),M=i(115),w=(i(307),function(e){function t(t,i,r,n,o,s,a,c,h,l){var u=e.call(this,t,"refraction",["baseColor","depth","colorLevel"],["refractionSampler"],s,a,c,h,l)||this;return u.color=r,u.depth=n,u.colorLevel=o,u._ownRefractionTexture=!0,u.onActivateObservable.add(function(e){u._refTexture=u._refTexture||new _.a(i,e.getScene())}),u.onApplyObservable.add(function(e){e.setColor3("baseColor",u.color),e.setFloat("depth",u.depth),e.setFloat("colorLevel",u.colorLevel),e.setTexture("refractionSampler",u._refTexture)}),u}return o.d(t,e),Object.defineProperty(t.prototype,"refractionTexture",{get:function(){return this._refTexture},set:function(e){this._refTexture&&this._ownRefractionTexture&&this._refTexture.dispose(),this._refTexture=e,this._ownRefractionTexture=!1},enumerable:!0,configurable:!0}),t.prototype.dispose=function(t){this._refTexture&&this._ownRefractionTexture&&(this._refTexture.dispose(),this._refTexture=null),e.prototype.dispose.call(this,t)},t}(s.a)),L=i(2),V=i(194),N=(i(308),function(e){function t(t,i,r,n,o,s,a,c){void 0===a&&(a=u.a.TEXTURETYPE_UNSIGNED_INT),void 0===c&&(c=!1);var h=e.call(this,t,"sharpen",["sharpnessAmounts","screenSize"],null,i,r,n,o,s,null,a,void 0,null,c)||this;return h.colorAmount=1,h.edgeAmount=.3,h.onApply=function(e){e.setFloat2("screenSize",h.width,h.height),e.setFloat2("sharpnessAmounts",h.edgeAmount,h.colorAmount)},h}return o.d(t,e),t}(s.a)),z=function(){function e(e,t){this.engine=e,this._name=t,this._renderEffects={},this._renderEffectsForIsolatedPass=new Array,this._cameras=[]}return e.prototype.getClassName=function(){return"PostProcessRenderPipeline"},Object.defineProperty(e.prototype,"isSupported",{get:function(){for(var e in this._renderEffects)if(this._renderEffects.hasOwnProperty(e)&&!this._renderEffects[e].isSupported)return!1;return!0},enumerable:!0,configurable:!0}),e.prototype.addEffect=function(e){this._renderEffects[e._name]=e},e.prototype._rebuild=function(){},e.prototype._enableEffect=function(e,t){var i=this._renderEffects[e];i&&i._enable(c.h.MakeArray(t||this._cameras))},e.prototype._disableEffect=function(e,t){var i=this._renderEffects[e];i&&i._disable(c.h.MakeArray(t||this._cameras))},e.prototype._attachCameras=function(e,t){var i=c.h.MakeArray(e||this._cameras);if(i){var r,n=[];for(r=0;r<i.length;r++){var o=i[r],s=o.name;-1===this._cameras.indexOf(o)?this._cameras[s]=o:t&&n.push(r)}for(r=0;r<n.length;r++)e.splice(n[r],1);for(var a in this._renderEffects)this._renderEffects.hasOwnProperty(a)&&this._renderEffects[a]._attachCameras(i)}},e.prototype._detachCameras=function(e){var t=c.h.MakeArray(e||this._cameras);if(t){for(var i in this._renderEffects)this._renderEffects.hasOwnProperty(i)&&this._renderEffects[i]._detachCameras(t);for(var r=0;r<t.length;r++)this._cameras.splice(this._cameras.indexOf(t[r]),1)}},e.prototype._update=function(){for(var e in this._renderEffects)this._renderEffects.hasOwnProperty(e)&&this._renderEffects[e]._update();for(var t=0;t<this._cameras.length;t++){var i=this._cameras[t].name;this._renderEffectsForIsolatedPass[i]&&this._renderEffectsForIsolatedPass[i]._update()}},e.prototype._reset=function(){this._renderEffects={},this._renderEffectsForIsolatedPass=new Array},e.prototype._enableMSAAOnFirstPostProcess=function(e){var t=Object.keys(this._renderEffects);if(this.engine.webGLVersion>=2&&t.length>0){var i=this._renderEffects[t[0]].getPostProcesses();if(i)return i[0].samples=e,!0}return!1},e.prototype.dispose=function(){},o.c([Object(L.c)()],e.prototype,"_name",void 0),e}(),j=i(26),k=i(21),U=function(e){function t(t,i,n,o,s){void 0===t&&(t=""),void 0===i&&(i=!0),void 0===n&&(n=k.a.LastCreatedScene),void 0===s&&(s=!0);var a=e.call(this,n.getEngine(),t)||this;a._camerasToBeAttached=[],a.SharpenPostProcessId="SharpenPostProcessEffect",a.ImageProcessingPostProcessId="ImageProcessingPostProcessEffect",a.FxaaPostProcessId="FxaaPostProcessEffect",a.ChromaticAberrationPostProcessId="ChromaticAberrationPostProcessEffect",a.GrainPostProcessId="GrainPostProcessEffect",a._glowLayer=null,a.animations=[],a._imageProcessingConfigurationObserver=null,a._sharpenEnabled=!1,a._bloomEnabled=!1,a._depthOfFieldEnabled=!1,a._depthOfFieldBlurLevel=r.Low,a._fxaaEnabled=!1,a._imageProcessingEnabled=!0,a._bloomScale=.5,a._chromaticAberrationEnabled=!1,a._grainEnabled=!1,a._buildAllowed=!0,a._resizeObserver=null,a._hardwareScaleLevel=1,a._bloomKernel=64,a._bloomWeight=.15,a._bloomThreshold=.9,a._samples=1,a._hasCleared=!1,a._prevPostProcess=null,a._prevPrevPostProcess=null,a._depthOfFieldSceneObserver=null,a._cameras=o||n.cameras,a._cameras=a._cameras.slice(),a._camerasToBeAttached=a._cameras.slice(),a._buildAllowed=s,a._scene=n;var c=a._scene.getEngine().getCaps();a._hdr=i&&(c.textureHalfFloatRender||c.textureFloatRender),a._hdr?c.textureHalfFloatRender?a._defaultPipelineTextureType=u.a.TEXTURETYPE_HALF_FLOAT:c.textureFloatRender&&(a._defaultPipelineTextureType=u.a.TEXTURETYPE_FLOAT):a._defaultPipelineTextureType=u.a.TEXTURETYPE_UNSIGNED_INT,n.postProcessRenderPipelineManager.addPipeline(a);var l=a._scene.getEngine();return a.sharpen=new N("sharpen",1,null,_.a.BILINEAR_SAMPLINGMODE,l,!1,a._defaultPipelineTextureType,!0),a._sharpenEffect=new h(l,a.SharpenPostProcessId,function(){return a.sharpen},!0),a.depthOfField=new T(a._scene,null,a._depthOfFieldBlurLevel,a._defaultPipelineTextureType,!0),a.bloom=new m(a._scene,a._bloomScale,a._bloomWeight,a.bloomKernel,a._defaultPipelineTextureType,!0),a.chromaticAberration=new g("ChromaticAberration",l.getRenderWidth(),l.getRenderHeight(),1,null,_.a.BILINEAR_SAMPLINGMODE,l,!1,a._defaultPipelineTextureType,!0),a._chromaticAberrationEffect=new h(l,a.ChromaticAberrationPostProcessId,function(){return a.chromaticAberration},!0),a.grain=new O("Grain",1,null,_.a.BILINEAR_SAMPLINGMODE,l,!1,a._defaultPipelineTextureType,!0),a._grainEffect=new h(l,a.GrainPostProcessId,function(){return a.grain},!0),a._resizeObserver=l.onResizeObservable.add(function(){a._hardwareScaleLevel=l.getHardwareScalingLevel(),a.bloomKernel=a.bloomKernel}),a._imageProcessingConfigurationObserver=a._scene.imageProcessingConfiguration.onUpdateParameters.add(function(){a.bloom._downscale._exposure=a._scene.imageProcessingConfiguration.exposure}),a._buildPipeline(),a}return o.d(t,e),Object.defineProperty(t.prototype,"sharpenEnabled",{get:function(){return this._sharpenEnabled},set:function(e){this._sharpenEnabled!==e&&(this._sharpenEnabled=e,this._buildPipeline())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bloomKernel",{get:function(){return this._bloomKernel},set:function(e){this._bloomKernel=e,this.bloom.kernel=e/this._hardwareScaleLevel},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bloomWeight",{get:function(){return this._bloomWeight},set:function(e){this._bloomWeight!==e&&(this.bloom.weight=e,this._bloomWeight=e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bloomThreshold",{get:function(){return this._bloomThreshold},set:function(e){this._bloomThreshold!==e&&(this.bloom.threshold=e,this._bloomThreshold=e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bloomScale",{get:function(){return this._bloomScale},set:function(e){this._bloomScale!==e&&(this._bloomScale=e,this._rebuildBloom(),this._buildPipeline())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bloomEnabled",{get:function(){return this._bloomEnabled},set:function(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())},enumerable:!0,configurable:!0}),t.prototype._rebuildBloom=function(){var e=this.bloom;this.bloom=new m(this._scene,this.bloomScale,this._bloomWeight,this.bloomKernel,this._defaultPipelineTextureType,!1),this.bloom.threshold=e.threshold;for(var t=0;t<this._cameras.length;t++)e.disposeEffects(this._cameras[t])},Object.defineProperty(t.prototype,"depthOfFieldEnabled",{get:function(){return this._depthOfFieldEnabled},set:function(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"depthOfFieldBlurLevel",{get:function(){return this._depthOfFieldBlurLevel},set:function(e){if(this._depthOfFieldBlurLevel!==e){this._depthOfFieldBlurLevel=e;var t=this.depthOfField;this.depthOfField=new T(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!1),this.depthOfField.focalLength=t.focalLength,this.depthOfField.focusDistance=t.focusDistance,this.depthOfField.fStop=t.fStop,this.depthOfField.lensSize=t.lensSize;for(var i=0;i<this._cameras.length;i++)t.disposeEffects(this._cameras[i]);this._buildPipeline()}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fxaaEnabled",{get:function(){return this._fxaaEnabled},set:function(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"samples",{get:function(){return this._samples},set:function(e){this._samples!==e&&(this._samples=e,this._buildPipeline())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"imageProcessingEnabled",{get:function(){return this._imageProcessingEnabled},set:function(e){this._imageProcessingEnabled!==e&&(this._imageProcessingEnabled=e,this._buildPipeline())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"glowLayerEnabled",{get:function(){return null==this._glowLayer},set:function(e){e&&!this._glowLayer?this._glowLayer=new V.a("",this._scene):!e&&this._glowLayer&&(this._glowLayer.dispose(),this._glowLayer=null)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"chromaticAberrationEnabled",{get:function(){return this._chromaticAberrationEnabled},set:function(e){this._chromaticAberrationEnabled!==e&&(this._chromaticAberrationEnabled=e,this._buildPipeline())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"grainEnabled",{get:function(){return this._grainEnabled},set:function(e){this._grainEnabled!==e&&(this._grainEnabled=e,this._buildPipeline())},enumerable:!0,configurable:!0}),t.prototype.prepare=function(){var e=this._buildAllowed;this._buildAllowed=!0,this._buildPipeline(),this._buildAllowed=e},t.prototype._setAutoClearAndTextureSharing=function(e,t){void 0===t&&(t=!1),this._hasCleared?e.autoClear=!1:(e.autoClear=!0,this._scene.autoClear=!1,this._hasCleared=!0),t||(this._prevPrevPostProcess?e.shareOutputWith(this._prevPrevPostProcess):e.useOwnOutput(),this._prevPostProcess&&(this._prevPrevPostProcess=this._prevPostProcess),this._prevPostProcess=e)},t.prototype._buildPipeline=function(){var e=this;if(this._buildAllowed){this._scene.autoClear=!0;var t=this._scene.getEngine();if(this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._prevPostProcess=null,this._prevPrevPostProcess=null,this._hasCleared=!1,this.depthOfFieldEnabled){if(this._cameras.length>1){for(var i=0,r=this._cameras;i<r.length;i++){var n=r[i];(o=this._scene.enableDepthRenderer(n)).useOnlyInActiveCamera=!0}this._depthOfFieldSceneObserver=this._scene.onAfterRenderTargetsRenderObservable.add(function(t){e._cameras.indexOf(t.activeCamera)>-1&&(e.depthOfField.depthTexture=t.enableDepthRenderer(t.activeCamera).getDepthMap())})}else{this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);var o=this._scene.enableDepthRenderer(this._cameras[0]);this.depthOfField.depthTexture=o.getDepthMap()}this.depthOfField._isReady()||this.depthOfField._updateEffects(),this.addEffect(this.depthOfField),this._setAutoClearAndTextureSharing(this.depthOfField._effects[0],!0)}else this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);this.bloomEnabled&&(this.bloom._isReady()||this.bloom._updateEffects(),this.addEffect(this.bloom),this._setAutoClearAndTextureSharing(this.bloom._effects[0],!0)),this._imageProcessingEnabled&&(this.imageProcessing=new I.a("imageProcessing",1,null,_.a.BILINEAR_SAMPLINGMODE,t,!1,this._defaultPipelineTextureType),this._hdr?(this.addEffect(new h(t,this.ImageProcessingPostProcessId,function(){return e.imageProcessing},!0)),this._setAutoClearAndTextureSharing(this.imageProcessing)):this._scene.imageProcessingConfiguration.applyByPostProcess=!1),this.sharpenEnabled&&(this.sharpen.isReady()||this.sharpen.updateEffect(),this.addEffect(this._sharpenEffect),this._setAutoClearAndTextureSharing(this.sharpen)),this.grainEnabled&&(this.grain.isReady()||this.grain.updateEffect(),this.addEffect(this._grainEffect),this._setAutoClearAndTextureSharing(this.grain)),this.chromaticAberrationEnabled&&(this.chromaticAberration.isReady()||this.chromaticAberration.updateEffect(),this.addEffect(this._chromaticAberrationEffect),this._setAutoClearAndTextureSharing(this.chromaticAberration)),this.fxaaEnabled&&(this.fxaa=new C.a("fxaa",1,null,_.a.BILINEAR_SAMPLINGMODE,t,!1,this._defaultPipelineTextureType),this.addEffect(new h(t,this.FxaaPostProcessId,function(){return e.fxaa},!0)),this._setAutoClearAndTextureSharing(this.fxaa,!0)),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),!this._enableMSAAOnFirstPostProcess(this.samples)&&this.samples>1&&y.a.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0")}},t.prototype._disposePostProcesses=function(e){void 0===e&&(e=!1);for(var t=0;t<this._cameras.length;t++){var i=this._cameras[t];this.imageProcessing&&this.imageProcessing.dispose(i),this.fxaa&&this.fxaa.dispose(i),e&&(this.sharpen&&this.sharpen.dispose(i),this.depthOfField&&(this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver),this.depthOfField.disposeEffects(i)),this.bloom&&this.bloom.disposeEffects(i),this.chromaticAberration&&this.chromaticAberration.dispose(i),this.grain&&this.grain.dispose(i),this._glowLayer&&this._glowLayer.dispose())}this.imageProcessing=null,this.fxaa=null,e&&(this.sharpen=null,this._sharpenEffect=null,this.depthOfField=null,this.bloom=null,this.chromaticAberration=null,this._chromaticAberrationEffect=null,this.grain=null,this._grainEffect=null,this._glowLayer=null)},t.prototype.addCamera=function(e){this._camerasToBeAttached.push(e),this._buildPipeline()},t.prototype.removeCamera=function(e){var t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()},t.prototype.dispose=function(){this._disposePostProcesses(!0),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._scene.autoClear=!0,this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this._scene.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigurationObserver),e.prototype.dispose.call(this)},t.prototype.serialize=function(){var e=L.a.Serialize(this);return e.customType="DefaultRenderingPipeline",e},t.Parse=function(e,i,r){return L.a.Parse(function(){return new t(e._name,e._name._hdr,i)},e,i,r)},o.c([Object(L.c)()],t.prototype,"sharpenEnabled",null),o.c([Object(L.c)()],t.prototype,"bloomKernel",null),o.c([Object(L.c)()],t.prototype,"_bloomWeight",void 0),o.c([Object(L.c)()],t.prototype,"_bloomThreshold",void 0),o.c([Object(L.c)()],t.prototype,"_hdr",void 0),o.c([Object(L.c)()],t.prototype,"bloomWeight",null),o.c([Object(L.c)()],t.prototype,"bloomThreshold",null),o.c([Object(L.c)()],t.prototype,"bloomScale",null),o.c([Object(L.c)()],t.prototype,"bloomEnabled",null),o.c([Object(L.c)()],t.prototype,"depthOfFieldEnabled",null),o.c([Object(L.c)()],t.prototype,"depthOfFieldBlurLevel",null),o.c([Object(L.c)()],t.prototype,"fxaaEnabled",null),o.c([Object(L.c)()],t.prototype,"samples",null),o.c([Object(L.c)()],t.prototype,"imageProcessingEnabled",null),o.c([Object(L.c)()],t.prototype,"glowLayerEnabled",null),o.c([Object(L.c)()],t.prototype,"chromaticAberrationEnabled",null),o.c([Object(L.c)()],t.prototype,"grainEnabled",null),t}(z);j.a.RegisteredTypes["BABYLON.DefaultRenderingPipeline"]=U;var W=i(77),H=(i(309),i(310),function(e){function t(t,i,r,n,o){void 0===n&&(n=1);var s=e.call(this,r.getEngine(),t)||this;return s.LensChromaticAberrationEffect="LensChromaticAberrationEffect",s.HighlightsEnhancingEffect="HighlightsEnhancingEffect",s.LensDepthOfFieldEffect="LensDepthOfFieldEffect",s._scene=r,s._depthTexture=r.enableDepthRenderer().getDepthMap(),i.grain_texture?s._grainTexture=i.grain_texture:s._createGrainTexture(),s._edgeBlur=i.edge_blur?i.edge_blur:0,s._grainAmount=i.grain_amount?i.grain_amount:0,s._chromaticAberration=i.chromatic_aberration?i.chromatic_aberration:0,s._distortion=i.distortion?i.distortion:0,s._highlightsGain=void 0!==i.dof_gain?i.dof_gain:-1,s._highlightsThreshold=i.dof_threshold?i.dof_threshold:1,s._dofDistance=void 0!==i.dof_focus_distance?i.dof_focus_distance:-1,s._dofAperture=i.dof_aperture?i.dof_aperture:1,s._dofDarken=i.dof_darken?i.dof_darken:0,s._dofPentagon=void 0===i.dof_pentagon||i.dof_pentagon,s._blurNoise=void 0===i.blur_noise||i.blur_noise,s._createChromaticAberrationPostProcess(n),s._createHighlightsPostProcess(n),s._createDepthOfFieldPostProcess(n/4),s.addEffect(new h(r.getEngine(),s.LensChromaticAberrationEffect,function(){return s._chromaticAberrationPostProcess},!0)),s.addEffect(new h(r.getEngine(),s.HighlightsEnhancingEffect,function(){return s._highlightsPostProcess},!0)),s.addEffect(new h(r.getEngine(),s.LensDepthOfFieldEffect,function(){return s._depthOfFieldPostProcess},!0)),-1===s._highlightsGain&&s._disableEffect(s.HighlightsEnhancingEffect,null),r.postProcessRenderPipelineManager.addPipeline(s),o&&r.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(t,o),s}return o.d(t,e),t.prototype.setEdgeBlur=function(e){this._edgeBlur=e},t.prototype.disableEdgeBlur=function(){this._edgeBlur=0},t.prototype.setGrainAmount=function(e){this._grainAmount=e},t.prototype.disableGrain=function(){this._grainAmount=0},t.prototype.setChromaticAberration=function(e){this._chromaticAberration=e},t.prototype.disableChromaticAberration=function(){this._chromaticAberration=0},t.prototype.setEdgeDistortion=function(e){this._distortion=e},t.prototype.disableEdgeDistortion=function(){this._distortion=0},t.prototype.setFocusDistance=function(e){this._dofDistance=e},t.prototype.disableDepthOfField=function(){this._dofDistance=-1},t.prototype.setAperture=function(e){this._dofAperture=e},t.prototype.setDarkenOutOfFocus=function(e){this._dofDarken=e},t.prototype.enablePentagonBokeh=function(){this._highlightsPostProcess.updateEffect("#define PENTAGON\n")},t.prototype.disablePentagonBokeh=function(){this._highlightsPostProcess.updateEffect()},t.prototype.enableNoiseBlur=function(){this._blurNoise=!0},t.prototype.disableNoiseBlur=function(){this._blurNoise=!1},t.prototype.setHighlightsGain=function(e){this._highlightsGain=e},t.prototype.setHighlightsThreshold=function(e){-1===this._highlightsGain&&(this._highlightsGain=1),this._highlightsThreshold=e},t.prototype.disableHighlights=function(){this._highlightsGain=-1},t.prototype.dispose=function(e){void 0===e&&(e=!1),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),this._chromaticAberrationPostProcess=null,this._highlightsPostProcess=null,this._depthOfFieldPostProcess=null,this._grainTexture.dispose(),e&&this._scene.disableDepthRenderer()},t.prototype._createChromaticAberrationPostProcess=function(e){var t=this;this._chromaticAberrationPostProcess=new s.a("LensChromaticAberration","chromaticAberration",["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"],[],e,null,_.a.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._chromaticAberrationPostProcess.onApply=function(e){e.setFloat("chromatic_aberration",t._chromaticAberration),e.setFloat("screen_width",t._scene.getEngine().getRenderWidth()),e.setFloat("screen_height",t._scene.getEngine().getRenderHeight()),e.setFloat("radialIntensity",1),e.setFloat2("direction",17,17),e.setFloat2("centerPosition",.5,.5)}},t.prototype._createHighlightsPostProcess=function(e){var t=this;this._highlightsPostProcess=new s.a("LensHighlights","lensHighlights",["gain","threshold","screen_width","screen_height"],[],e,null,_.a.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,this._dofPentagon?"#define PENTAGON\n":""),this._highlightsPostProcess.onApply=function(e){e.setFloat("gain",t._highlightsGain),e.setFloat("threshold",t._highlightsThreshold),e.setTextureFromPostProcess("textureSampler",t._chromaticAberrationPostProcess),e.setFloat("screen_width",t._scene.getEngine().getRenderWidth()),e.setFloat("screen_height",t._scene.getEngine().getRenderHeight())}},t.prototype._createDepthOfFieldPostProcess=function(e){var t=this;this._depthOfFieldPostProcess=new s.a("LensDepthOfField","depthOfField",["grain_amount","blur_noise","screen_width","screen_height","distortion","dof_enabled","screen_distance","aperture","darken","edge_blur","highlights","near","far"],["depthSampler","grainSampler","highlightsSampler"],e,null,_.a.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._depthOfFieldPostProcess.onApply=function(e){e.setTexture("depthSampler",t._depthTexture),e.setTexture("grainSampler",t._grainTexture),e.setTextureFromPostProcess("textureSampler",t._highlightsPostProcess),e.setTextureFromPostProcess("highlightsSampler",t._depthOfFieldPostProcess),e.setFloat("grain_amount",t._grainAmount),e.setBool("blur_noise",t._blurNoise),e.setFloat("screen_width",t._scene.getEngine().getRenderWidth()),e.setFloat("screen_height",t._scene.getEngine().getRenderHeight()),e.setFloat("distortion",t._distortion),e.setBool("dof_enabled",-1!==t._dofDistance),e.setFloat("screen_distance",1/(.1-1/t._dofDistance)),e.setFloat("aperture",t._dofAperture),e.setFloat("darken",t._dofDarken),e.setFloat("edge_blur",t._edgeBlur),e.setBool("highlights",-1!==t._highlightsGain),t._scene.activeCamera&&(e.setFloat("near",t._scene.activeCamera.minZ),e.setFloat("far",t._scene.activeCamera.maxZ))}},t.prototype._createGrainTexture=function(){this._grainTexture=new W.a("LensNoiseTexture",512,this._scene,!1,_.a.BILINEAR_SAMPLINGMODE),this._grainTexture.wrapU=_.a.WRAP_ADDRESSMODE,this._grainTexture.wrapV=_.a.WRAP_ADDRESSMODE;for(var e,t,i,r=this._grainTexture.getContext(),n=0;n<512;n++)for(var o=0;o<512;o++)e=Math.floor(255*(t=.42,i=.58,Math.random()*(i-t)+t)),r.fillStyle="rgb("+e+", "+e+", "+e+")",r.fillRect(n,o,1,1);this._grainTexture.update(!1)},t}(z)),Q=(i(311),i(237),function(e){function t(t,i,r,n){var o=e.call(this,i.getEngine(),t)||this;if(o.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",o.SSAORenderEffect="SSAORenderEffect",o.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",o.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",o.SSAOCombineRenderEffect="SSAOCombineRenderEffect",o.totalStrength=1,o.maxZ=100,o.minZAspect=.2,o._samples=8,o._textureSamples=1,o._expensiveBlur=!0,o.radius=2,o.base=0,o._firstUpdate=!0,o._bits=new Uint32Array(1),o._scene=i,o._ratio=r,!o.isSupported)return y.a.Error("SSAO 2 needs WebGL 2 support."),o;var s=o._ratio.ssaoRatio||r,a=o._ratio.blurRatio||r,c=i.enableGeometryBufferRenderer();return o._createRandomTexture(),o._depthTexture=c.getGBuffer().textures[0],o._normalTexture=c.getGBuffer().textures[1],o._originalColorPostProcess=new G.b("SSAOOriginalSceneColor",1,null,_.a.BILINEAR_SAMPLINGMODE,i.getEngine(),!1),o._originalColorPostProcess.samples=o.textureSamples,o._createSSAOPostProcess(1),o._createBlurPostProcess(s,a),o._createSSAOCombinePostProcess(a),o.addEffect(new h(i.getEngine(),o.SSAOOriginalSceneColorEffect,function(){return o._originalColorPostProcess},!0)),o.addEffect(new h(i.getEngine(),o.SSAORenderEffect,function(){return o._ssaoPostProcess},!0)),o.addEffect(new h(i.getEngine(),o.SSAOBlurHRenderEffect,function(){return o._blurHPostProcess},!0)),o.addEffect(new h(i.getEngine(),o.SSAOBlurVRenderEffect,function(){return o._blurVPostProcess},!0)),o.addEffect(new h(i.getEngine(),o.SSAOCombineRenderEffect,function(){return o._ssaoCombinePostProcess},!0)),i.postProcessRenderPipelineManager.addPipeline(o),n&&i.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(t,n),o}return o.d(t,e),Object.defineProperty(t.prototype,"samples",{get:function(){return this._samples},set:function(e){this._ssaoPostProcess.updateEffect("#define SAMPLES "+e+"\n#define SSAO"),this._samples=e,this._sampleSphere=this._generateHemisphere(),this._firstUpdate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"textureSamples",{get:function(){return this._textureSamples},set:function(e){this._textureSamples=e,this._originalColorPostProcess.samples=e,this._blurHPostProcess.samples=e,this._blurVPostProcess.samples=e,this._ssaoPostProcess.samples=e,this._ssaoCombinePostProcess.samples=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"expensiveBlur",{get:function(){return this._expensiveBlur},set:function(e){this._blurHPostProcess.updateEffect("#define BILATERAL_BLUR\n#define BILATERAL_BLUR_H\n#define SAMPLES 16\n#define EXPENSIVE "+(e?"1":"0")+"\n",null,["textureSampler","depthSampler"]),this._blurVPostProcess.updateEffect("#define BILATERAL_BLUR\n#define SAMPLES 16\n#define EXPENSIVE "+(e?"1":"0")+"\n",null,["textureSampler","depthSampler"]),this._expensiveBlur=e,this._firstUpdate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t,"IsSupported",{get:function(){var e=k.a.LastCreatedEngine;return!!e&&e.getCaps().drawBuffersExtension},enumerable:!0,configurable:!0}),t.prototype.dispose=function(t){void 0===t&&(t=!1);for(var i=0;i<this._scene.cameras.length;i++){var r=this._scene.cameras[i];this._originalColorPostProcess.dispose(r),this._ssaoPostProcess.dispose(r),this._blurHPostProcess.dispose(r),this._blurVPostProcess.dispose(r),this._ssaoCombinePostProcess.dispose(r)}this._randomTexture.dispose(),t&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),e.prototype.dispose.call(this)},t.prototype._createBlurPostProcess=function(e,t){var i=this;this._samplerOffsets=[];for(var r=this.expensiveBlur,n=-8;n<8;n++)this._samplerOffsets.push(2*n+.5);this._blurHPostProcess=new s.a("BlurH","ssao2",["outSize","samplerOffsets","near","far","radius"],["depthSampler"],e,null,_.a.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define BILATERAL_BLUR\n#define BILATERAL_BLUR_H\n#define SAMPLES 16\n#define EXPENSIVE "+(r?"1":"0")+"\n"),this._blurHPostProcess.onApply=function(e){i._scene.activeCamera&&(e.setFloat("outSize",i._ssaoCombinePostProcess.width>0?i._ssaoCombinePostProcess.width:i._originalColorPostProcess.width),e.setFloat("near",i._scene.activeCamera.minZ),e.setFloat("far",i._scene.activeCamera.maxZ),e.setFloat("radius",i.radius),e.setTexture("depthSampler",i._depthTexture),i._firstUpdate&&e.setArray("samplerOffsets",i._samplerOffsets))},this._blurVPostProcess=new s.a("BlurV","ssao2",["outSize","samplerOffsets","near","far","radius"],["depthSampler"],t,null,_.a.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define BILATERAL_BLUR\n#define BILATERAL_BLUR_V\n#define SAMPLES 16\n#define EXPENSIVE "+(r?"1":"0")+"\n"),this._blurVPostProcess.onApply=function(e){i._scene.activeCamera&&(e.setFloat("outSize",i._ssaoCombinePostProcess.height>0?i._ssaoCombinePostProcess.height:i._originalColorPostProcess.height),e.setFloat("near",i._scene.activeCamera.minZ),e.setFloat("far",i._scene.activeCamera.maxZ),e.setFloat("radius",i.radius),e.setTexture("depthSampler",i._depthTexture),i._firstUpdate&&(e.setArray("samplerOffsets",i._samplerOffsets),i._firstUpdate=!1))},this._blurHPostProcess.samples=this.textureSamples,this._blurVPostProcess.samples=this.textureSamples},t.prototype._rebuild=function(){this._firstUpdate=!0,e.prototype._rebuild.call(this)},t.prototype._radicalInverse_VdC=function(e){return this._bits[0]=e,this._bits[0]=(this._bits[0]<<16|this._bits[0]>>16)>>>0,this._bits[0]=(1431655765&this._bits[0])<<1|(2863311530&this._bits[0])>>>1>>>0,this._bits[0]=(858993459&this._bits[0])<<2|(3435973836&this._bits[0])>>>2>>>0,this._bits[0]=(252645135&this._bits[0])<<4|(4042322160&this._bits[0])>>>4>>>0,this._bits[0]=(16711935&this._bits[0])<<8|(4278255360&this._bits[0])>>>8>>>0,2.3283064365386963e-10*this._bits[0]},t.prototype._hammersley=function(e,t){return[e/t,this._radicalInverse_VdC(e)]},t.prototype._hemisphereSample_uniform=function(e,t){var i=2*t*Math.PI,r=1-(.85*e+.15),n=Math.sqrt(1-r*r);return new l.Vector3(Math.cos(i)*n,Math.sin(i)*n,r)},t.prototype._generateHemisphere=function(){for(var e,t=this.samples,i=[],r=0;r<t;){if(t<16)e=this._hemisphereSample_uniform(Math.random(),Math.random());else{var n=this._hammersley(r,t);e=this._hemisphereSample_uniform(n[0],n[1])}i.push(e.x,e.y,e.z),r++}return i},t.prototype._createSSAOPostProcess=function(e){var t=this,i=this.samples;this._sampleSphere=this._generateHemisphere(),this._ssaoPostProcess=new s.a("ssao2","ssao2",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","base","range","projection","near","far","texelSize","xViewport","yViewport","maxZ","minZAspect"],["randomSampler","normalSampler"],e,null,_.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define SAMPLES "+i+"\n#define SSAO"),this._ssaoPostProcess.onApply=function(e){t._firstUpdate&&(e.setArray3("sampleSphere",t._sampleSphere),e.setFloat("randTextureTiles",32)),t._scene.activeCamera&&(e.setFloat("samplesFactor",1/t.samples),e.setFloat("totalStrength",t.totalStrength),e.setFloat2("texelSize",1/t._ssaoPostProcess.width,1/t._ssaoPostProcess.height),e.setFloat("radius",t.radius),e.setFloat("maxZ",t.maxZ),e.setFloat("minZAspect",t.minZAspect),e.setFloat("base",t.base),e.setFloat("near",t._scene.activeCamera.minZ),e.setFloat("far",t._scene.activeCamera.maxZ),e.setFloat("xViewport",Math.tan(t._scene.activeCamera.fov/2)*t._scene.getEngine().getAspectRatio(t._scene.activeCamera,!0)),e.setFloat("yViewport",Math.tan(t._scene.activeCamera.fov/2)),e.setMatrix("projection",t._scene.getProjectionMatrix()),e.setTexture("textureSampler",t._depthTexture),e.setTexture("normalSampler",t._normalTexture),e.setTexture("randomSampler",t._randomTexture))},this._ssaoPostProcess.samples=this.textureSamples},t.prototype._createSSAOCombinePostProcess=function(e){var t=this;this._ssaoCombinePostProcess=new s.a("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,_.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._ssaoCombinePostProcess.onApply=function(e){var i=t._scene.activeCamera.viewport;e.setVector4("viewport",l.Tmp.Vector4[0].copyFromFloats(i.x,i.y,i.width,i.height)),e.setTextureFromPostProcess("originalColor",t._originalColorPostProcess)},this._ssaoCombinePostProcess.samples=this.textureSamples},t.prototype._createRandomTexture=function(){this._randomTexture=new W.a("SSAORandomTexture",128,this._scene,!1,_.a.TRILINEAR_SAMPLINGMODE),this._randomTexture.wrapU=_.a.WRAP_ADDRESSMODE,this._randomTexture.wrapV=_.a.WRAP_ADDRESSMODE;for(var e=this._randomTexture.getContext(),t=function(e,t){return Math.random()*(t-e)+e},i=l.Vector3.Zero(),r=0;r<128;r++)for(var n=0;n<128;n++)i.x=t(0,1),i.y=t(0,1),i.z=0,i.normalize(),i.scaleInPlace(255),i.x=Math.floor(i.x),i.y=Math.floor(i.y),e.fillStyle="rgb("+i.x+", "+i.y+", "+i.z+")",e.fillRect(r,n,1,1);this._randomTexture.update(!1)},t.prototype.serialize=function(){var e=L.a.Serialize(this);return e.customType="SSAO2RenderingPipeline",e},t.Parse=function(e,i,r){return L.a.Parse(function(){return new t(e._name,i,e._ratio)},e,i,r)},o.c([Object(L.c)()],t.prototype,"totalStrength",void 0),o.c([Object(L.c)()],t.prototype,"maxZ",void 0),o.c([Object(L.c)()],t.prototype,"minZAspect",void 0),o.c([Object(L.c)("samples")],t.prototype,"_samples",void 0),o.c([Object(L.c)("textureSamples")],t.prototype,"_textureSamples",void 0),o.c([Object(L.c)()],t.prototype,"_ratio",void 0),o.c([Object(L.c)("expensiveBlur")],t.prototype,"_expensiveBlur",void 0),o.c([Object(L.c)()],t.prototype,"radius",void 0),o.c([Object(L.c)()],t.prototype,"base",void 0),t}(z));j.a.RegisteredTypes["BABYLON.SSAO2RenderingPipeline"]=Q;i(312);var J=function(e){function t(t,i,r,n){var o=e.call(this,i.getEngine(),t)||this;o.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",o.SSAORenderEffect="SSAORenderEffect",o.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",o.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",o.SSAOCombineRenderEffect="SSAOCombineRenderEffect",o.totalStrength=1,o.radius=1e-4,o.area=.0075,o.fallOff=1e-6,o.base=.5,o._firstUpdate=!0,o._scene=i,o._createRandomTexture(),o._depthTexture=i.enableDepthRenderer().getDepthMap();var s=r.ssaoRatio||r,a=r.combineRatio||r;return o._originalColorPostProcess=new G.b("SSAOOriginalSceneColor",a,null,_.a.BILINEAR_SAMPLINGMODE,i.getEngine(),!1),o._createSSAOPostProcess(s),o._createBlurPostProcess(s),o._createSSAOCombinePostProcess(a),o.addEffect(new h(i.getEngine(),o.SSAOOriginalSceneColorEffect,function(){return o._originalColorPostProcess},!0)),o.addEffect(new h(i.getEngine(),o.SSAORenderEffect,function(){return o._ssaoPostProcess},!0)),o.addEffect(new h(i.getEngine(),o.SSAOBlurHRenderEffect,function(){return o._blurHPostProcess},!0)),o.addEffect(new h(i.getEngine(),o.SSAOBlurVRenderEffect,function(){return o._blurVPostProcess},!0)),o.addEffect(new h(i.getEngine(),o.SSAOCombineRenderEffect,function(){return o._ssaoCombinePostProcess},!0)),i.postProcessRenderPipelineManager.addPipeline(o),n&&i.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(t,n),o}return o.d(t,e),t.prototype.dispose=function(t){void 0===t&&(t=!1);for(var i=0;i<this._scene.cameras.length;i++){var r=this._scene.cameras[i];this._originalColorPostProcess.dispose(r),this._ssaoPostProcess.dispose(r),this._blurHPostProcess.dispose(r),this._blurVPostProcess.dispose(r),this._ssaoCombinePostProcess.dispose(r)}this._randomTexture.dispose(),t&&this._scene.disableDepthRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),e.prototype.dispose.call(this)},t.prototype._createBlurPostProcess=function(e){var t=this;this._blurHPostProcess=new d.a("BlurH",new l.Vector2(1,0),16,e,null,_.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,u.a.TEXTURETYPE_UNSIGNED_INT),this._blurVPostProcess=new d.a("BlurV",new l.Vector2(0,1),16,e,null,_.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,u.a.TEXTURETYPE_UNSIGNED_INT),this._blurHPostProcess.onActivateObservable.add(function(){var e=t._blurHPostProcess.width/t._scene.getEngine().getRenderWidth();t._blurHPostProcess.kernel=16*e}),this._blurVPostProcess.onActivateObservable.add(function(){var e=t._blurVPostProcess.height/t._scene.getEngine().getRenderHeight();t._blurVPostProcess.kernel=16*e})},t.prototype._rebuild=function(){this._firstUpdate=!0,e.prototype._rebuild.call(this)},t.prototype._createSSAOPostProcess=function(e){var t=this,i=[.5381,.1856,-.4319,.1379,.2486,.443,.3371,.5679,-.0057,-.6999,-.0451,-.0019,.0689,-.1598,-.8547,.056,.0069,-.1843,-.0146,.1402,.0762,.01,-.1924,-.0344,-.3577,-.5301,-.4358,-.3169,.1063,.0158,.0103,-.5869,.0046,-.0897,-.494,.3287,.7119,-.0154,-.0918,-.0533,.0596,-.5411,.0352,-.0631,.546,-.4776,.2847,-.0271];this._ssaoPostProcess=new s.a("ssao","ssao",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","area","fallOff","base","range","viewport"],["randomSampler"],e,null,_.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define SAMPLES 16\n#define SSAO"),this._ssaoPostProcess.onApply=function(e){t._firstUpdate&&(e.setArray3("sampleSphere",i),e.setFloat("samplesFactor",1/16),e.setFloat("randTextureTiles",4)),e.setFloat("totalStrength",t.totalStrength),e.setFloat("radius",t.radius),e.setFloat("area",t.area),e.setFloat("fallOff",t.fallOff),e.setFloat("base",t.base),e.setTexture("textureSampler",t._depthTexture),e.setTexture("randomSampler",t._randomTexture)}},t.prototype._createSSAOCombinePostProcess=function(e){var t=this;this._ssaoCombinePostProcess=new s.a("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,_.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._ssaoCombinePostProcess.onApply=function(e){e.setVector4("viewport",l.Tmp.Vector4[0].copyFromFloats(0,0,1,1)),e.setTextureFromPostProcess("originalColor",t._originalColorPostProcess)}},t.prototype._createRandomTexture=function(){this._randomTexture=new W.a("SSAORandomTexture",512,this._scene,!1,_.a.TRILINEAR_SAMPLINGMODE),this._randomTexture.wrapU=_.a.WRAP_ADDRESSMODE,this._randomTexture.wrapV=_.a.WRAP_ADDRESSMODE;for(var e=this._randomTexture.getContext(),t=function(e,t){return Math.random()*(t-e)+e},i=l.Vector3.Zero(),r=0;r<512;r++)for(var n=0;n<512;n++)i.x=Math.floor(255*t(-1,1)),i.y=Math.floor(255*t(-1,1)),i.z=Math.floor(255*t(-1,1)),e.fillStyle="rgb("+i.x+", "+i.y+", "+i.z+")",e.fillRect(r,n,1,1);this._randomTexture.update(!1)},o.c([Object(L.c)()],t.prototype,"totalStrength",void 0),o.c([Object(L.c)()],t.prototype,"radius",void 0),o.c([Object(L.c)()],t.prototype,"area",void 0),o.c([Object(L.c)()],t.prototype,"fallOff",void 0),o.c([Object(L.c)()],t.prototype,"base",void 0),t}(z),Y=i(12),X=(i(313),function(e){function t(t,i,r,n,o){void 0===n&&(n=null);var s=e.call(this,i.getEngine(),t)||this;return s.downSampleX4PostProcess=null,s.brightPassPostProcess=null,s.blurHPostProcesses=[],s.blurVPostProcesses=[],s.textureAdderPostProcess=null,s.volumetricLightPostProcess=null,s.volumetricLightSmoothXPostProcess=null,s.volumetricLightSmoothYPostProcess=null,s.volumetricLightMergePostProces=null,s.volumetricLightFinalPostProcess=null,s.luminancePostProcess=null,s.luminanceDownSamplePostProcesses=[],s.hdrPostProcess=null,s.textureAdderFinalPostProcess=null,s.lensFlareFinalPostProcess=null,s.hdrFinalPostProcess=null,s.lensFlarePostProcess=null,s.lensFlareComposePostProcess=null,s.motionBlurPostProcess=null,s.depthOfFieldPostProcess=null,s.fxaaPostProcess=null,s.brightThreshold=1,s.blurWidth=512,s.horizontalBlur=!1,s.exposure=1,s.lensTexture=null,s.volumetricLightCoefficient=.2,s.volumetricLightPower=4,s.volumetricLightBlurScale=64,s.sourceLight=null,s.hdrMinimumLuminance=1,s.hdrDecreaseRate=.5,s.hdrIncreaseRate=.5,s.lensColorTexture=null,s.lensFlareStrength=20,s.lensFlareGhostDispersal=1.4,s.lensFlareHaloWidth=.7,s.lensFlareDistortionStrength=16,s.lensStarTexture=null,s.lensFlareDirtTexture=null,s.depthOfFieldDistance=10,s.depthOfFieldBlurWidth=64,s.motionStrength=1,s.animations=[],s._currentDepthOfFieldSource=null,s._hdrCurrentLuminance=1,s._bloomEnabled=!1,s._depthOfFieldEnabled=!1,s._vlsEnabled=!1,s._lensFlareEnabled=!1,s._hdrEnabled=!1,s._motionBlurEnabled=!1,s._fxaaEnabled=!1,s._motionBlurSamples=64,s._volumetricLightStepsCount=50,s._samples=1,s._cameras=o||[],s._scene=i,s._basePostProcess=n,s._ratio=r,s._floatTextureType=i.getEngine().getCaps().textureFloatRender?u.a.TEXTURETYPE_FLOAT:u.a.TEXTURETYPE_HALF_FLOAT,i.postProcessRenderPipelineManager.addPipeline(s),s._buildPipeline(),s}return o.d(t,e),Object.defineProperty(t.prototype,"BloomEnabled",{get:function(){return this._bloomEnabled},set:function(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"DepthOfFieldEnabled",{get:function(){return this._depthOfFieldEnabled},set:function(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"LensFlareEnabled",{get:function(){return this._lensFlareEnabled},set:function(e){this._lensFlareEnabled!==e&&(this._lensFlareEnabled=e,this._buildPipeline())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"HDREnabled",{get:function(){return this._hdrEnabled},set:function(e){this._hdrEnabled!==e&&(this._hdrEnabled=e,this._buildPipeline())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"VLSEnabled",{get:function(){return this._vlsEnabled},set:function(e){if(this._vlsEnabled!==e){if(e)if(!this._scene.enableGeometryBufferRenderer())return void y.a.Warn("Geometry renderer is not supported, cannot create volumetric lights in Standard Rendering Pipeline");this._vlsEnabled=e,this._buildPipeline()}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"MotionBlurEnabled",{get:function(){return this._motionBlurEnabled},set:function(e){this._motionBlurEnabled!==e&&(this._motionBlurEnabled=e,this._buildPipeline())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fxaaEnabled",{get:function(){return this._fxaaEnabled},set:function(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"volumetricLightStepsCount",{get:function(){return this._volumetricLightStepsCount},set:function(e){this.volumetricLightPostProcess&&this.volumetricLightPostProcess.updateEffect("#define VLS\n#define NB_STEPS "+e.toFixed(1)),this._volumetricLightStepsCount=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"motionBlurSamples",{get:function(){return this._motionBlurSamples},set:function(e){this.motionBlurPostProcess&&this.motionBlurPostProcess.updateEffect("#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+e.toFixed(1)),this._motionBlurSamples=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"samples",{get:function(){return this._samples},set:function(e){this._samples!==e&&(this._samples=e,this._buildPipeline())},enumerable:!0,configurable:!0}),t.prototype._buildPipeline=function(){var e=this,t=this._ratio,i=this._scene;this._disposePostProcesses(),this._reset(),this._basePostProcess?this.originalPostProcess=this._basePostProcess:(this.originalPostProcess=new s.a("HDRPass","standard",[],[],t,null,u.a.TEXTURE_BILINEAR_SAMPLINGMODE,i.getEngine(),!1,"#define PASS_POST_PROCESS",this._floatTextureType),this.originalPostProcess.onApply=function(){e._currentDepthOfFieldSource=e.originalPostProcess}),(this._bloomEnabled||this._vlsEnabled||this._lensFlareEnabled||this._depthOfFieldEnabled||this._motionBlurEnabled)&&this.addEffect(new h(i.getEngine(),"HDRPassPostProcess",function(){return e.originalPostProcess},!0)),this._currentDepthOfFieldSource=this.originalPostProcess,this._bloomEnabled&&(this._createDownSampleX4PostProcess(i,t/2),this._createBrightPassPostProcess(i,t/2),this._createBlurPostProcesses(i,t/4,1),this._createTextureAdderPostProcess(i,t),this.textureAdderFinalPostProcess=new s.a("HDRDepthOfFieldSource","standard",[],[],t,null,_.a.BILINEAR_SAMPLINGMODE,i.getEngine(),!1,"#define PASS_POST_PROCESS",u.a.TEXTURETYPE_UNSIGNED_INT),this.addEffect(new h(i.getEngine(),"HDRBaseDepthOfFieldSource",function(){return e.textureAdderFinalPostProcess},!0))),this._vlsEnabled&&(this._createVolumetricLightPostProcess(i,t),this.volumetricLightFinalPostProcess=new s.a("HDRVLSFinal","standard",[],[],t,null,_.a.BILINEAR_SAMPLINGMODE,i.getEngine(),!1,"#define PASS_POST_PROCESS",u.a.TEXTURETYPE_UNSIGNED_INT),this.addEffect(new h(i.getEngine(),"HDRVLSFinal",function(){return e.volumetricLightFinalPostProcess},!0))),this._lensFlareEnabled&&(this._createLensFlarePostProcess(i,t),this.lensFlareFinalPostProcess=new s.a("HDRPostLensFlareDepthOfFieldSource","standard",[],[],t,null,_.a.BILINEAR_SAMPLINGMODE,i.getEngine(),!1,"#define PASS_POST_PROCESS",u.a.TEXTURETYPE_UNSIGNED_INT),this.addEffect(new h(i.getEngine(),"HDRPostLensFlareDepthOfFieldSource",function(){return e.lensFlareFinalPostProcess},!0))),this._hdrEnabled&&(this._createLuminancePostProcesses(i,this._floatTextureType),this._createHdrPostProcess(i,t),this.hdrFinalPostProcess=new s.a("HDRPostHDReDepthOfFieldSource","standard",[],[],t,null,_.a.BILINEAR_SAMPLINGMODE,i.getEngine(),!1,"#define PASS_POST_PROCESS",u.a.TEXTURETYPE_UNSIGNED_INT),this.addEffect(new h(i.getEngine(),"HDRPostHDReDepthOfFieldSource",function(){return e.hdrFinalPostProcess},!0))),this._depthOfFieldEnabled&&(this._createBlurPostProcesses(i,t/2,3,"depthOfFieldBlurWidth"),this._createDepthOfFieldPostProcess(i,t)),this._motionBlurEnabled&&this._createMotionBlurPostProcess(i,t),this._fxaaEnabled&&(this.fxaaPostProcess=new C.a("fxaa",1,null,_.a.BILINEAR_SAMPLINGMODE,i.getEngine(),!1,u.a.TEXTURETYPE_UNSIGNED_INT),this.addEffect(new h(i.getEngine(),"HDRFxaa",function(){return e.fxaaPostProcess},!0))),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),!this._enableMSAAOnFirstPostProcess(this._samples)&&this._samples>1&&y.a.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0")},t.prototype._createDownSampleX4PostProcess=function(e,t){var i=this,r=new Array(32);this.downSampleX4PostProcess=new s.a("HDRDownSampleX4","standard",["dsOffsets"],[],t,null,_.a.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DOWN_SAMPLE_X4",u.a.TEXTURETYPE_UNSIGNED_INT),this.downSampleX4PostProcess.onApply=function(e){for(var t=0,n=i.downSampleX4PostProcess.width,o=i.downSampleX4PostProcess.height,s=-2;s<2;s++)for(var a=-2;a<2;a++)r[t]=(s+.5)*(1/n),r[t+1]=(a+.5)*(1/o),t+=2;e.setArray2("dsOffsets",r)},this.addEffect(new h(e.getEngine(),"HDRDownSampleX4",function(){return i.downSampleX4PostProcess},!0))},t.prototype._createBrightPassPostProcess=function(e,t){var i=this,r=new Array(8);this.brightPassPostProcess=new s.a("HDRBrightPass","standard",["dsOffsets","brightThreshold"],[],t,null,_.a.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define BRIGHT_PASS",u.a.TEXTURETYPE_UNSIGNED_INT),this.brightPassPostProcess.onApply=function(e){var t=1/i.brightPassPostProcess.width,n=1/i.brightPassPostProcess.height;r[0]=-.5*t,r[1]=.5*n,r[2]=.5*t,r[3]=.5*n,r[4]=-.5*t,r[5]=-.5*n,r[6]=.5*t,r[7]=-.5*n,e.setArray2("dsOffsets",r),e.setFloat("brightThreshold",i.brightThreshold)},this.addEffect(new h(e.getEngine(),"HDRBrightPass",function(){return i.brightPassPostProcess},!0))},t.prototype._createBlurPostProcesses=function(e,t,i,r){var n=this;void 0===r&&(r="blurWidth");var o=e.getEngine(),s=new d.a("HDRBlurH_"+i,new l.Vector2(1,0),this[r],t,null,_.a.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,u.a.TEXTURETYPE_UNSIGNED_INT),a=new d.a("HDRBlurV_"+i,new l.Vector2(0,1),this[r],t,null,_.a.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,u.a.TEXTURETYPE_UNSIGNED_INT);s.onActivateObservable.add(function(){var e=s.width/o.getRenderWidth();s.kernel=n[r]*e}),a.onActivateObservable.add(function(){var e=a.height/o.getRenderHeight();a.kernel=n.horizontalBlur?64*e:n[r]*e}),this.addEffect(new h(e.getEngine(),"HDRBlurH"+i,function(){return s},!0)),this.addEffect(new h(e.getEngine(),"HDRBlurV"+i,function(){return a},!0)),this.blurHPostProcesses.push(s),this.blurVPostProcesses.push(a)},t.prototype._createTextureAdderPostProcess=function(e,t){var i=this;this.textureAdderPostProcess=new s.a("HDRTextureAdder","standard",["exposure"],["otherSampler","lensSampler"],t,null,_.a.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define TEXTURE_ADDER",u.a.TEXTURETYPE_UNSIGNED_INT),this.textureAdderPostProcess.onApply=function(e){e.setTextureFromPostProcess("otherSampler",i._vlsEnabled?i._currentDepthOfFieldSource:i.originalPostProcess),e.setTexture("lensSampler",i.lensTexture),e.setFloat("exposure",i.exposure),i._currentDepthOfFieldSource=i.textureAdderFinalPostProcess},this.addEffect(new h(e.getEngine(),"HDRTextureAdder",function(){return i.textureAdderPostProcess},!0))},t.prototype._createVolumetricLightPostProcess=function(e,t){var i=this,r=e.enableGeometryBufferRenderer();r.enablePosition=!0;var n=r.getGBuffer();this.volumetricLightPostProcess=new s.a("HDRVLS","standard",["shadowViewProjection","cameraPosition","sunDirection","sunColor","scatteringCoefficient","scatteringPower","depthValues"],["shadowMapSampler","positionSampler"],t/8,null,_.a.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define VLS\n#define NB_STEPS "+this._volumetricLightStepsCount.toFixed(1));var o=l.Vector2.Zero();this.volumetricLightPostProcess.onApply=function(e){if(i.sourceLight&&i.sourceLight.getShadowGenerator()&&i._scene.activeCamera){var t=i.sourceLight.getShadowGenerator();e.setTexture("shadowMapSampler",t.getShadowMap()),e.setTexture("positionSampler",n.textures[2]),e.setColor3("sunColor",i.sourceLight.diffuse),e.setVector3("sunDirection",i.sourceLight.getShadowDirection()),e.setVector3("cameraPosition",i._scene.activeCamera.globalPosition),e.setMatrix("shadowViewProjection",t.getTransformMatrix()),e.setFloat("scatteringCoefficient",i.volumetricLightCoefficient),e.setFloat("scatteringPower",i.volumetricLightPower),o.x=i.sourceLight.getDepthMinZ(i._scene.activeCamera),o.y=i.sourceLight.getDepthMaxZ(i._scene.activeCamera),e.setVector2("depthValues",o)}},this.addEffect(new h(e.getEngine(),"HDRVLS",function(){return i.volumetricLightPostProcess},!0)),this._createBlurPostProcesses(e,t/4,0,"volumetricLightBlurScale"),this.volumetricLightMergePostProces=new s.a("HDRVLSMerge","standard",[],["originalSampler"],t,null,_.a.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define VLSMERGE"),this.volumetricLightMergePostProces.onApply=function(e){e.setTextureFromPostProcess("originalSampler",i._bloomEnabled?i.textureAdderFinalPostProcess:i.originalPostProcess),i._currentDepthOfFieldSource=i.volumetricLightFinalPostProcess},this.addEffect(new h(e.getEngine(),"HDRVLSMerge",function(){return i.volumetricLightMergePostProces},!0))},t.prototype._createLuminancePostProcesses=function(e,i){var r=this,n=Math.pow(3,t.LuminanceSteps);this.luminancePostProcess=new s.a("HDRLuminance","standard",["lumOffsets"],[],{width:n,height:n},null,_.a.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LUMINANCE",i);var o=[];this.luminancePostProcess.onApply=function(e){var t=1/r.luminancePostProcess.width,i=1/r.luminancePostProcess.height;o[0]=-.5*t,o[1]=.5*i,o[2]=.5*t,o[3]=.5*i,o[4]=-.5*t,o[5]=-.5*i,o[6]=.5*t,o[7]=-.5*i,e.setArray2("lumOffsets",o)},this.addEffect(new h(e.getEngine(),"HDRLuminance",function(){return r.luminancePostProcess},!0));for(var a=t.LuminanceSteps-1;a>=0;a--){n=Math.pow(3,a);var c="#define LUMINANCE_DOWN_SAMPLE\n";0===a&&(c+="#define FINAL_DOWN_SAMPLER");var u=new s.a("HDRLuminanceDownSample"+a,"standard",["dsOffsets","halfDestPixelSize"],[],{width:n,height:n},null,_.a.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,c,i);this.luminanceDownSamplePostProcesses.push(u)}var p=this.luminancePostProcess;this.luminanceDownSamplePostProcesses.forEach(function(t,i){var n=new Array(18);t.onApply=function(e){if(p){for(var o=0,s=-1;s<2;s++)for(var a=-1;a<2;a++)n[o]=s/p.width,n[o+1]=a/p.height,o+=2;e.setArray2("dsOffsets",n),e.setFloat("halfDestPixelSize",.5/p.width),p=i===r.luminanceDownSamplePostProcesses.length-1?r.luminancePostProcess:t}},i===r.luminanceDownSamplePostProcesses.length-1&&(t.onAfterRender=function(){var t=e.getEngine().readPixels(0,0,1,1),i=new l.Vector4(1/16581375,1/65025,1/255,1);r._hdrCurrentLuminance=(t[0]*i.x+t[1]*i.y+t[2]*i.z+t[3]*i.w)/100}),r.addEffect(new h(e.getEngine(),"HDRLuminanceDownSample"+i,function(){return t},!0))})},t.prototype._createHdrPostProcess=function(e,t){var i=this;this.hdrPostProcess=new s.a("HDR","standard",["averageLuminance"],["textureAdderSampler"],t,null,_.a.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define HDR",u.a.TEXTURETYPE_UNSIGNED_INT);var r=1,n=0,o=0;this.hdrPostProcess.onApply=function(t){if(t.setTextureFromPostProcess("textureAdderSampler",i._currentDepthOfFieldSource),n+=e.getEngine().getDeltaTime(),r<0)r=i._hdrCurrentLuminance;else{var s=(o-n)/1e3;i._hdrCurrentLuminance<r+i.hdrDecreaseRate*s?r+=i.hdrDecreaseRate*s:i._hdrCurrentLuminance>r-i.hdrIncreaseRate*s?r-=i.hdrIncreaseRate*s:r=i._hdrCurrentLuminance}r=Y.a.Clamp(r,i.hdrMinimumLuminance,1e20),t.setFloat("averageLuminance",r),o=n,i._currentDepthOfFieldSource=i.hdrFinalPostProcess},this.addEffect(new h(e.getEngine(),"HDR",function(){return i.hdrPostProcess},!0))},t.prototype._createLensFlarePostProcess=function(e,t){var i=this;this.lensFlarePostProcess=new s.a("HDRLensFlare","standard",["strength","ghostDispersal","haloWidth","resolution","distortionStrength"],["lensColorSampler"],t/2,null,_.a.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE",u.a.TEXTURETYPE_UNSIGNED_INT),this.addEffect(new h(e.getEngine(),"HDRLensFlare",function(){return i.lensFlarePostProcess},!0)),this._createBlurPostProcesses(e,t/4,2),this.lensFlareComposePostProcess=new s.a("HDRLensFlareCompose","standard",["lensStarMatrix"],["otherSampler","lensDirtSampler","lensStarSampler"],t,null,_.a.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE_COMPOSE",u.a.TEXTURETYPE_UNSIGNED_INT),this.addEffect(new h(e.getEngine(),"HDRLensFlareCompose",function(){return i.lensFlareComposePostProcess},!0));var r=new l.Vector2(0,0);this.lensFlarePostProcess.onApply=function(e){e.setTextureFromPostProcess("textureSampler",i._bloomEnabled?i.blurHPostProcesses[0]:i.originalPostProcess),e.setTexture("lensColorSampler",i.lensColorTexture),e.setFloat("strength",i.lensFlareStrength),e.setFloat("ghostDispersal",i.lensFlareGhostDispersal),e.setFloat("haloWidth",i.lensFlareHaloWidth),r.x=i.lensFlarePostProcess.width,r.y=i.lensFlarePostProcess.height,e.setVector2("resolution",r),e.setFloat("distortionStrength",i.lensFlareDistortionStrength)};var n=l.Matrix.FromValues(2,0,-1,0,0,2,-1,0,0,0,1,0,0,0,0,1),o=l.Matrix.FromValues(.5,0,.5,0,0,.5,.5,0,0,0,1,0,0,0,0,1);this.lensFlareComposePostProcess.onApply=function(e){if(i._scene.activeCamera){e.setTextureFromPostProcess("otherSampler",i._currentDepthOfFieldSource),e.setTexture("lensDirtSampler",i.lensFlareDirtTexture),e.setTexture("lensStarSampler",i.lensStarTexture);var t=i._scene.activeCamera.getViewMatrix().getRow(0),r=i._scene.activeCamera.getViewMatrix().getRow(2),s=l.Vector3.Dot(t.toVector3(),new l.Vector3(1,0,0))+l.Vector3.Dot(r.toVector3(),new l.Vector3(0,0,1));s*=4;var a=l.Matrix.FromValues(.5*Math.cos(s),-Math.sin(s),0,0,Math.sin(s),.5*Math.cos(s),0,0,0,0,1,0,0,0,0,1),c=o.multiply(a).multiply(n);e.setMatrix("lensStarMatrix",c),i._currentDepthOfFieldSource=i.lensFlareFinalPostProcess}}},t.prototype._createDepthOfFieldPostProcess=function(e,t){var i=this;this.depthOfFieldPostProcess=new s.a("HDRDepthOfField","standard",["distance"],["otherSampler","depthSampler"],t,null,_.a.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DEPTH_OF_FIELD",u.a.TEXTURETYPE_UNSIGNED_INT),this.depthOfFieldPostProcess.onApply=function(e){e.setTextureFromPostProcess("otherSampler",i._currentDepthOfFieldSource),e.setTexture("depthSampler",i._getDepthTexture()),e.setFloat("distance",i.depthOfFieldDistance)},this.addEffect(new h(e.getEngine(),"HDRDepthOfField",function(){return i.depthOfFieldPostProcess},!0))},t.prototype._createMotionBlurPostProcess=function(e,t){var i=this;this.motionBlurPostProcess=new s.a("HDRMotionBlur","standard",["inverseViewProjection","prevViewProjection","screenSize","motionScale","motionStrength"],["depthSampler"],t,null,_.a.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+this.motionBlurSamples.toFixed(1),u.a.TEXTURETYPE_UNSIGNED_INT);var r=0,n=l.Matrix.Identity(),o=l.Matrix.Identity(),a=l.Matrix.Identity(),c=l.Vector2.Zero();this.motionBlurPostProcess.onApply=function(t){(a=e.getProjectionMatrix().multiply(e.getViewMatrix())).invertToRef(o),t.setMatrix("inverseViewProjection",o),t.setMatrix("prevViewProjection",n),n=a,c.x=i.motionBlurPostProcess.width,c.y=i.motionBlurPostProcess.height,t.setVector2("screenSize",c),r=e.getEngine().getFps()/60,t.setFloat("motionScale",r),t.setFloat("motionStrength",i.motionStrength),t.setTexture("depthSampler",i._getDepthTexture())},this.addEffect(new h(e.getEngine(),"HDRMotionBlur",function(){return i.motionBlurPostProcess},!0))},t.prototype._getDepthTexture=function(){return this._scene.getEngine().getCaps().drawBuffersExtension?this._scene.enableGeometryBufferRenderer().getGBuffer().textures[0]:this._scene.enableDepthRenderer().getDepthMap()},t.prototype._disposePostProcesses=function(){for(var e=0;e<this._cameras.length;e++){var t=this._cameras[e];this.originalPostProcess&&this.originalPostProcess.dispose(t),this.downSampleX4PostProcess&&this.downSampleX4PostProcess.dispose(t),this.brightPassPostProcess&&this.brightPassPostProcess.dispose(t),this.textureAdderPostProcess&&this.textureAdderPostProcess.dispose(t),this.textureAdderFinalPostProcess&&this.textureAdderFinalPostProcess.dispose(t),this.volumetricLightPostProcess&&this.volumetricLightPostProcess.dispose(t),this.volumetricLightSmoothXPostProcess&&this.volumetricLightSmoothXPostProcess.dispose(t),this.volumetricLightSmoothYPostProcess&&this.volumetricLightSmoothYPostProcess.dispose(t),this.volumetricLightMergePostProces&&this.volumetricLightMergePostProces.dispose(t),this.volumetricLightFinalPostProcess&&this.volumetricLightFinalPostProcess.dispose(t),this.lensFlarePostProcess&&this.lensFlarePostProcess.dispose(t),this.lensFlareComposePostProcess&&this.lensFlareComposePostProcess.dispose(t);for(var i=0;i<this.luminanceDownSamplePostProcesses.length;i++)this.luminanceDownSamplePostProcesses[i].dispose(t);this.luminancePostProcess&&this.luminancePostProcess.dispose(t),this.hdrPostProcess&&this.hdrPostProcess.dispose(t),this.hdrFinalPostProcess&&this.hdrFinalPostProcess.dispose(t),this.depthOfFieldPostProcess&&this.depthOfFieldPostProcess.dispose(t),this.motionBlurPostProcess&&this.motionBlurPostProcess.dispose(t),this.fxaaPostProcess&&this.fxaaPostProcess.dispose(t);for(i=0;i<this.blurHPostProcesses.length;i++)this.blurHPostProcesses[i].dispose(t);for(i=0;i<this.blurVPostProcesses.length;i++)this.blurVPostProcesses[i].dispose(t)}this.originalPostProcess=null,this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.textureAdderPostProcess=null,this.textureAdderFinalPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.luminancePostProcess=null,this.hdrPostProcess=null,this.hdrFinalPostProcess=null,this.depthOfFieldPostProcess=null,this.motionBlurPostProcess=null,this.fxaaPostProcess=null,this.luminanceDownSamplePostProcesses=[],this.blurHPostProcesses=[],this.blurVPostProcesses=[]},t.prototype.dispose=function(){this._disposePostProcesses(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),e.prototype.dispose.call(this)},t.prototype.serialize=function(){var e=L.a.Serialize(this);return this.sourceLight&&(e.sourceLightId=this.sourceLight.id),e.customType="StandardRenderingPipeline",e},t.Parse=function(e,i,r){var n=L.a.Parse(function(){return new t(e._name,i,e._ratio)},e,i,r);return e.sourceLightId&&(n.sourceLight=i.getLightByID(e.sourceLightId)),n},t.LuminanceSteps=6,o.c([Object(L.c)()],t.prototype,"brightThreshold",void 0),o.c([Object(L.c)()],t.prototype,"blurWidth",void 0),o.c([Object(L.c)()],t.prototype,"horizontalBlur",void 0),o.c([Object(L.c)()],t.prototype,"exposure",void 0),o.c([Object(L.l)("lensTexture")],t.prototype,"lensTexture",void 0),o.c([Object(L.c)()],t.prototype,"volumetricLightCoefficient",void 0),o.c([Object(L.c)()],t.prototype,"volumetricLightPower",void 0),o.c([Object(L.c)()],t.prototype,"volumetricLightBlurScale",void 0),o.c([Object(L.c)()],t.prototype,"hdrMinimumLuminance",void 0),o.c([Object(L.c)()],t.prototype,"hdrDecreaseRate",void 0),o.c([Object(L.c)()],t.prototype,"hdrIncreaseRate",void 0),o.c([Object(L.l)("lensColorTexture")],t.prototype,"lensColorTexture",void 0),o.c([Object(L.c)()],t.prototype,"lensFlareStrength",void 0),o.c([Object(L.c)()],t.prototype,"lensFlareGhostDispersal",void 0),o.c([Object(L.c)()],t.prototype,"lensFlareHaloWidth",void 0),o.c([Object(L.c)()],t.prototype,"lensFlareDistortionStrength",void 0),o.c([Object(L.l)("lensStarTexture")],t.prototype,"lensStarTexture",void 0),o.c([Object(L.l)("lensFlareDirtTexture")],t.prototype,"lensFlareDirtTexture",void 0),o.c([Object(L.c)()],t.prototype,"depthOfFieldDistance",void 0),o.c([Object(L.c)()],t.prototype,"depthOfFieldBlurWidth",void 0),o.c([Object(L.c)()],t.prototype,"motionStrength",void 0),o.c([Object(L.c)()],t.prototype,"_ratio",void 0),o.c([Object(L.c)()],t.prototype,"BloomEnabled",null),o.c([Object(L.c)()],t.prototype,"DepthOfFieldEnabled",null),o.c([Object(L.c)()],t.prototype,"LensFlareEnabled",null),o.c([Object(L.c)()],t.prototype,"HDREnabled",null),o.c([Object(L.c)()],t.prototype,"VLSEnabled",null),o.c([Object(L.c)()],t.prototype,"MotionBlurEnabled",null),o.c([Object(L.c)()],t.prototype,"fxaaEnabled",null),o.c([Object(L.c)()],t.prototype,"volumetricLightStepsCount",null),o.c([Object(L.c)()],t.prototype,"motionBlurSamples",null),o.c([Object(L.c)()],t.prototype,"samples",null),t}(z));j.a.RegisteredTypes["BABYLON.StandardRenderingPipeline"]=X;var Z=function(){function e(){this._renderPipelines={}}return e.prototype.addPipeline=function(e){this._renderPipelines[e._name]=e},e.prototype.attachCamerasToRenderPipeline=function(e,t,i){void 0===i&&(i=!1);var r=this._renderPipelines[e];r&&r._attachCameras(t,i)},e.prototype.detachCamerasFromRenderPipeline=function(e,t){var i=this._renderPipelines[e];i&&i._detachCameras(t)},e.prototype.enableEffectInPipeline=function(e,t,i){var r=this._renderPipelines[e];r&&r._enableEffect(t,i)},e.prototype.disableEffectInPipeline=function(e,t,i){var r=this._renderPipelines[e];r&&r._disableEffect(t,i)},e.prototype.update=function(){for(var e in this._renderPipelines)if(this._renderPipelines.hasOwnProperty(e)){var t=this._renderPipelines[e];t.isSupported?t._update():(t.dispose(),delete this._renderPipelines[e])}},e.prototype._rebuild=function(){for(var e in this._renderPipelines){if(this._renderPipelines.hasOwnProperty(e))this._renderPipelines[e]._rebuild()}},e.prototype.dispose=function(){for(var e in this._renderPipelines){if(this._renderPipelines.hasOwnProperty(e))this._renderPipelines[e].dispose()}},e}(),K=i(15),q=i(19);Object.defineProperty(q.Scene.prototype,"postProcessRenderPipelineManager",{get:function(){if(!this._postProcessRenderPipelineManager){var e=this._getComponent(K.a.NAME_POSTPROCESSRENDERPIPELINEMANAGER);e||(e=new ee(this),this._addComponent(e)),this._postProcessRenderPipelineManager=new Z}return this._postProcessRenderPipelineManager},enumerable:!0,configurable:!0});var $,ee=function(){function e(e){this.name=K.a.NAME_POSTPROCESSRENDERPIPELINEMANAGER,this.scene=e}return e.prototype.register=function(){this.scene._gatherRenderTargetsStage.registerStep(K.a.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER,this,this._gatherRenderTargets)},e.prototype.rebuild=function(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager._rebuild()},e.prototype.dispose=function(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.dispose()},e.prototype._gatherRenderTargets=function(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.update()},e}(),te=i(165);i(314);!function(e){e[e.Hable=0]="Hable",e[e.Reinhard=1]="Reinhard",e[e.HejiDawson=2]="HejiDawson",e[e.Photographic=3]="Photographic"}($||($={}));var ie=function(e){function t(t,i,r,n,o,s,a){void 0===o&&(o=u.a.TEXTURE_BILINEAR_SAMPLINGMODE),void 0===a&&(a=u.a.TEXTURETYPE_UNSIGNED_INT);var c=e.call(this,t,"tonemap",["_ExposureAdjustment"],null,1,n,o,s,!0,null,a)||this;c._operator=i,c.exposureAdjustment=r;var h="#define ";return c._operator===$.Hable?h+="HABLE_TONEMAPPING":c._operator===$.Reinhard?h+="REINHARD_TONEMAPPING":c._operator===$.HejiDawson?h+="OPTIMIZED_HEJIDAWSON_TONEMAPPING":c._operator===$.Photographic&&(h+="PHOTOGRAPHIC_TONEMAPPING"),c.updateEffect(h),c.onApply=function(e){e.setFloat("_ExposureAdjustment",c.exposureAdjustment)},c}return o.d(t,e),t}(s.a),re=i(3),ne=i(23),oe=i(10),se=i(14),ae=i(31),ce=i(39),he=(i(238),i(315),i(316),function(e){function t(i,r,n,o,s,a,c,h,u){void 0===s&&(s=100),void 0===a&&(a=_.a.BILINEAR_SAMPLINGMODE);var p=e.call(this,i,"volumetricLightScattering",["decay","exposure","weight","meshPositionOnScreen","density"],["lightScatteringSampler"],r.postProcessRatio||r,n,a,c,h,"#define NUM_SAMPLES "+s)||this;return p._screenCoordinates=l.Vector2.Zero(),p.customMeshPosition=l.Vector3.Zero(),p.useCustomMeshPosition=!1,p.invert=!0,p.excludedMeshes=new Array,p.exposure=.3,p.decay=.96815,p.weight=.58767,p.density=.926,c=(u=null===n?u:n.getScene()).getEngine(),p._viewPort=new l.Viewport(0,0,1,1).toGlobal(c.getRenderWidth(),c.getRenderHeight()),p.mesh=null!==o?o:t.CreateDefaultMesh("VolumetricLightScatteringMesh",u),p._createPass(u,r.passRatio||r),p.onActivate=function(e){p.isSupported||p.dispose(e),p.onActivate=null},p.onApplyObservable.add(function(e){p._updateMeshScreenCoordinates(u),e.setTexture("lightScatteringSampler",p._volumetricLightScatteringRTT),e.setFloat("exposure",p.exposure),e.setFloat("decay",p.decay),e.setFloat("weight",p.weight),e.setFloat("density",p.density),e.setVector2("meshPositionOnScreen",p._screenCoordinates)}),p}return o.d(t,e),Object.defineProperty(t.prototype,"useDiffuseColor",{get:function(){return y.a.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead"),!1},set:function(e){y.a.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead")},enumerable:!0,configurable:!0}),t.prototype.getClassName=function(){return"VolumetricLightScatteringPostProcess"},t.prototype._isReady=function(e,t){var i=e.getMesh();if(i===this.mesh&&i.material)return i.material.isReady(i);var r=[],n=[re.VertexBuffer.PositionKind],o=e.getMaterial();o&&(o.needAlphaTesting()&&r.push("#define ALPHATEST"),i.isVerticesDataPresent(re.VertexBuffer.UVKind)&&(n.push(re.VertexBuffer.UVKind),r.push("#define UV1")),i.isVerticesDataPresent(re.VertexBuffer.UV2Kind)&&(n.push(re.VertexBuffer.UV2Kind),r.push("#define UV2"))),i.useBones&&i.computeBonesUsingShaders?(n.push(re.VertexBuffer.MatricesIndicesKind),n.push(re.VertexBuffer.MatricesWeightsKind),r.push("#define NUM_BONE_INFLUENCERS "+i.numBoneInfluencers),r.push("#define BonesPerMesh "+(i.skeleton?i.skeleton.bones.length+1:0))):r.push("#define NUM_BONE_INFLUENCERS 0"),t&&(r.push("#define INSTANCES"),n.push("world0"),n.push("world1"),n.push("world2"),n.push("world3"));var s=r.join("\n");return this._cachedDefines!==s&&(this._cachedDefines=s,this._volumetricLightScatteringPass=i.getScene().getEngine().createEffect({vertexElement:"depth",fragmentElement:"volumetricLightScatteringPass"},n,["world","mBones","viewProjection","diffuseMatrix"],["diffuseSampler"],s)),this._volumetricLightScatteringPass.isReady()},t.prototype.setCustomMeshPosition=function(e){this.customMeshPosition=e},t.prototype.getCustomMeshPosition=function(){return this.customMeshPosition},t.prototype.dispose=function(t){var i=t.getScene().customRenderTargets.indexOf(this._volumetricLightScatteringRTT);-1!==i&&t.getScene().customRenderTargets.splice(i,1),this._volumetricLightScatteringRTT.dispose(),e.prototype.dispose.call(this,t)},t.prototype.getPass=function(){return this._volumetricLightScatteringRTT},t.prototype._meshExcluded=function(e){return this.excludedMeshes.length>0&&-1!==this.excludedMeshes.indexOf(e)},t.prototype._createPass=function(e,t){var i=this,r=e.getEngine();this._volumetricLightScatteringRTT=new ce.a("volumetricLightScatteringMap",{width:r.getRenderWidth()*t,height:r.getRenderHeight()*t},e,!1,!0,u.a.TEXTURETYPE_UNSIGNED_INT),this._volumetricLightScatteringRTT.wrapU=_.a.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.wrapV=_.a.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.renderList=null,this._volumetricLightScatteringRTT.renderParticles=!1,this._volumetricLightScatteringRTT.ignoreCameraViewport=!0;var n=this.getCamera();n?n.customRenderTargets.push(this._volumetricLightScatteringRTT):e.customRenderTargets.push(this._volumetricLightScatteringRTT);var o,s=function(e){var t=e.getRenderingMesh();if(!i._meshExcluded(t)){var r=e.getMaterial();if(r){var n=t.getScene(),o=n.getEngine();o.setState(r.backFaceCulling);var s=t._getInstancesRenderList(e._id);if(!s.mustReturn){var a=o.getCaps().instancedArrays&&null!==s.visibleInstances[e._id];if(i._isReady(e,a)){var c=i._volumetricLightScatteringPass;if(t===i.mesh&&(c=e.effect?e.effect:r.getEffect()),o.enableEffect(c),t._bind(e,c,se.a.TriangleFillMode),t===i.mesh)r.bind(t.getWorldMatrix(),t);else{if(i._volumetricLightScatteringPass.setMatrix("viewProjection",n.getTransformMatrix()),r&&r.needAlphaTesting()){var h=r.getAlphaTestTexture();i._volumetricLightScatteringPass.setTexture("diffuseSampler",h),h&&i._volumetricLightScatteringPass.setMatrix("diffuseMatrix",h.getTextureMatrix())}t.useBones&&t.computeBonesUsingShaders&&t.skeleton&&i._volumetricLightScatteringPass.setMatrices("mBones",t.skeleton.getTransformMatrices(t))}t._processRendering(e,i._volumetricLightScatteringPass,se.a.TriangleFillMode,s,a,function(e,t){return c.setMatrix("world",t)})}}}}},a=new l.Color4(0,0,0,1);this._volumetricLightScatteringRTT.onBeforeRenderObservable.add(function(){o=e.clearColor,e.clearColor=a}),this._volumetricLightScatteringRTT.onAfterRenderObservable.add(function(){e.clearColor=o}),this._volumetricLightScatteringRTT.customRenderFunction=function(t,i,r,n){var o,a=e.getEngine();if(n.length){for(a.setColorWrite(!1),o=0;o<n.length;o++)s(n.data[o]);a.setColorWrite(!0)}for(o=0;o<t.length;o++)s(t.data[o]);for(o=0;o<i.length;o++)s(i.data[o]);if(r.length){for(o=0;o<r.length;o++){var c=r.data[o],h=c.getBoundingInfo();h&&e.activeCamera&&(c._alphaIndex=c.getMesh().alphaIndex,c._distanceToCamera=h.boundingSphere.centerWorld.subtract(e.activeCamera.position).length())}var l=r.data.slice(0,r.length);for(l.sort(function(e,t){return e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0}),a.setAlphaMode(u.a.ALPHA_COMBINE),o=0;o<l.length;o++)s(l[o]);a.setAlphaMode(u.a.ALPHA_DISABLE)}}},t.prototype._updateMeshScreenCoordinates=function(e){var t,i=e.getTransformMatrix();t=this.useCustomMeshPosition?this.customMeshPosition:this.attachedNode?this.attachedNode.position:this.mesh.parent?this.mesh.getAbsolutePosition():this.mesh.position;var r=l.Vector3.Project(t,l.Matrix.Identity(),i,this._viewPort);this._screenCoordinates.x=r.x/this._viewPort.width,this._screenCoordinates.y=r.y/this._viewPort.height,this.invert&&(this._screenCoordinates.y=1-this._screenCoordinates.y)},t.CreateDefaultMesh=function(e,t){var i=oe.Mesh.CreatePlane(e,1,t);i.billboardMode=ne.a.BILLBOARDMODE_ALL;var r=new ae.StandardMaterial(e+"Material",t);return r.emissiveColor=new l.Color3(1,1,1),i.material=r,i},o.c([Object(L.n)()],t.prototype,"customMeshPosition",void 0),o.c([Object(L.c)()],t.prototype,"useCustomMeshPosition",void 0),o.c([Object(L.c)()],t.prototype,"invert",void 0),o.c([Object(L.j)()],t.prototype,"mesh",void 0),o.c([Object(L.c)()],t.prototype,"excludedMeshes",void 0),o.c([Object(L.c)()],t.prototype,"exposure",void 0),o.c([Object(L.c)()],t.prototype,"decay",void 0),o.c([Object(L.c)()],t.prototype,"weight",void 0),o.c([Object(L.c)()],t.prototype,"density",void 0),t}(s.a)),le=i(146);i.d(t,"a",function(){return n.a}),i.d(t,"b",function(){return a}),i.d(t,"c",function(){return m}),i.d(t,"d",function(){return f}),i.d(t,"e",function(){return d.a}),i.d(t,"f",function(){return g}),i.d(t,"g",function(){return P}),i.d(t,"h",function(){return b}),i.d(t,"i",function(){return v}),i.d(t,"k",function(){return S}),i.d(t,"m",function(){return r}),i.d(t,"l",function(){return T}),i.d(t,"o",function(){return E}),i.d(t,"n",function(){return x}),i.d(t,"p",function(){return A}),i.d(t,"q",function(){return p}),i.d(t,"r",function(){return R}),i.d(t,"s",function(){return C.a}),i.d(t,"t",function(){return O}),i.d(t,"u",function(){return B}),i.d(t,"v",function(){return I.a}),i.d(t,"x",function(){return F}),i.d(t,"z",function(){return G.b}),i.d(t,"y",function(){return G.a}),i.d(t,"A",function(){return s.a}),i.d(t,"B",function(){return M.a}),i.d(t,"G",function(){return w}),i.d(t,"C",function(){return h}),i.d(t,"D",function(){return z}),i.d(t,"E",function(){return Z}),i.d(t,"F",function(){return ee}),i.d(t,"j",function(){return U}),i.d(t,"w",function(){return H}),i.d(t,"H",function(){return Q}),i.d(t,"I",function(){return J}),i.d(t,"K",function(){return X}),i.d(t,"J",function(){return N}),i.d(t,"L",function(){return te.a}),i.d(t,"N",function(){return $}),i.d(t,"M",function(){return ie}),i.d(t,"P",function(){return he}),i.d(t,"O",function(){return le.a})},246:function(e,t,i){"use strict";var r,n=i(0),o=i(40),s=i(41),a=i(12),c=function(){function e(){this.direction1=new n.Vector3(0,1,0),this.direction2=new n.Vector3(0,1,0),this.minEmitBox=new n.Vector3(-.5,-.5,-.5),this.maxEmitBox=new n.Vector3(.5,.5,.5)}return e.prototype.startDirectionFunction=function(e,t,i){var r=a.a.RandomRange(this.direction1.x,this.direction2.x),o=a.a.RandomRange(this.direction1.y,this.direction2.y),s=a.a.RandomRange(this.direction1.z,this.direction2.z);n.Vector3.TransformNormalFromFloatsToRef(r,o,s,e,t)},e.prototype.startPositionFunction=function(e,t,i){var r=a.a.RandomRange(this.minEmitBox.x,this.maxEmitBox.x),o=a.a.RandomRange(this.minEmitBox.y,this.maxEmitBox.y),s=a.a.RandomRange(this.minEmitBox.z,this.maxEmitBox.z);n.Vector3.TransformCoordinatesFromFloatsToRef(r,o,s,e,t)},e.prototype.clone=function(){var t=new e;return s.a.DeepCopy(this,t),t},e.prototype.applyToShader=function(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2),e.setVector3("minEmitBox",this.minEmitBox),e.setVector3("maxEmitBox",this.maxEmitBox)},e.prototype.getEffectDefines=function(){return"#define BOXEMITTER"},e.prototype.getClassName=function(){return"BoxParticleEmitter"},e.prototype.serialize=function(){var e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.minEmitBox=this.minEmitBox.asArray(),e.maxEmitBox=this.maxEmitBox.asArray(),e},e.prototype.parse=function(e){n.Vector3.FromArrayToRef(e.direction1,0,this.direction1),n.Vector3.FromArrayToRef(e.direction2,0,this.direction2),n.Vector3.FromArrayToRef(e.minEmitBox,0,this.minEmitBox),n.Vector3.FromArrayToRef(e.maxEmitBox,0,this.maxEmitBox)},e}(),h=function(){function e(e,t,i){void 0===e&&(e=1),void 0===t&&(t=Math.PI),void 0===i&&(i=0),this.directionRandomizer=i,this.radiusRange=1,this.heightRange=1,this.emitFromSpawnPointOnly=!1,this.angle=t,this.radius=e}return Object.defineProperty(e.prototype,"radius",{get:function(){return this._radius},set:function(e){this._radius=e,this._buildHeight()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"angle",{get:function(){return this._angle},set:function(e){this._angle=e,this._buildHeight()},enumerable:!0,configurable:!0}),e.prototype._buildHeight=function(){0!==this._angle?this._height=this._radius/Math.tan(this._angle/2):this._height=1},e.prototype.startDirectionFunction=function(e,t,i){if(1===Math.abs(Math.cos(this._angle)))n.Vector3.TransformNormalFromFloatsToRef(0,1,0,e,t);else{var r=i.position.subtract(e.getTranslation()).normalize(),o=a.a.RandomRange(0,this.directionRandomizer),s=a.a.RandomRange(0,this.directionRandomizer),c=a.a.RandomRange(0,this.directionRandomizer);r.x+=o,r.y+=s,r.z+=c,r.normalize(),n.Vector3.TransformNormalFromFloatsToRef(r.x,r.y,r.z,e,t)}},e.prototype.startPositionFunction=function(e,t,i){var r,o=a.a.RandomRange(0,2*Math.PI);r=this.emitFromSpawnPointOnly?1e-4:1-(r=a.a.RandomRange(0,this.heightRange))*r;var s=this._radius-a.a.RandomRange(0,this._radius*this.radiusRange),c=(s*=r)*Math.sin(o),h=s*Math.cos(o),l=r*this._height;n.Vector3.TransformCoordinatesFromFloatsToRef(c,l,h,e,t)},e.prototype.clone=function(){var t=new e(this._radius,this._angle,this.directionRandomizer);return s.a.DeepCopy(this,t),t},e.prototype.applyToShader=function(e){e.setFloat2("radius",this._radius,this.radiusRange),e.setFloat("coneAngle",this._angle),e.setFloat2("height",this._height,this.heightRange),e.setFloat("directionRandomizer",this.directionRandomizer)},e.prototype.getEffectDefines=function(){var e="#define CONEEMITTER";return this.emitFromSpawnPointOnly&&(e+="\n#define CONEEMITTERSPAWNPOINT"),e},e.prototype.getClassName=function(){return"ConeParticleEmitter"},e.prototype.serialize=function(){var e={};return e.type=this.getClassName(),e.radius=this._radius,e.angle=this._angle,e.directionRandomizer=this.directionRandomizer,e},e.prototype.parse=function(e){this.radius=e.radius,this.angle=e.angle,this.directionRandomizer=e.directionRandomizer},e}(),l=i(1),u=function(){function e(e,t,i,r){void 0===e&&(e=1),void 0===t&&(t=1),void 0===i&&(i=1),void 0===r&&(r=0),this.radius=e,this.height=t,this.radiusRange=i,this.directionRandomizer=r}return e.prototype.startDirectionFunction=function(e,t,i){var r=i.position.subtract(e.getTranslation()).normalize(),o=a.a.RandomRange(-this.directionRandomizer/2,this.directionRandomizer/2),s=Math.atan2(r.x,r.z);s+=a.a.RandomRange(-Math.PI/2,Math.PI/2)*this.directionRandomizer,r.y=o,r.x=Math.sin(s),r.z=Math.cos(s),r.normalize(),n.Vector3.TransformNormalFromFloatsToRef(r.x,r.y,r.z,e,t)},e.prototype.startPositionFunction=function(e,t,i){var r=a.a.RandomRange(-this.height/2,this.height/2),o=a.a.RandomRange(0,2*Math.PI),s=a.a.RandomRange((1-this.radiusRange)*(1-this.radiusRange),1),c=Math.sqrt(s)*this.radius,h=c*Math.cos(o),l=c*Math.sin(o);n.Vector3.TransformCoordinatesFromFloatsToRef(h,r,l,e,t)},e.prototype.clone=function(){var t=new e(this.radius,this.directionRandomizer);return s.a.DeepCopy(this,t),t},e.prototype.applyToShader=function(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)},e.prototype.getEffectDefines=function(){return"#define CYLINDEREMITTER"},e.prototype.getClassName=function(){return"CylinderParticleEmitter"},e.prototype.serialize=function(){var e={};return e.type=this.getClassName(),e.radius=this.radius,e.height=this.height,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e},e.prototype.parse=function(e){this.radius=e.radius,this.height=e.height,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer},e}(),p=function(e){function t(t,i,r,o,s){void 0===t&&(t=1),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=new n.Vector3(0,1,0)),void 0===s&&(s=new n.Vector3(0,1,0));var a=e.call(this,t,i,r)||this;return a.direction1=o,a.direction2=s,a}return l.d(t,e),t.prototype.startDirectionFunction=function(e,t,i){var r=a.a.RandomRange(this.direction1.x,this.direction2.x),o=a.a.RandomRange(this.direction1.y,this.direction2.y),s=a.a.RandomRange(this.direction1.z,this.direction2.z);n.Vector3.TransformNormalFromFloatsToRef(r,o,s,e,t)},t.prototype.clone=function(){var e=new t(this.radius,this.height,this.radiusRange,this.direction1,this.direction2);return s.a.DeepCopy(this,e),e},t.prototype.applyToShader=function(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)},t.prototype.getEffectDefines=function(){return"#define CYLINDEREMITTER\n#define DIRECTEDCYLINDEREMITTER"},t.prototype.getClassName=function(){return"CylinderDirectedParticleEmitter"},t.prototype.serialize=function(){var t=e.prototype.serialize.call(this);return t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t},t.prototype.parse=function(t){e.prototype.parse.call(this,t),this.direction1.copyFrom(t.direction1),this.direction2.copyFrom(t.direction2)},t}(u),d=function(){function e(e,t,i){void 0===e&&(e=1),void 0===t&&(t=1),void 0===i&&(i=0),this.radius=e,this.radiusRange=t,this.directionRandomizer=i}return e.prototype.startDirectionFunction=function(e,t,i){var r=i.position.subtract(e.getTranslation()).normalize(),o=a.a.RandomRange(0,this.directionRandomizer),s=a.a.RandomRange(0,this.directionRandomizer),c=a.a.RandomRange(0,this.directionRandomizer);r.x+=o,r.y+=s,r.z+=c,r.normalize(),n.Vector3.TransformNormalFromFloatsToRef(r.x,r.y,r.z,e,t)},e.prototype.startPositionFunction=function(e,t,i){var r=this.radius-a.a.RandomRange(0,this.radius*this.radiusRange),o=a.a.RandomRange(0,1),s=a.a.RandomRange(0,2*Math.PI),c=Math.acos(2*o-1),h=r*Math.cos(s)*Math.sin(c),l=r*Math.cos(c),u=r*Math.sin(s)*Math.sin(c);n.Vector3.TransformCoordinatesFromFloatsToRef(h,Math.abs(l),u,e,t)},e.prototype.clone=function(){var t=new e(this.radius,this.directionRandomizer);return s.a.DeepCopy(this,t),t},e.prototype.applyToShader=function(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)},e.prototype.getEffectDefines=function(){return"#define HEMISPHERICEMITTER"},e.prototype.getClassName=function(){return"HemisphericParticleEmitter"},e.prototype.serialize=function(){var e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e},e.prototype.parse=function(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer},e}(),f=function(){function e(){this.direction1=new n.Vector3(0,1,0),this.direction2=new n.Vector3(0,1,0)}return e.prototype.startDirectionFunction=function(e,t,i){var r=a.a.RandomRange(this.direction1.x,this.direction2.x),o=a.a.RandomRange(this.direction1.y,this.direction2.y),s=a.a.RandomRange(this.direction1.z,this.direction2.z);n.Vector3.TransformNormalFromFloatsToRef(r,o,s,e,t)},e.prototype.startPositionFunction=function(e,t,i){n.Vector3.TransformCoordinatesFromFloatsToRef(0,0,0,e,t)},e.prototype.clone=function(){var t=new e;return s.a.DeepCopy(this,t),t},e.prototype.applyToShader=function(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)},e.prototype.getEffectDefines=function(){return"#define POINTEMITTER"},e.prototype.getClassName=function(){return"PointParticleEmitter"},e.prototype.serialize=function(){var e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e},e.prototype.parse=function(e){n.Vector3.FromArrayToRef(e.direction1,0,this.direction1),n.Vector3.FromArrayToRef(e.direction2,0,this.direction2)},e}(),_=function(){function e(e,t,i){void 0===e&&(e=1),void 0===t&&(t=1),void 0===i&&(i=0),this.radius=e,this.radiusRange=t,this.directionRandomizer=i}return e.prototype.startDirectionFunction=function(e,t,i){var r=i.position.subtract(e.getTranslation()).normalize(),o=a.a.RandomRange(0,this.directionRandomizer),s=a.a.RandomRange(0,this.directionRandomizer),c=a.a.RandomRange(0,this.directionRandomizer);r.x+=o,r.y+=s,r.z+=c,r.normalize(),n.Vector3.TransformNormalFromFloatsToRef(r.x,r.y,r.z,e,t)},e.prototype.startPositionFunction=function(e,t,i){var r=this.radius-a.a.RandomRange(0,this.radius*this.radiusRange),o=a.a.RandomRange(0,1),s=a.a.RandomRange(0,2*Math.PI),c=Math.acos(2*o-1),h=r*Math.cos(s)*Math.sin(c),l=r*Math.cos(c),u=r*Math.sin(s)*Math.sin(c);n.Vector3.TransformCoordinatesFromFloatsToRef(h,l,u,e,t)},e.prototype.clone=function(){var t=new e(this.radius,this.directionRandomizer);return s.a.DeepCopy(this,t),t},e.prototype.applyToShader=function(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)},e.prototype.getEffectDefines=function(){return"#define SPHEREEMITTER"},e.prototype.getClassName=function(){return"SphereParticleEmitter"},e.prototype.serialize=function(){var e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e},e.prototype.parse=function(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer},e}(),m=function(e){function t(t,i,r){void 0===t&&(t=1),void 0===i&&(i=new n.Vector3(0,1,0)),void 0===r&&(r=new n.Vector3(0,1,0));var o=e.call(this,t)||this;return o.direction1=i,o.direction2=r,o}return l.d(t,e),t.prototype.startDirectionFunction=function(e,t,i){var r=a.a.RandomRange(this.direction1.x,this.direction2.x),o=a.a.RandomRange(this.direction1.y,this.direction2.y),s=a.a.RandomRange(this.direction1.z,this.direction2.z);n.Vector3.TransformNormalFromFloatsToRef(r,o,s,e,t)},t.prototype.clone=function(){var e=new t(this.radius,this.direction1,this.direction2);return s.a.DeepCopy(this,e),e},t.prototype.applyToShader=function(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)},t.prototype.getEffectDefines=function(){return"#define SPHEREEMITTER\n#define DIRECTEDSPHEREEMITTER"},t.prototype.getClassName=function(){return"SphereDirectedParticleEmitter"},t.prototype.serialize=function(){var t=e.prototype.serialize.call(this);return t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t},t.prototype.parse=function(t){e.prototype.parse.call(this,t),this.direction1.copyFrom(t.direction1),this.direction2.copyFrom(t.direction2)},t}(_),g=i(4),y=function(){function e(t){this.animations=[],this.renderingGroupId=0,this.emitter=null,this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this.noiseStrength=new n.Vector3(10,10,10),this.onAnimationEnd=null,this.blendMode=e.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteRandomStartCell=!1,this.translationPivot=new n.Vector2(0,0),this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.gravity=n.Vector3.Zero(),this._colorGradients=null,this._sizeGradients=null,this._lifeTimeGradients=null,this._angularSpeedGradients=null,this._velocityGradients=null,this._limitVelocityGradients=null,this._dragGradients=null,this._emitRateGradients=null,this._startSizeGradients=null,this._rampGradients=null,this._colorRemapGradients=null,this._alphaRemapGradients=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new n.Color4(1,1,1,1),this.color2=new n.Color4(1,1,1,1),this.colorDead=new n.Color4(0,0,0,1),this.textureMask=new n.Color4(1,1,1,1),this._isSubEmitter=!1,this.billboardMode=g.a.PARTICLES_BILLBOARDMODE_ALL,this._isBillboardBased=!0,this._imageProcessingConfigurationDefines=new o.b,this.id=t,this.name=t}return Object.defineProperty(e.prototype,"noiseTexture",{get:function(){return this._noiseTexture},set:function(e){this._noiseTexture!==e&&(this._noiseTexture=e,this._reset())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isAnimationSheetEnabled",{get:function(){return this._isAnimationSheetEnabled},set:function(e){this._isAnimationSheetEnabled!=e&&(this._isAnimationSheetEnabled=e,this._reset())},enumerable:!0,configurable:!0}),e.prototype.getScene=function(){return this._scene},e.prototype._hasTargetStopDurationDependantGradient=function(){return this._startSizeGradients&&this._startSizeGradients.length>0||this._emitRateGradients&&this._emitRateGradients.length>0||this._lifeTimeGradients&&this._lifeTimeGradients.length>0},e.prototype.getDragGradients=function(){return this._dragGradients},e.prototype.getLimitVelocityGradients=function(){return this._limitVelocityGradients},e.prototype.getColorGradients=function(){return this._colorGradients},e.prototype.getSizeGradients=function(){return this._sizeGradients},e.prototype.getColorRemapGradients=function(){return this._colorRemapGradients},e.prototype.getAlphaRemapGradients=function(){return this._alphaRemapGradients},e.prototype.getLifeTimeGradients=function(){return this._lifeTimeGradients},e.prototype.getAngularSpeedGradients=function(){return this._angularSpeedGradients},e.prototype.getVelocityGradients=function(){return this._velocityGradients},e.prototype.getStartSizeGradients=function(){return this._startSizeGradients},e.prototype.getEmitRateGradients=function(){return this._emitRateGradients},Object.defineProperty(e.prototype,"direction1",{get:function(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:n.Vector3.Zero()},set:function(e){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"direction2",{get:function(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:n.Vector3.Zero()},set:function(e){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"minEmitBox",{get:function(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:n.Vector3.Zero()},set:function(e){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"maxEmitBox",{get:function(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:n.Vector3.Zero()},set:function(e){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isBillboardBased",{get:function(){return this._isBillboardBased},set:function(e){this._isBillboardBased!==e&&(this._isBillboardBased=e,this._reset())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(e){this._attachImageProcessingConfiguration(e)},enumerable:!0,configurable:!0}),e.prototype._attachImageProcessingConfiguration=function(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration=e||this._scene.imageProcessingConfiguration)},e.prototype._reset=function(){},e.prototype._removeGradientAndTexture=function(e,t,i){if(!t)return this;for(var r=0,n=0,o=t;n<o.length;n++){if(o[n].gradient===e){t.splice(r,1);break}r++}return i&&i.dispose(),this},e.prototype.createPointEmitter=function(e,t){var i=new f;return i.direction1=e,i.direction2=t,this.particleEmitterType=i,i},e.prototype.createHemisphericEmitter=function(e,t){void 0===e&&(e=1),void 0===t&&(t=1);var i=new d(e,t);return this.particleEmitterType=i,i},e.prototype.createSphereEmitter=function(e,t){void 0===e&&(e=1),void 0===t&&(t=1);var i=new _(e,t);return this.particleEmitterType=i,i},e.prototype.createDirectedSphereEmitter=function(e,t,i){void 0===e&&(e=1),void 0===t&&(t=new n.Vector3(0,1,0)),void 0===i&&(i=new n.Vector3(0,1,0));var r=new m(e,t,i);return this.particleEmitterType=r,r},e.prototype.createCylinderEmitter=function(e,t,i,r){void 0===e&&(e=1),void 0===t&&(t=1),void 0===i&&(i=1),void 0===r&&(r=0);var n=new u(e,t,i,r);return this.particleEmitterType=n,n},e.prototype.createDirectedCylinderEmitter=function(e,t,i,r,o){void 0===e&&(e=1),void 0===t&&(t=1),void 0===i&&(i=1),void 0===r&&(r=new n.Vector3(0,1,0)),void 0===o&&(o=new n.Vector3(0,1,0));var s=new p(e,t,i,r,o);return this.particleEmitterType=s,s},e.prototype.createConeEmitter=function(e,t){void 0===e&&(e=1),void 0===t&&(t=Math.PI/4);var i=new h(e,t);return this.particleEmitterType=i,i},e.prototype.createBoxEmitter=function(e,t,i,r){var n=new c;return this.particleEmitterType=n,this.direction1=e,this.direction2=t,this.minEmitBox=i,this.maxEmitBox=r,n},e.BLENDMODE_ONEONE=0,e.BLENDMODE_STANDARD=1,e.BLENDMODE_ADD=2,e.BLENDMODE_MULTIPLY=3,e.BLENDMODE_MULTIPLYADD=4,e}(),P=i(5),b=i(7),v=i(3),S=i(23),E=i(14),x=i(17),T=i(6),A=i(72),R=i(91),C=i(21),O=i(16),B=function(){function e(t){this.particleSystem=t,this.position=n.Vector3.Zero(),this.direction=n.Vector3.Zero(),this.color=new n.Color4(0,0,0,0),this.colorStep=new n.Color4(0,0,0,0),this.lifeTime=1,this.age=0,this.size=0,this.scale=new n.Vector2(1,1),this.angle=0,this.angularSpeed=0,this.cellIndex=0,this._attachedSubEmitters=null,this._currentColor1=new n.Color4(0,0,0,0),this._currentColor2=new n.Color4(0,0,0,0),this._currentSize1=0,this._currentSize2=0,this._currentAngularSpeed1=0,this._currentAngularSpeed2=0,this._currentVelocity1=0,this._currentVelocity2=0,this._currentLimitVelocity1=0,this._currentLimitVelocity2=0,this._currentDrag1=0,this._currentDrag2=0,this.id=e._Count++,this.particleSystem.isAnimationSheetEnabled&&this.updateCellInfoFromSystem()}return e.prototype.updateCellInfoFromSystem=function(){this.cellIndex=this.particleSystem.startSpriteCellID},e.prototype.updateCellIndex=function(){var e=this.age,t=this.particleSystem.spriteCellChangeSpeed;this.particleSystem.spriteRandomStartCell&&(void 0===this._randomCellOffset&&(this._randomCellOffset=Math.random()*this.lifeTime),0===t?(t=1,e=this._randomCellOffset):e+=this._randomCellOffset);var i=this._initialEndSpriteCellID-this._initialStartSpriteCellID,r=a.a.Clamp(e*t%this.lifeTime/this.lifeTime);this.cellIndex=this._initialStartSpriteCellID+r*i|0},e.prototype._inheritParticleInfoToSubEmitter=function(e){if(e.particleSystem.emitter.position){var t=e.particleSystem.emitter;t.position.copyFrom(this.position),e.inheritDirection&&(t.position.subtractToRef(this.direction,n.Tmp.Vector3[0]),t.lookAt(n.Tmp.Vector3[0],0,Math.PI/2))}else{e.particleSystem.emitter.copyFrom(this.position)}this.direction.scaleToRef(e.inheritedVelocityAmount/2,n.Tmp.Vector3[0]),e.particleSystem._inheritedVelocityOffset.copyFrom(n.Tmp.Vector3[0])},e.prototype._inheritParticleInfoToSubEmitters=function(){var e=this;this._attachedSubEmitters&&this._attachedSubEmitters.length>0&&this._attachedSubEmitters.forEach(function(t){e._inheritParticleInfoToSubEmitter(t)})},e.prototype._reset=function(){this.age=0,this._currentColorGradient=null,this._currentSizeGradient=null,this._currentAngularSpeedGradient=null,this._currentVelocityGradient=null,this._currentLimitVelocityGradient=null,this._currentDragGradient=null,this.cellIndex=this.particleSystem.startSpriteCellID,this._randomCellOffset=void 0},e.prototype.copyTo=function(e){e.position.copyFrom(this.position),this._initialDirection?e._initialDirection?e._initialDirection.copyFrom(this._initialDirection):e._initialDirection=this._initialDirection.clone():e._initialDirection=null,e.direction.copyFrom(this.direction),e.color.copyFrom(this.color),e.colorStep.copyFrom(this.colorStep),e.lifeTime=this.lifeTime,e.age=this.age,e._randomCellOffset=this._randomCellOffset,e.size=this.size,e.scale.copyFrom(this.scale),e.angle=this.angle,e.angularSpeed=this.angularSpeed,e.particleSystem=this.particleSystem,e.cellIndex=this.cellIndex,e.id=this.id,e._attachedSubEmitters=this._attachedSubEmitters,this._currentColorGradient&&(e._currentColorGradient=this._currentColorGradient,e._currentColor1.copyFrom(this._currentColor1),e._currentColor2.copyFrom(this._currentColor2)),this._currentSizeGradient&&(e._currentSizeGradient=this._currentSizeGradient,e._currentSize1=this._currentSize1,e._currentSize2=this._currentSize2),this._currentAngularSpeedGradient&&(e._currentAngularSpeedGradient=this._currentAngularSpeedGradient,e._currentAngularSpeed1=this._currentAngularSpeed1,e._currentAngularSpeed2=this._currentAngularSpeed2),this._currentVelocityGradient&&(e._currentVelocityGradient=this._currentVelocityGradient,e._currentVelocity1=this._currentVelocity1,e._currentVelocity2=this._currentVelocity2),this._currentLimitVelocityGradient&&(e._currentLimitVelocityGradient=this._currentLimitVelocityGradient,e._currentLimitVelocity1=this._currentLimitVelocity1,e._currentLimitVelocity2=this._currentLimitVelocity2),this._currentDragGradient&&(e._currentDragGradient=this._currentDragGradient,e._currentDrag1=this._currentDrag1,e._currentDrag2=this._currentDrag2),this.particleSystem.isAnimationSheetEnabled&&(e._initialStartSpriteCellID=this._initialStartSpriteCellID,e._initialEndSpriteCellID=this._initialEndSpriteCellID),this.particleSystem.useRampGradients&&e.remapData.copyFrom(this.remapData),this._randomNoiseCoordinates1&&(e._randomNoiseCoordinates1?(e._randomNoiseCoordinates1.copyFrom(this._randomNoiseCoordinates1),e._randomNoiseCoordinates2.copyFrom(this._randomNoiseCoordinates2)):(e._randomNoiseCoordinates1=this._randomNoiseCoordinates1.clone(),e._randomNoiseCoordinates2=this._randomNoiseCoordinates2.clone()))},e._Count=0,e}(),I=i(10);!function(e){e[e.ATTACHED=0]="ATTACHED",e[e.END=1]="END"}(r||(r={}));var D=function(){function e(e){this.particleSystem=e,this.type=r.END,this.inheritDirection=!1,this.inheritedVelocityAmount=0,e.emitter&&e.emitter.dispose||(e.emitter=new S.a("SubemitterSystemEmitter",e.getScene())),e.onDisposeObservable.add(function(){e.emitter&&e.emitter.dispose&&e.emitter.dispose()})}return e.prototype.clone=function(){var t=this.particleSystem.emitter;t?t instanceof n.Vector3?t=t.clone():t instanceof S.a&&((t=new I.Mesh("",t.getScene())).isVisible=!1):t=new n.Vector3;var i=new e(this.particleSystem.clone("",t));return i.type=this.type,i.inheritDirection=this.inheritDirection,i.inheritedVelocityAmount=this.inheritedVelocityAmount,i.particleSystem._disposeEmitterOnDispose=!0,i.particleSystem.disposeOnStop=!0,i},e.prototype.serialize=function(){var e={};return e.type=this.type,e.inheritDirection=this.inheritDirection,e.inheritedVelocityAmount=this.inheritedVelocityAmount,e.particleSystem=this.particleSystem.serialize(),e},e._ParseParticleSystem=function(e,t,i){throw"Import ParseParticle before parsing SubEmitter."},e.Parse=function(t,i,r){var n=t.particleSystem,o=new e(e._ParseParticleSystem(n,i,r));return o.type=t.type,o.inheritDirection=t.inheritDirection,o.inheritedVelocityAmount=t.inheritedVelocityAmount,o.particleSystem._isSubEmitter=!0,o},e.prototype.dispose=function(){this.particleSystem.dispose()},e}(),F=i(2),G=(i(290),i(235),function(e){function t(t,i,o,s,h,l){void 0===s&&(s=null),void 0===h&&(h=!1),void 0===l&&(l=.01);var u=e.call(this,t)||this;return u._inheritedVelocityOffset=new n.Vector3,u.onDisposeObservable=new b.c,u._particles=new Array,u._stockParticles=new Array,u._newPartsExcess=0,u._vertexBuffers={},u._scaledColorStep=new n.Color4(0,0,0,0),u._colorDiff=new n.Color4(0,0,0,0),u._scaledDirection=n.Vector3.Zero(),u._scaledGravity=n.Vector3.Zero(),u._currentRenderId=-1,u._useInstancing=!1,u._started=!1,u._stopped=!1,u._actualFrame=0,u._currentEmitRate1=0,u._currentEmitRate2=0,u._currentStartSize1=0,u._currentStartSize2=0,u._rawTextureWidth=256,u._useRampGradients=!1,u._disposeEmitterOnDispose=!1,u.recycleParticle=function(e){var t=u._particles.pop();t!==e&&t.copyTo(e),u._stockParticles.push(t)},u._createParticle=function(){var e;if(0!==u._stockParticles.length?(e=u._stockParticles.pop())._reset():e=new B(u),u._subEmitters&&u._subEmitters.length>0){var t=u._subEmitters[Math.floor(Math.random()*u._subEmitters.length)];e._attachedSubEmitters=[],t.forEach(function(t){if(t.type===r.ATTACHED){var i=t.clone();e._attachedSubEmitters.push(i),i.particleSystem.start()}})}return e},u._emitFromParticle=function(e){if(u._subEmitters&&0!==u._subEmitters.length){var t=Math.floor(Math.random()*u._subEmitters.length);u._subEmitters[t].forEach(function(t){if(t.type===r.END){var i=t.clone();e._inheritParticleInfoToSubEmitter(i),i.particleSystem._rootParticleSystem=u,u.activeSubSystems.push(i.particleSystem),i.particleSystem.start()}})}},u._capacity=i,u._epsilon=l,u._isAnimationSheetEnabled=h,u._scene=o||C.a.LastCreatedScene,u._attachImageProcessingConfiguration(null),u._customEffect=s,u._scene.particleSystems.push(u),u._useInstancing=u._scene.getEngine().getCaps().instancedArrays,u._createIndexBuffer(),u._createVertexBuffers(),u.particleEmitterType=new c,u.updateFunction=function(e){var t=null,i=null;u.noiseTexture&&(t=u.noiseTexture.getSize(),i=u.noiseTexture.getContent());for(var r,o=function(){r=e[s];var o=u._scaledUpdateSpeed,c=r.age;if(r.age+=o,r.age>r.lifeTime){var h=r.age-c;o=(r.lifeTime-c)*o/h,r.age=r.lifeTime}var l=r.age/r.lifeTime;u._colorGradients&&u._colorGradients.length>0?P.h.GetCurrentGradient(l,u._colorGradients,function(e,t,i){e!==r._currentColorGradient&&(r._currentColor1.copyFrom(r._currentColor2),t.getColorToRef(r._currentColor2),r._currentColorGradient=e),n.Color4.LerpToRef(r._currentColor1,r._currentColor2,i,r.color)}):(r.colorStep.scaleToRef(o,u._scaledColorStep),r.color.addInPlace(u._scaledColorStep),r.color.a<0&&(r.color.a=0)),u._angularSpeedGradients&&u._angularSpeedGradients.length>0&&P.h.GetCurrentGradient(l,u._angularSpeedGradients,function(e,t,i){e!==r._currentAngularSpeedGradient&&(r._currentAngularSpeed1=r._currentAngularSpeed2,r._currentAngularSpeed2=t.getFactor(),r._currentAngularSpeedGradient=e),r.angularSpeed=a.a.Lerp(r._currentAngularSpeed1,r._currentAngularSpeed2,i)}),r.angle+=r.angularSpeed*o;var p=o;if(u._velocityGradients&&u._velocityGradients.length>0&&P.h.GetCurrentGradient(l,u._velocityGradients,function(e,t,i){e!==r._currentVelocityGradient&&(r._currentVelocity1=r._currentVelocity2,r._currentVelocity2=t.getFactor(),r._currentVelocityGradient=e),p*=a.a.Lerp(r._currentVelocity1,r._currentVelocity2,i)}),r.direction.scaleToRef(p,u._scaledDirection),u._limitVelocityGradients&&u._limitVelocityGradients.length>0&&P.h.GetCurrentGradient(l,u._limitVelocityGradients,function(e,t,i){e!==r._currentLimitVelocityGradient&&(r._currentLimitVelocity1=r._currentLimitVelocity2,r._currentLimitVelocity2=t.getFactor(),r._currentLimitVelocityGradient=e);var n=a.a.Lerp(r._currentLimitVelocity1,r._currentLimitVelocity2,i);r.direction.length()>n&&r.direction.scaleInPlace(u.limitVelocityDamping)}),u._dragGradients&&u._dragGradients.length>0&&P.h.GetCurrentGradient(l,u._dragGradients,function(e,t,i){e!==r._currentDragGradient&&(r._currentDrag1=r._currentDrag2,r._currentDrag2=t.getFactor(),r._currentDragGradient=e);var n=a.a.Lerp(r._currentDrag1,r._currentDrag2,i);u._scaledDirection.scaleInPlace(1-n)}),r.position.addInPlace(u._scaledDirection),i&&t&&r._randomNoiseCoordinates1){var d=u._fetchR(r._randomNoiseCoordinates1.x,r._randomNoiseCoordinates1.y,t.width,t.height,i),f=u._fetchR(r._randomNoiseCoordinates1.z,r._randomNoiseCoordinates2.x,t.width,t.height,i),_=u._fetchR(r._randomNoiseCoordinates2.y,r._randomNoiseCoordinates2.z,t.width,t.height,i),m=n.Tmp.Vector3[0],g=n.Tmp.Vector3[1];m.copyFromFloats((2*d-1)*u.noiseStrength.x,(2*f-1)*u.noiseStrength.y,(2*_-1)*u.noiseStrength.z),m.scaleToRef(o,g),r.direction.addInPlace(g)}if(u.gravity.scaleToRef(o,u._scaledGravity),r.direction.addInPlace(u._scaledGravity),u._sizeGradients&&u._sizeGradients.length>0&&P.h.GetCurrentGradient(l,u._sizeGradients,function(e,t,i){e!==r._currentSizeGradient&&(r._currentSize1=r._currentSize2,r._currentSize2=t.getFactor(),r._currentSizeGradient=e),r.size=a.a.Lerp(r._currentSize1,r._currentSize2,i)}),u._useRampGradients&&(u._colorRemapGradients&&u._colorRemapGradients.length>0&&P.h.GetCurrentGradient(l,u._colorRemapGradients,function(e,t,i){var n=a.a.Lerp(e.factor1,t.factor1,i),o=a.a.Lerp(e.factor2,t.factor2,i);r.remapData.x=n,r.remapData.y=o-n}),u._alphaRemapGradients&&u._alphaRemapGradients.length>0&&P.h.GetCurrentGradient(l,u._alphaRemapGradients,function(e,t,i){var n=a.a.Lerp(e.factor1,t.factor1,i),o=a.a.Lerp(e.factor2,t.factor2,i);r.remapData.z=n,r.remapData.w=o-n})),u._isAnimationSheetEnabled&&r.updateCellIndex(),r._inheritParticleInfoToSubEmitters(),r.age>=r.lifeTime)return u._emitFromParticle(r),r._attachedSubEmitters&&(r._attachedSubEmitters.forEach(function(e){e.particleSystem.disposeOnStop=!0,e.particleSystem.stop()}),r._attachedSubEmitters=null),u.recycleParticle(r),s--,"continue"},s=0;s<e.length;s++)o()},u}return l.d(t,e),Object.defineProperty(t.prototype,"onDispose",{set:function(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"useRampGradients",{get:function(){return this._useRampGradients},set:function(e){this._useRampGradients!==e&&(this._useRampGradients=e,this._resetEffect())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"particles",{get:function(){return this._particles},enumerable:!0,configurable:!0}),t.prototype.getClassName=function(){return"ParticleSystem"},t.prototype._addFactorGradient=function(e,t,i,r){var n=new P.d;n.gradient=t,n.factor1=i,n.factor2=r,e.push(n),e.sort(function(e,t){return e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0})},t.prototype._removeFactorGradient=function(e,t){if(e)for(var i=0,r=0,n=e;r<n.length;r++){if(n[r].gradient===t){e.splice(i,1);break}i++}},t.prototype.addLifeTimeGradient=function(e,t,i){return this._lifeTimeGradients||(this._lifeTimeGradients=[]),this._addFactorGradient(this._lifeTimeGradients,e,t,i),this},t.prototype.removeLifeTimeGradient=function(e){return this._removeFactorGradient(this._lifeTimeGradients,e),this},t.prototype.addSizeGradient=function(e,t,i){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,t,i),this},t.prototype.removeSizeGradient=function(e){return this._removeFactorGradient(this._sizeGradients,e),this},t.prototype.addColorRemapGradient=function(e,t,i){return this._colorRemapGradients||(this._colorRemapGradients=[]),this._addFactorGradient(this._colorRemapGradients,e,t,i),this},t.prototype.removeColorRemapGradient=function(e){return this._removeFactorGradient(this._colorRemapGradients,e),this},t.prototype.addAlphaRemapGradient=function(e,t,i){return this._alphaRemapGradients||(this._alphaRemapGradients=[]),this._addFactorGradient(this._alphaRemapGradients,e,t,i),this},t.prototype.removeAlphaRemapGradient=function(e){return this._removeFactorGradient(this._alphaRemapGradients,e),this},t.prototype.addAngularSpeedGradient=function(e,t,i){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,t,i),this},t.prototype.removeAngularSpeedGradient=function(e){return this._removeFactorGradient(this._angularSpeedGradients,e),this},t.prototype.addVelocityGradient=function(e,t,i){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,t,i),this},t.prototype.removeVelocityGradient=function(e){return this._removeFactorGradient(this._velocityGradients,e),this},t.prototype.addLimitVelocityGradient=function(e,t,i){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,t,i),this},t.prototype.removeLimitVelocityGradient=function(e){return this._removeFactorGradient(this._limitVelocityGradients,e),this},t.prototype.addDragGradient=function(e,t,i){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,t,i),this},t.prototype.removeDragGradient=function(e){return this._removeFactorGradient(this._dragGradients,e),this},t.prototype.addEmitRateGradient=function(e,t,i){return this._emitRateGradients||(this._emitRateGradients=[]),this._addFactorGradient(this._emitRateGradients,e,t,i),this},t.prototype.removeEmitRateGradient=function(e){return this._removeFactorGradient(this._emitRateGradients,e),this},t.prototype.addStartSizeGradient=function(e,t,i){return this._startSizeGradients||(this._startSizeGradients=[]),this._addFactorGradient(this._startSizeGradients,e,t,i),this},t.prototype.removeStartSizeGradient=function(e){return this._removeFactorGradient(this._emitRateGradients,e),this},t.prototype._createRampGradientTexture=function(){if(this._rampGradients&&this._rampGradients.length&&!this._rampGradientsTexture){for(var e=new Uint8Array(4*this._rawTextureWidth),t=n.Tmp.Color3[0],i=0;i<this._rawTextureWidth;i++){var r=i/this._rawTextureWidth;P.h.GetCurrentGradient(r,this._rampGradients,function(r,o,s){n.Color3.LerpToRef(r.color,o.color,s,t),e[4*i]=255*t.r,e[4*i+1]=255*t.g,e[4*i+2]=255*t.b,e[4*i+3]=255})}this._rampGradientsTexture=A.a.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,T.a.NEAREST_SAMPLINGMODE)}},t.prototype.getRampGradients=function(){return this._rampGradients},t.prototype.addRampGradient=function(e,t){this._rampGradients||(this._rampGradients=[]);var i=new P.b;return i.gradient=e,i.color=t,this._rampGradients.push(i),this._rampGradients.sort(function(e,t){return e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0}),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._createRampGradientTexture(),this},t.prototype.removeRampGradient=function(e){return this._removeGradientAndTexture(e,this._rampGradients,this._rampGradientsTexture),this._rampGradientsTexture=null,this._rampGradients&&this._rampGradients.length>0&&this._createRampGradientTexture(),this},t.prototype.addColorGradient=function(e,t,i){this._colorGradients||(this._colorGradients=[]);var r=new P.c;return r.gradient=e,r.color1=t,r.color2=i,this._colorGradients.push(r),this._colorGradients.sort(function(e,t){return e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0}),this},t.prototype.removeColorGradient=function(e){if(!this._colorGradients)return this;for(var t=0,i=0,r=this._colorGradients;i<r.length;i++){if(r[i].gradient===e){this._colorGradients.splice(t,1);break}t++}return this},t.prototype._fetchR=function(e,t,i,r,n){return n[4*(((e=.5*Math.abs(e)+.5)*i%i|0)+((t=.5*Math.abs(t)+.5)*r%r|0)*i)]/255},t.prototype._reset=function(){this._resetEffect()},t.prototype._resetEffect=function(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._createVertexBuffers()},t.prototype._createVertexBuffers=function(){this._vertexBufferSize=this._useInstancing?10:12,this._isAnimationSheetEnabled&&(this._vertexBufferSize+=1),this._isBillboardBased&&this.billboardMode!==t.BILLBOARDMODE_STRETCHED||(this._vertexBufferSize+=3),this._useRampGradients&&(this._vertexBufferSize+=4);var e=this._scene.getEngine();this._vertexData=new Float32Array(this._capacity*this._vertexBufferSize*(this._useInstancing?1:4)),this._vertexBuffer=new v.Buffer(e,this._vertexData,!0,this._vertexBufferSize);var i=0,r=this._vertexBuffer.createVertexBuffer(v.VertexBuffer.PositionKind,i,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[v.VertexBuffer.PositionKind]=r,i+=3;var n=this._vertexBuffer.createVertexBuffer(v.VertexBuffer.ColorKind,i,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[v.VertexBuffer.ColorKind]=n,i+=4;var o=this._vertexBuffer.createVertexBuffer("angle",i,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.angle=o,i+=1;var s,a=this._vertexBuffer.createVertexBuffer("size",i,2,this._vertexBufferSize,this._useInstancing);if(this._vertexBuffers.size=a,i+=2,this._isAnimationSheetEnabled){var c=this._vertexBuffer.createVertexBuffer("cellIndex",i,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.cellIndex=c,i+=1}if(!this._isBillboardBased||this.billboardMode===t.BILLBOARDMODE_STRETCHED){var h=this._vertexBuffer.createVertexBuffer("direction",i,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.direction=h,i+=3}if(this._useRampGradients){var l=this._vertexBuffer.createVertexBuffer("remapData",i,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.remapData=l,i+=4}if(this._useInstancing){var u=new Float32Array([0,0,1,0,1,1,0,1]);this._spriteBuffer=new v.Buffer(e,u,!1,2),s=this._spriteBuffer.createVertexBuffer("offset",0,2)}else s=this._vertexBuffer.createVertexBuffer("offset",i,2,this._vertexBufferSize,this._useInstancing),i+=2;this._vertexBuffers.offset=s},t.prototype._createIndexBuffer=function(){if(!this._useInstancing){for(var e=[],t=0,i=0;i<this._capacity;i++)e.push(t),e.push(t+1),e.push(t+2),e.push(t),e.push(t+2),e.push(t+3),t+=4;this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}},t.prototype.getCapacity=function(){return this._capacity},t.prototype.isAlive=function(){return this._alive},t.prototype.isStarted=function(){return this._started},t.prototype._prepareSubEmitterInternalArray=function(){var e=this;this._subEmitters=new Array,this.subEmitters&&this.subEmitters.forEach(function(i){i instanceof t?e._subEmitters.push([new D(i)]):i instanceof D?e._subEmitters.push([i]):i instanceof Array&&e._subEmitters.push(i)})},t.prototype.start=function(e){var t=this;if(void 0===e&&(e=this.startDelay),!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(e)setTimeout(function(){t.start(0)},e);else{if(this._prepareSubEmitterInternalArray(),this._started=!0,this._stopped=!1,this._actualFrame=0,this._subEmitters&&0!=this._subEmitters.length&&(this.activeSubSystems=new Array),this._emitRateGradients&&(this._emitRateGradients.length>0&&(this._currentEmitRateGradient=this._emitRateGradients[0],this._currentEmitRate1=this._currentEmitRateGradient.getFactor(),this._currentEmitRate2=this._currentEmitRate1),this._emitRateGradients.length>1&&(this._currentEmitRate2=this._emitRateGradients[1].getFactor())),this._startSizeGradients&&(this._startSizeGradients.length>0&&(this._currentStartSizeGradient=this._startSizeGradients[0],this._currentStartSize1=this._currentStartSizeGradient.getFactor(),this._currentStartSize2=this._currentStartSize1),this._startSizeGradients.length>1&&(this._currentStartSize2=this._startSizeGradients[1].getFactor())),this.preWarmCycles){this.emitter instanceof S.a&&this.emitter.computeWorldMatrix(!0);var i=this.noiseTexture;if(i&&i.onGeneratedObservable)i.onGeneratedObservable.addOnce(function(){setTimeout(function(){for(var e=0;e<t.preWarmCycles;e++)t.animate(!0),i.render()})});else for(var r=0;r<this.preWarmCycles;r++)this.animate(!0)}this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this.getScene().beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)}},t.prototype.stop=function(e){void 0===e&&(e=!0),this._stopped=!0,e&&this._stopSubEmitters()},t.prototype.reset=function(){this._stockParticles=[],this._particles=[]},t.prototype._appendParticleVertex=function(e,i,r,n){var o=e*this._vertexBufferSize;this._vertexData[o++]=i.position.x,this._vertexData[o++]=i.position.y,this._vertexData[o++]=i.position.z,this._vertexData[o++]=i.color.r,this._vertexData[o++]=i.color.g,this._vertexData[o++]=i.color.b,this._vertexData[o++]=i.color.a,this._vertexData[o++]=i.angle,this._vertexData[o++]=i.scale.x*i.size,this._vertexData[o++]=i.scale.y*i.size,this._isAnimationSheetEnabled&&(this._vertexData[o++]=i.cellIndex),this._isBillboardBased?this.billboardMode===t.BILLBOARDMODE_STRETCHED&&(this._vertexData[o++]=i.direction.x,this._vertexData[o++]=i.direction.y,this._vertexData[o++]=i.direction.z):i._initialDirection?(this._vertexData[o++]=i._initialDirection.x,this._vertexData[o++]=i._initialDirection.y,this._vertexData[o++]=i._initialDirection.z):(this._vertexData[o++]=i.direction.x,this._vertexData[o++]=i.direction.y,this._vertexData[o++]=i.direction.z),this._useRampGradients&&(this._vertexData[o++]=i.remapData.x,this._vertexData[o++]=i.remapData.y,this._vertexData[o++]=i.remapData.z,this._vertexData[o++]=i.remapData.w),this._useInstancing||(this._isAnimationSheetEnabled&&(0===r?r=this._epsilon:1===r&&(r=1-this._epsilon),0===n?n=this._epsilon:1===n&&(n=1-this._epsilon)),this._vertexData[o++]=r,this._vertexData[o++]=n)},t.prototype._stopSubEmitters=function(){this.activeSubSystems&&(this.activeSubSystems.forEach(function(e){e.stop(!0)}),this.activeSubSystems=new Array)},t.prototype._removeFromRoot=function(){if(this._rootParticleSystem){var e=this._rootParticleSystem.activeSubSystems.indexOf(this);-1!==e&&this._rootParticleSystem.activeSubSystems.splice(e,1),this._rootParticleSystem=null}},t.prototype._update=function(e){var t,i=this;if(this._alive=this._particles.length>0,this.emitter.position){var r=this.emitter;this._emitterWorldMatrix=r.getWorldMatrix()}else{var o=this.emitter;this._emitterWorldMatrix=n.Matrix.Translation(o.x,o.y,o.z)}this.updateFunction(this._particles);for(var s,c=function(){if(h._particles.length===h._capacity)return"break";t=h._createParticle(),h._particles.push(t);var e=a.a.RandomRange(h.minEmitPower,h.maxEmitPower);if(h.startPositionFunction?h.startPositionFunction(h._emitterWorldMatrix,t.position,t):h.particleEmitterType.startPositionFunction(h._emitterWorldMatrix,t.position,t),h.startDirectionFunction?h.startDirectionFunction(h._emitterWorldMatrix,t.direction,t):h.particleEmitterType.startDirectionFunction(h._emitterWorldMatrix,t.direction,t),0===e?t._initialDirection?t._initialDirection.copyFrom(t.direction):t._initialDirection=t.direction.clone():t._initialDirection=null,t.direction.scaleInPlace(e),h.targetStopDuration&&h._lifeTimeGradients&&h._lifeTimeGradients.length>0){var r=a.a.Clamp(h._actualFrame/h.targetStopDuration);P.h.GetCurrentGradient(r,h._lifeTimeGradients,function(e,i){var n=e,o=i,s=n.getFactor(),c=o.getFactor(),h=(r-n.gradient)/(o.gradient-n.gradient);t.lifeTime=a.a.Lerp(s,c,h)})}else t.lifeTime=a.a.RandomRange(h.minLifeTime,h.maxLifeTime);if(h._sizeGradients&&0!==h._sizeGradients.length?(t._currentSizeGradient=h._sizeGradients[0],t._currentSize1=t._currentSizeGradient.getFactor(),t.size=t._currentSize1,h._sizeGradients.length>1?t._currentSize2=h._sizeGradients[1].getFactor():t._currentSize2=t._currentSize1):t.size=a.a.RandomRange(h.minSize,h.maxSize),t.scale.copyFromFloats(a.a.RandomRange(h.minScaleX,h.maxScaleX),a.a.RandomRange(h.minScaleY,h.maxScaleY)),h._startSizeGradients&&h._startSizeGradients[0]&&h.targetStopDuration){var o=h._actualFrame/h.targetStopDuration;P.h.GetCurrentGradient(o,h._startSizeGradients,function(e,r,n){e!==i._currentStartSizeGradient&&(i._currentStartSize1=i._currentStartSize2,i._currentStartSize2=r.getFactor(),i._currentStartSizeGradient=e);var o=a.a.Lerp(i._currentStartSize1,i._currentStartSize2,n);t.scale.scaleInPlace(o)})}h._angularSpeedGradients&&0!==h._angularSpeedGradients.length?(t._currentAngularSpeedGradient=h._angularSpeedGradients[0],t.angularSpeed=t._currentAngularSpeedGradient.getFactor(),t._currentAngularSpeed1=t.angularSpeed,h._angularSpeedGradients.length>1?t._currentAngularSpeed2=h._angularSpeedGradients[1].getFactor():t._currentAngularSpeed2=t._currentAngularSpeed1):t.angularSpeed=a.a.RandomRange(h.minAngularSpeed,h.maxAngularSpeed),t.angle=a.a.RandomRange(h.minInitialRotation,h.maxInitialRotation),h._velocityGradients&&h._velocityGradients.length>0&&(t._currentVelocityGradient=h._velocityGradients[0],t._currentVelocity1=t._currentVelocityGradient.getFactor(),h._velocityGradients.length>1?t._currentVelocity2=h._velocityGradients[1].getFactor():t._currentVelocity2=t._currentVelocity1),h._limitVelocityGradients&&h._limitVelocityGradients.length>0&&(t._currentLimitVelocityGradient=h._limitVelocityGradients[0],t._currentLimitVelocity1=t._currentLimitVelocityGradient.getFactor(),h._limitVelocityGradients.length>1?t._currentLimitVelocity2=h._limitVelocityGradients[1].getFactor():t._currentLimitVelocity2=t._currentLimitVelocity1),h._dragGradients&&h._dragGradients.length>0&&(t._currentDragGradient=h._dragGradients[0],t._currentDrag1=t._currentDragGradient.getFactor(),h._dragGradients.length>1?t._currentDrag2=h._dragGradients[1].getFactor():t._currentDrag2=t._currentDrag1),h._colorGradients&&0!==h._colorGradients.length?(t._currentColorGradient=h._colorGradients[0],t._currentColorGradient.getColorToRef(t.color),t._currentColor1.copyFrom(t.color),h._colorGradients.length>1?h._colorGradients[1].getColorToRef(t._currentColor2):t._currentColor2.copyFrom(t.color)):(s=a.a.RandomRange(0,1),n.Color4.LerpToRef(h.color1,h.color2,s,t.color),h.colorDead.subtractToRef(t.color,h._colorDiff),h._colorDiff.scaleToRef(1/t.lifeTime,t.colorStep)),h._isAnimationSheetEnabled&&(t._initialStartSpriteCellID=h.startSpriteCellID,t._initialEndSpriteCellID=h.endSpriteCellID),t.direction.addInPlace(h._inheritedVelocityOffset),h._useRampGradients&&(t.remapData=new n.Vector4(0,1,0,1)),h.noiseTexture&&(t._randomNoiseCoordinates1?(t._randomNoiseCoordinates1.copyFromFloats(Math.random(),Math.random(),Math.random()),t._randomNoiseCoordinates2.copyFromFloats(Math.random(),Math.random(),Math.random())):(t._randomNoiseCoordinates1=new n.Vector3(Math.random(),Math.random(),Math.random()),t._randomNoiseCoordinates2=new n.Vector3(Math.random(),Math.random(),Math.random()))),t._inheritParticleInfoToSubEmitters()},h=this,l=0;l<e;l++){if("break"===c())break}},t._GetAttributeNamesOrOptions=function(e,t,i){void 0===e&&(e=!1),void 0===t&&(t=!1),void 0===i&&(i=!1);var r=[v.VertexBuffer.PositionKind,v.VertexBuffer.ColorKind,"angle","offset","size"];return e&&r.push("cellIndex"),t||r.push("direction"),i&&r.push("remapData"),r},t._GetEffectCreationOptions=function(e){void 0===e&&(e=!1);var t=["invView","view","projection","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","textureMask","translationPivot","eyePosition"];return e&&t.push("particlesInfos"),t},t.prototype._getEffect=function(e){if(this._customEffect)return this._customEffect;var i=[];if(this._scene.clipPlane&&i.push("#define CLIPPLANE"),this._scene.clipPlane2&&i.push("#define CLIPPLANE2"),this._scene.clipPlane3&&i.push("#define CLIPPLANE3"),this._scene.clipPlane4&&i.push("#define CLIPPLANE4"),this._isAnimationSheetEnabled&&i.push("#define ANIMATESHEET"),e===t.BLENDMODE_MULTIPLY&&i.push("#define BLENDMULTIPLYMODE"),this._useRampGradients&&i.push("#define RAMPGRADIENT"),this._isBillboardBased)switch(i.push("#define BILLBOARD"),this.billboardMode){case t.BILLBOARDMODE_Y:i.push("#define BILLBOARDY");break;case t.BILLBOARDMODE_STRETCHED:i.push("#define BILLBOARDSTRETCHED");break;case t.BILLBOARDMODE_ALL:}this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),i.push(this._imageProcessingConfigurationDefines.toString()));var r=i.join("\n");if(this._cachedDefines!==r){this._cachedDefines=r;var n=t._GetAttributeNamesOrOptions(this._isAnimationSheetEnabled,this._isBillboardBased&&this.billboardMode!==t.BILLBOARDMODE_STRETCHED,this._useRampGradients),s=t._GetEffectCreationOptions(this._isAnimationSheetEnabled),a=["diffuseSampler","rampSampler"];o.a&&(o.a.PrepareUniforms(s,this._imageProcessingConfigurationDefines),o.a.PrepareSamplers(a,this._imageProcessingConfigurationDefines)),this._effect=this._scene.getEngine().createEffect("particles",n,s,a,r)}return this._effect},t.prototype.animate=function(e){var t=this;if(void 0===e&&(e=!1),this._started){if(!e){if(!this.isReady())return;if(this._currentRenderId===this._scene.getFrameId())return;this._currentRenderId=this._scene.getFrameId()}var i;if(this._scaledUpdateSpeed=this.updateSpeed*(e?this.preWarmStepOffset:this._scene.getAnimationRatio()),this.manualEmitCount>-1)i=this.manualEmitCount,this._newPartsExcess=0,this.manualEmitCount=0;else{var r=this.emitRate;if(this._emitRateGradients&&this._emitRateGradients.length>0&&this.targetStopDuration){var n=this._actualFrame/this.targetStopDuration;P.h.GetCurrentGradient(n,this._emitRateGradients,function(e,i,n){e!==t._currentEmitRateGradient&&(t._currentEmitRate1=t._currentEmitRate2,t._currentEmitRate2=i.getFactor(),t._currentEmitRateGradient=e),r=a.a.Lerp(t._currentEmitRate1,t._currentEmitRate2,n)})}i=r*this._scaledUpdateSpeed>>0,this._newPartsExcess+=r*this._scaledUpdateSpeed-i}if(this._newPartsExcess>1&&(i+=this._newPartsExcess>>0,this._newPartsExcess-=this._newPartsExcess>>0),this._alive=!1,this._stopped?i=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(i),this._stopped&&(this._alive||(this._started=!1,this.onAnimationEnd&&this.onAnimationEnd(),this.disposeOnStop&&this._scene._toBeDisposed.push(this))),!e){for(var o=0,s=0;s<this._particles.length;s++){var c=this._particles[s];this._appendParticleVertices(o,c),o+=this._useInstancing?1:4}this._vertexBuffer&&this._vertexBuffer.update(this._vertexData)}0===this.manualEmitCount&&this.disposeOnStop&&this.stop()}},t.prototype._appendParticleVertices=function(e,t){this._appendParticleVertex(e++,t,0,0),this._useInstancing||(this._appendParticleVertex(e++,t,1,0),this._appendParticleVertex(e++,t,1,1),this._appendParticleVertex(e++,t,0,1))},t.prototype.rebuild=function(){this._createIndexBuffer(),this._vertexBuffer&&this._vertexBuffer._rebuild()},t.prototype.isReady=function(){if(!(this.emitter&&this._imageProcessingConfiguration.isReady()&&this.particleTexture&&this.particleTexture.isReady()))return!1;if(this.blendMode!==t.BLENDMODE_MULTIPLYADD){if(!this._getEffect(this.blendMode).isReady())return!1}else{if(!this._getEffect(t.BLENDMODE_MULTIPLY).isReady())return!1;if(!this._getEffect(t.BLENDMODE_ADD).isReady())return!1}return!0},t.prototype._render=function(e){var i=this._getEffect(e),r=this._scene.getEngine();r.enableEffect(i);var n=this._scene.getViewMatrix();if(i.setTexture("diffuseSampler",this.particleTexture),i.setMatrix("view",n),i.setMatrix("projection",this._scene.getProjectionMatrix()),this._isAnimationSheetEnabled&&this.particleTexture){var o=this.particleTexture.getBaseSize();i.setFloat3("particlesInfos",this.spriteCellWidth/o.width,this.spriteCellHeight/o.height,o.width/this.spriteCellWidth)}if(i.setVector2("translationPivot",this.translationPivot),i.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this._isBillboardBased){var s=this._scene.activeCamera;i.setVector3("eyePosition",s.globalPosition)}if(this._rampGradientsTexture&&i.setTexture("rampSampler",this._rampGradientsTexture),this._scene.clipPlane||this._scene.clipPlane2||this._scene.clipPlane3||this._scene.clipPlane4){var a=n.clone();a.invert(),i.setMatrix("invView",a),x.a.BindClipPlane(i,this._scene)}switch(r.bindBuffers(this._vertexBuffers,this._indexBuffer,i),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(i),e){case t.BLENDMODE_ADD:r.setAlphaMode(g.a.ALPHA_ADD);break;case t.BLENDMODE_ONEONE:r.setAlphaMode(g.a.ALPHA_ONEONE);break;case t.BLENDMODE_STANDARD:r.setAlphaMode(g.a.ALPHA_COMBINE);break;case t.BLENDMODE_MULTIPLY:r.setAlphaMode(g.a.ALPHA_MULTIPLY)}return this._useInstancing?r.drawArraysType(E.a.TriangleFanDrawMode,0,4,this._particles.length):r.drawElementsType(E.a.TriangleFillMode,0,6*this._particles.length),this._particles.length},t.prototype.render=function(){if(!this.isReady()||!this._particles.length)return 0;var e=this._scene.getEngine();e.setState(!1),this.forceDepthWrite&&e.setDepthWrite(!0);var i=0;return this.blendMode===t.BLENDMODE_MULTIPLYADD&&(i=this._render(t.BLENDMODE_MULTIPLY)+this._render(t.BLENDMODE_ADD)),i=this._render(this.blendMode),e.unbindInstanceAttributes(),e.setAlphaMode(g.a.ALPHA_DISABLE),i},t.prototype.dispose=function(e){if(void 0===e&&(e=!0),this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._removeFromRoot(),this._subEmitters&&this._subEmitters.length){for(var t=0;t<this._subEmitters.length;t++)for(var i=0,r=this._subEmitters[t];i<r.length;i++){r[i].dispose()}this._subEmitters=[],this.subEmitters=[]}this._disposeEmitterOnDispose&&this.emitter&&this.emitter.dispose&&this.emitter.dispose(!0),(t=this._scene.particleSystems.indexOf(this))>-1&&this._scene.particleSystems.splice(t,1),this._scene._activeParticleSystems.dispose(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.reset()},t.prototype.clone=function(e,i){var r=null,n=null;if(null!=this.customShader){var o=(n=this.customShader).shaderOptions.defines.length>0?n.shaderOptions.defines.join("\n"):"";r=this._scene.getEngine().createEffectForParticles(n.shaderPath.fragmentElement,n.shaderOptions.uniforms,n.shaderOptions.samplers,o)}else this._customEffect&&(r=this._customEffect);var a=new t(e,this._capacity,this._scene,r);return a.customShader=n,s.a.DeepCopy(this,a,["particles","customShader","noiseTexture"]),void 0===i&&(i=this.emitter),a.noiseTexture=this.noiseTexture,a.emitter=i,this.particleTexture&&(a.particleTexture=new T.a(this.particleTexture.url,this._scene)),this._colorGradients&&this._colorGradients.forEach(function(e){a.addColorGradient(e.gradient,e.color1,e.color2)}),this._dragGradients&&this._dragGradients.forEach(function(e){a.addDragGradient(e.gradient,e.factor1,e.factor2)}),this._angularSpeedGradients&&this._angularSpeedGradients.forEach(function(e){a.addAngularSpeedGradient(e.gradient,e.factor1,e.factor2)}),this._emitRateGradients&&this._emitRateGradients.forEach(function(e){a.addEmitRateGradient(e.gradient,e.factor1,e.factor2)}),this._lifeTimeGradients&&this._lifeTimeGradients.forEach(function(e){a.addLifeTimeGradient(e.gradient,e.factor1,e.factor2)}),this._limitVelocityGradients&&this._limitVelocityGradients.forEach(function(e){a.addLimitVelocityGradient(e.gradient,e.factor1,e.factor2)}),this._sizeGradients&&this._sizeGradients.forEach(function(e){a.addSizeGradient(e.gradient,e.factor1,e.factor2)}),this._startSizeGradients&&this._startSizeGradients.forEach(function(e){a.addStartSizeGradient(e.gradient,e.factor1,e.factor2)}),this._velocityGradients&&this._velocityGradients.forEach(function(e){a.addVelocityGradient(e.gradient,e.factor1,e.factor2)}),this._rampGradients&&this._rampGradients.forEach(function(e){a.addRampGradient(e.gradient,e.color)}),this._colorRemapGradients&&this._colorRemapGradients.forEach(function(e){a.addColorRemapGradient(e.gradient,e.factor1,e.factor2)}),this._alphaRemapGradients&&this._alphaRemapGradients.forEach(function(e){a.addAlphaRemapGradient(e.gradient,e.factor1,e.factor2)}),this.preventAutoStart||a.start(),a},t.prototype.serialize=function(){var e={};if(t._Serialize(e,this),e.textureMask=this.textureMask.asArray(),e.customShader=this.customShader,e.preventAutoStart=this.preventAutoStart,this.subEmitters){e.subEmitters=[],this._subEmitters||this._prepareSubEmitterInternalArray();for(var i=0,r=this._subEmitters;i<r.length;i++){for(var n=[],o=0,s=r[i];o<s.length;o++){var a=s[o];n.push(a.serialize())}e.subEmitters.push(n)}}return e},t._Serialize=function(e,t){if(e.name=t.name,e.id=t.id,e.capacity=t.getCapacity(),t.emitter.position){var i=t.emitter;e.emitterId=i.id}else{var r=t.emitter;e.emitter=r.asArray()}t.particleEmitterType&&(e.particleEmitterType=t.particleEmitterType.serialize()),t.particleTexture&&(e.textureName=t.particleTexture.name,e.invertY=t.particleTexture._invertY),F.a.AppendSerializedAnimations(t,e),e.beginAnimationOnStart=t.beginAnimationOnStart,e.beginAnimationFrom=t.beginAnimationFrom,e.beginAnimationTo=t.beginAnimationTo,e.beginAnimationLoop=t.beginAnimationLoop,e.startDelay=t.startDelay,e.renderingGroupId=t.renderingGroupId,e.isBillboardBased=t.isBillboardBased,e.billboardMode=t.billboardMode,e.minAngularSpeed=t.minAngularSpeed,e.maxAngularSpeed=t.maxAngularSpeed,e.minSize=t.minSize,e.maxSize=t.maxSize,e.minScaleX=t.minScaleX,e.maxScaleX=t.maxScaleX,e.minScaleY=t.minScaleY,e.maxScaleY=t.maxScaleY,e.minEmitPower=t.minEmitPower,e.maxEmitPower=t.maxEmitPower,e.minLifeTime=t.minLifeTime,e.maxLifeTime=t.maxLifeTime,e.emitRate=t.emitRate,e.gravity=t.gravity.asArray(),e.noiseStrength=t.noiseStrength.asArray(),e.color1=t.color1.asArray(),e.color2=t.color2.asArray(),e.colorDead=t.colorDead.asArray(),e.updateSpeed=t.updateSpeed,e.targetStopDuration=t.targetStopDuration,e.blendMode=t.blendMode,e.preWarmCycles=t.preWarmCycles,e.preWarmStepOffset=t.preWarmStepOffset,e.minInitialRotation=t.minInitialRotation,e.maxInitialRotation=t.maxInitialRotation,e.startSpriteCellID=t.startSpriteCellID,e.endSpriteCellID=t.endSpriteCellID,e.spriteCellChangeSpeed=t.spriteCellChangeSpeed,e.spriteCellWidth=t.spriteCellWidth,e.spriteCellHeight=t.spriteCellHeight,e.spriteRandomStartCell=t.spriteRandomStartCell,e.isAnimationSheetEnabled=t.isAnimationSheetEnabled;var n=t.getColorGradients();if(n){e.colorGradients=[];for(var o=0,s=n;o<s.length;o++){var a=s[o],c={gradient:a.gradient,color1:a.color1.asArray()};a.color2&&(c.color2=a.color2.asArray()),e.colorGradients.push(c)}}var h=t.getRampGradients();if(h){e.rampGradients=[];for(var l=0,u=h;l<u.length;l++){var p=u[l];c={gradient:p.gradient,color:p.color.asArray()};e.rampGradients.push(c)}e.useRampGradients=t.useRampGradients}var d=t.getColorRemapGradients();if(d){e.colorRemapGradients=[];for(var f=0,_=d;f<_.length;f++){var m=_[f];c={gradient:m.gradient,factor1:m.factor1};void 0!==m.factor2&&(c.factor2=m.factor2),e.colorRemapGradients.push(c)}}var g=t.getAlphaRemapGradients();if(g){e.alphaRemapGradients=[];for(var y=0,P=g;y<P.length;y++){var b=P[y];c={gradient:b.gradient,factor1:b.factor1};void 0!==b.factor2&&(c.factor2=b.factor2),e.alphaRemapGradients.push(c)}}var v=t.getSizeGradients();if(v){e.sizeGradients=[];for(var S=0,E=v;S<E.length;S++){var x=E[S];c={gradient:x.gradient,factor1:x.factor1};void 0!==x.factor2&&(c.factor2=x.factor2),e.sizeGradients.push(c)}}var T=t.getAngularSpeedGradients();if(T){e.angularSpeedGradients=[];for(var A=0,R=T;A<R.length;A++){var C=R[A];c={gradient:C.gradient,factor1:C.factor1};void 0!==C.factor2&&(c.factor2=C.factor2),e.angularSpeedGradients.push(c)}}var O=t.getVelocityGradients();if(O){e.velocityGradients=[];for(var B=0,I=O;B<I.length;B++){var D=I[B];c={gradient:D.gradient,factor1:D.factor1};void 0!==D.factor2&&(c.factor2=D.factor2),e.velocityGradients.push(c)}}var G=t.getDragGradients();if(G){e.dragyGradients=[];for(var M=0,w=G;M<w.length;M++){var L=w[M];c={gradient:L.gradient,factor1:L.factor1};void 0!==L.factor2&&(c.factor2=L.factor2),e.dragGradients.push(c)}}var V=t.getEmitRateGradients();if(V){e.emitRateGradients=[];for(var N=0,z=V;N<z.length;N++){var j=z[N];c={gradient:j.gradient,factor1:j.factor1};void 0!==j.factor2&&(c.factor2=j.factor2),e.emitRateGradients.push(c)}}var k=t.getStartSizeGradients();if(k){e.startSizeGradients=[];for(var U=0,W=k;U<W.length;U++){var H=W[U];c={gradient:H.gradient,factor1:H.factor1};void 0!==H.factor2&&(c.factor2=H.factor2),e.startSizeGradients.push(c)}}var Q=t.getLifeTimeGradients();if(Q){e.lifeTimeGradients=[];for(var J=0,Y=Q;J<Y.length;J++){var X=Y[J];c={gradient:X.gradient,factor1:X.factor1};void 0!==X.factor2&&(c.factor2=X.factor2),e.lifeTimeGradients.push(c)}}var Z=t.getLimitVelocityGradients();if(Z){e.limitVelocityGradients=[];for(var K=0,q=Z;K<q.length;K++){var $=q[K];c={gradient:$.gradient,factor1:$.factor1};void 0!==$.factor2&&(c.factor2=$.factor2),e.limitVelocityGradients.push(c)}e.limitVelocityDamping=t.limitVelocityDamping}t.noiseTexture&&(e.noiseTexture=t.noiseTexture.serialize())},t._Parse=function(e,t,i,r){if(e.textureName&&(t.particleTexture=new T.a(r+e.textureName,i,!1,void 0===e.invertY||e.invertY),t.particleTexture.name=e.textureName),e.emitterId||0===e.emitterId||void 0!==e.emitter?e.emitterId?t.emitter=i.getLastMeshByID(e.emitterId):t.emitter=n.Vector3.FromArray(e.emitter):t.emitter=n.Vector3.Zero(),void 0!==e.renderingGroupId&&(t.renderingGroupId=e.renderingGroupId),void 0!==e.isBillboardBased&&(t.isBillboardBased=e.isBillboardBased),void 0!==e.billboardMode&&(t.billboardMode=e.billboardMode),e.animations){for(var o=0;o<e.animations.length;o++){var s=e.animations[o];t.animations.push(O.a.Parse(s))}t.beginAnimationOnStart=e.beginAnimationOnStart,t.beginAnimationFrom=e.beginAnimationFrom,t.beginAnimationTo=e.beginAnimationTo,t.beginAnimationLoop=e.beginAnimationLoop}if(e.autoAnimate&&i.beginAnimation(t,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),t.startDelay=0|e.startDelay,t.minAngularSpeed=e.minAngularSpeed,t.maxAngularSpeed=e.maxAngularSpeed,t.minSize=e.minSize,t.maxSize=e.maxSize,e.minScaleX&&(t.minScaleX=e.minScaleX,t.maxScaleX=e.maxScaleX,t.minScaleY=e.minScaleY,t.maxScaleY=e.maxScaleY),void 0!==e.preWarmCycles&&(t.preWarmCycles=e.preWarmCycles,t.preWarmStepOffset=e.preWarmStepOffset),void 0!==e.minInitialRotation&&(t.minInitialRotation=e.minInitialRotation,t.maxInitialRotation=e.maxInitialRotation),t.minLifeTime=e.minLifeTime,t.maxLifeTime=e.maxLifeTime,t.minEmitPower=e.minEmitPower,t.maxEmitPower=e.maxEmitPower,t.emitRate=e.emitRate,t.gravity=n.Vector3.FromArray(e.gravity),e.noiseStrength&&(t.noiseStrength=n.Vector3.FromArray(e.noiseStrength)),t.color1=n.Color4.FromArray(e.color1),t.color2=n.Color4.FromArray(e.color2),t.colorDead=n.Color4.FromArray(e.colorDead),t.updateSpeed=e.updateSpeed,t.targetStopDuration=e.targetStopDuration,t.blendMode=e.blendMode,e.colorGradients)for(var a=0,l=e.colorGradients;a<l.length;a++){var p=l[a];t.addColorGradient(p.gradient,n.Color4.FromArray(p.color1),p.color2?n.Color4.FromArray(p.color2):void 0)}if(e.rampGradients){for(var f=0,g=e.rampGradients;f<g.length;f++){var y=g[f];t.addRampGradient(y.gradient,n.Color3.FromArray(y.color))}t.useRampGradients=e.useRampGradients}if(e.colorRemapGradients)for(var P=0,b=e.colorRemapGradients;P<b.length;P++){var v=b[P];t.addColorRemapGradient(v.gradient,void 0!==v.factor1?v.factor1:v.factor,v.factor2)}if(e.alphaRemapGradients)for(var S=0,E=e.alphaRemapGradients;S<E.length;S++){var x=E[S];t.addAlphaRemapGradient(x.gradient,void 0!==x.factor1?x.factor1:x.factor,x.factor2)}if(e.sizeGradients)for(var A=0,C=e.sizeGradients;A<C.length;A++){var B=C[A];t.addSizeGradient(B.gradient,void 0!==B.factor1?B.factor1:B.factor,B.factor2)}if(e.sizeGradients)for(var I=0,D=e.sizeGradients;I<D.length;I++){B=D[I];t.addSizeGradient(B.gradient,void 0!==B.factor1?B.factor1:B.factor,B.factor2)}if(e.angularSpeedGradients)for(var F=0,G=e.angularSpeedGradients;F<G.length;F++){var M=G[F];t.addAngularSpeedGradient(M.gradient,void 0!==M.factor1?M.factor1:M.factor,M.factor2)}if(e.velocityGradients)for(var w=0,L=e.velocityGradients;w<L.length;w++){var V=L[w];t.addVelocityGradient(V.gradient,void 0!==V.factor1?V.factor1:V.factor,V.factor2)}if(e.dragGradients)for(var N=0,z=e.dragGradients;N<z.length;N++){var j=z[N];t.addDragGradient(j.gradient,void 0!==j.factor1?j.factor1:j.factor,j.factor2)}if(e.emitRateGradients)for(var k=0,U=e.emitRateGradients;k<U.length;k++){var W=U[k];t.addEmitRateGradient(W.gradient,void 0!==W.factor1?W.factor1:W.factor,W.factor2)}if(e.startSizeGradients)for(var H=0,Q=e.startSizeGradients;H<Q.length;H++){var J=Q[H];t.addStartSizeGradient(J.gradient,void 0!==J.factor1?J.factor1:J.factor,J.factor2)}if(e.lifeTimeGradients)for(var Y=0,X=e.lifeTimeGradients;Y<X.length;Y++){var Z=X[Y];t.addLifeTimeGradient(Z.gradient,void 0!==Z.factor1?Z.factor1:Z.factor,Z.factor2)}if(e.limitVelocityGradients){for(var K=0,q=e.limitVelocityGradients;K<q.length;K++){var $=q[K];t.addLimitVelocityGradient($.gradient,void 0!==$.factor1?$.factor1:$.factor,$.factor2)}t.limitVelocityDamping=e.limitVelocityDamping}var ee;if(e.noiseTexture&&(t.noiseTexture=R.a.Parse(e.noiseTexture,i,r)),e.particleEmitterType){switch(e.particleEmitterType.type){case"SphereParticleEmitter":ee=new _;break;case"SphereDirectedParticleEmitter":ee=new m;break;case"ConeEmitter":case"ConeParticleEmitter":ee=new h;break;case"CylinderParticleEmitter":ee=new u;break;case"HemisphericParticleEmitter":ee=new d;break;case"BoxEmitter":case"BoxParticleEmitter":default:ee=new c}ee.parse(e.particleEmitterType)}else(ee=new c).parse(e);t.particleEmitterType=ee,t.startSpriteCellID=e.startSpriteCellID,t.endSpriteCellID=e.endSpriteCellID,t.spriteCellWidth=e.spriteCellWidth,t.spriteCellHeight=e.spriteCellHeight,t.spriteCellChangeSpeed=e.spriteCellChangeSpeed,t.spriteRandomStartCell=e.spriteRandomStartCell},t.Parse=function(e,i,r,o){void 0===o&&(o=!1);var s=e.name,a=null,c=null;if(e.customShader){var h=(c=e.customShader).shaderOptions.defines.length>0?c.shaderOptions.defines.join("\n"):"";a=i.getEngine().createEffectForParticles(c.shaderPath.fragmentElement,c.shaderOptions.uniforms,c.shaderOptions.samplers,h)}var l=new t(s,e.capacity,i,a,e.isAnimationSheetEnabled);if(l.customShader=c,e.id&&(l.id=e.id),e.subEmitters){l.subEmitters=[];for(var u=0,p=e.subEmitters;u<p.length;u++){for(var d=[],f=0,_=p[u];f<_.length;f++){var m=_[f];d.push(D.Parse(m,i,r))}l.subEmitters.push(d)}}return t._Parse(e,l,i,r),l.textureMask=n.Color4.FromArray(e.textureMask),e.preventAutoStart&&(l.preventAutoStart=e.preventAutoStart),o||l.preventAutoStart||l.start(),l},t.BILLBOARDMODE_Y=g.a.PARTICLES_BILLBOARDMODE_Y,t.BILLBOARDMODE_ALL=g.a.PARTICLES_BILLBOARDMODE_ALL,t.BILLBOARDMODE_STRETCHED=g.a.PARTICLES_BILLBOARDMODE_STRETCHED,t}(y));D._ParseParticleSystem=G.Parse;var M=i(8),w=(i(291),i(292),i(326),i(327),function(e){function t(t,i,r,n){void 0===n&&(n=!1);var o=e.call(this,t)||this;o.layerMask=268435455,o._accumulatedCount=0,o._targetIndex=0,o._currentRenderId=-1,o._started=!1,o._stopped=!1,o._timeDelta=0,o._actualFrame=0,o._rawTextureWidth=256,o.onDisposeObservable=new b.c,o.forceDepthWrite=!1,o._preWarmDone=!1,o._scene=r||C.a.LastCreatedScene,o._attachImageProcessingConfiguration(null),o._engine=o._scene.getEngine(),i.randomTextureSize||delete i.randomTextureSize;var s=l.a({capacity:5e4,randomTextureSize:o._engine.getCaps().maxTextureSize},i),a=i;isFinite(a)&&(s.capacity=a),o._capacity=s.capacity,o._activeCount=s.capacity,o._currentActiveCount=0,o._isAnimationSheetEnabled=n,o._scene.particleSystems.push(o),o._updateEffectOptions={attributes:["position","age","life","seed","size","color","direction","initialDirection","angle","cellIndex","cellStartOffset","noiseCoordinates1","noiseCoordinates2"],uniformsNames:["currentCount","timeDelta","emitterWM","lifeTime","color1","color2","sizeRange","scaleRange","gravity","emitPower","direction1","direction2","minEmitBox","maxEmitBox","radius","directionRandomizer","height","coneAngle","stopFactor","angleRange","radiusRange","cellInfos","noiseStrength","limitVelocityDamping"],uniformBuffersNames:[],samplers:["randomSampler","randomSampler2","sizeGradientSampler","angularSpeedGradientSampler","velocityGradientSampler","limitVelocityGradientSampler","noiseSampler","dragGradientSampler"],defines:"",fallbacks:null,onCompiled:null,onError:null,indexParameters:null,maxSimultaneousLights:0,transformFeedbackVaryings:[]},o.particleEmitterType=new c;for(var h=Math.min(o._engine.getCaps().maxTextureSize,s.randomTextureSize),u=[],p=0;p<h;++p)u.push(Math.random()),u.push(Math.random()),u.push(Math.random()),u.push(Math.random());o._randomTexture=new A.a(new Float32Array(u),h,1,g.a.TEXTUREFORMAT_RGBA,o._scene,!1,!1,g.a.TEXTURE_NEAREST_SAMPLINGMODE,g.a.TEXTURETYPE_FLOAT),o._randomTexture.wrapU=T.a.WRAP_ADDRESSMODE,o._randomTexture.wrapV=T.a.WRAP_ADDRESSMODE,u=[];for(p=0;p<h;++p)u.push(Math.random()),u.push(Math.random()),u.push(Math.random()),u.push(Math.random());return o._randomTexture2=new A.a(new Float32Array(u),h,1,g.a.TEXTUREFORMAT_RGBA,o._scene,!1,!1,g.a.TEXTURE_NEAREST_SAMPLINGMODE,g.a.TEXTURETYPE_FLOAT),o._randomTexture2.wrapU=T.a.WRAP_ADDRESSMODE,o._randomTexture2.wrapV=T.a.WRAP_ADDRESSMODE,o._randomTextureSize=h,o}return l.d(t,e),Object.defineProperty(t,"IsSupported",{get:function(){return!!C.a.LastCreatedEngine&&C.a.LastCreatedEngine.webGLVersion>1},enumerable:!0,configurable:!0}),t.prototype.getCapacity=function(){return this._capacity},Object.defineProperty(t.prototype,"activeParticleCount",{get:function(){return this._activeCount},set:function(e){this._activeCount=Math.min(e,this._capacity)},enumerable:!0,configurable:!0}),t.prototype.isReady=function(){return this._updateEffect?!!(this.emitter&&this._updateEffect.isReady()&&this._imageProcessingConfiguration.isReady()&&this._renderEffect.isReady()&&this.particleTexture&&this.particleTexture.isReady()):(this._recreateUpdateEffect(),this._recreateRenderEffect(),!1)},t.prototype.isStarted=function(){return this._started},t.prototype.start=function(e){var t=this;if(void 0===e&&(e=this.startDelay),!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";e?setTimeout(function(){t.start(0)},e):(this._started=!0,this._stopped=!1,this._preWarmDone=!1,this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this.getScene().beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop))},t.prototype.stop=function(){this._stopped=!0},t.prototype.reset=function(){this._releaseBuffers(),this._releaseVAOs(),this._currentActiveCount=0,this._targetIndex=0},t.prototype.getClassName=function(){return"GPUParticleSystem"},t.prototype._removeGradientAndTexture=function(t,i,r){return e.prototype._removeGradientAndTexture.call(this,t,i,r),this._releaseBuffers(),this},t.prototype.addColorGradient=function(e,t,i){this._colorGradients||(this._colorGradients=[]);var r=new P.c;return r.gradient=e,r.color1=t,this._colorGradients.push(r),this._colorGradients.sort(function(e,t){return e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0}),this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null),this._releaseBuffers(),this},t.prototype.removeColorGradient=function(e){return this._removeGradientAndTexture(e,this._colorGradients,this._colorGradientsTexture),this._colorGradientsTexture=null,this},t.prototype._addFactorGradient=function(e,t,i){var r=new P.d;r.gradient=t,r.factor1=i,e.push(r),e.sort(function(e,t){return e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0}),this._releaseBuffers()},t.prototype.addSizeGradient=function(e,t){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,t),this._sizeGradientsTexture&&(this._sizeGradientsTexture.dispose(),this._sizeGradientsTexture=null),this._releaseBuffers(),this},t.prototype.removeSizeGradient=function(e){return this._removeGradientAndTexture(e,this._sizeGradients,this._sizeGradientsTexture),this._sizeGradientsTexture=null,this},t.prototype.addAngularSpeedGradient=function(e,t){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,t),this._angularSpeedGradientsTexture&&(this._angularSpeedGradientsTexture.dispose(),this._angularSpeedGradientsTexture=null),this._releaseBuffers(),this},t.prototype.removeAngularSpeedGradient=function(e){return this._removeGradientAndTexture(e,this._angularSpeedGradients,this._angularSpeedGradientsTexture),this._angularSpeedGradientsTexture=null,this},t.prototype.addVelocityGradient=function(e,t){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,t),this._velocityGradientsTexture&&(this._velocityGradientsTexture.dispose(),this._velocityGradientsTexture=null),this._releaseBuffers(),this},t.prototype.removeVelocityGradient=function(e){return this._removeGradientAndTexture(e,this._velocityGradients,this._velocityGradientsTexture),this._velocityGradientsTexture=null,this},t.prototype.addLimitVelocityGradient=function(e,t){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,t),this._limitVelocityGradientsTexture&&(this._limitVelocityGradientsTexture.dispose(),this._limitVelocityGradientsTexture=null),this._releaseBuffers(),this},t.prototype.removeLimitVelocityGradient=function(e){return this._removeGradientAndTexture(e,this._limitVelocityGradients,this._limitVelocityGradientsTexture),this._limitVelocityGradientsTexture=null,this},t.prototype.addDragGradient=function(e,t){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,t),this._dragGradientsTexture&&(this._dragGradientsTexture.dispose(),this._dragGradientsTexture=null),this._releaseBuffers(),this},t.prototype.removeDragGradient=function(e){return this._removeGradientAndTexture(e,this._dragGradients,this._dragGradientsTexture),this._dragGradientsTexture=null,this},t.prototype.addEmitRateGradient=function(e,t,i){return this},t.prototype.removeEmitRateGradient=function(e){return this},t.prototype.addStartSizeGradient=function(e,t,i){return this},t.prototype.removeStartSizeGradient=function(e){return this},t.prototype.addColorRemapGradient=function(e,t,i){return this},t.prototype.removeColorRemapGradient=function(){return this},t.prototype.addAlphaRemapGradient=function(e,t,i){return this},t.prototype.removeAlphaRemapGradient=function(){return this},t.prototype.addRampGradient=function(e,t){return this},t.prototype.removeRampGradient=function(){return this},t.prototype.getRampGradients=function(){return null},Object.defineProperty(t.prototype,"useRampGradients",{get:function(){return!1},set:function(e){},enumerable:!0,configurable:!0}),t.prototype.addLifeTimeGradient=function(e,t,i){return this},t.prototype.removeLifeTimeGradient=function(e){return this},t.prototype._reset=function(){this._releaseBuffers()},t.prototype._createUpdateVAO=function(e){var t={};t.position=e.createVertexBuffer("position",0,3),t.age=e.createVertexBuffer("age",3,1),t.life=e.createVertexBuffer("life",4,1),t.seed=e.createVertexBuffer("seed",5,4),t.size=e.createVertexBuffer("size",9,3);var i=12;this._colorGradientsTexture||(t.color=e.createVertexBuffer("color",i,4),i+=4),t.direction=e.createVertexBuffer("direction",i,3),i+=3,this._isBillboardBased||(t.initialDirection=e.createVertexBuffer("initialDirection",i,3),i+=3),this._angularSpeedGradientsTexture?(t.angle=e.createVertexBuffer("angle",i,1),i+=1):(t.angle=e.createVertexBuffer("angle",i,2),i+=2),this._isAnimationSheetEnabled&&(t.cellIndex=e.createVertexBuffer("cellIndex",i,1),i+=1,this.spriteRandomStartCell&&(t.cellStartOffset=e.createVertexBuffer("cellStartOffset",i,1),i+=1)),this.noiseTexture&&(t.noiseCoordinates1=e.createVertexBuffer("noiseCoordinates1",i,3),i+=3,t.noiseCoordinates2=e.createVertexBuffer("noiseCoordinates2",i,3),i+=3);var r=this._engine.recordVertexArrayObject(t,null,this._updateEffect);return this._engine.bindArrayBuffer(null),r},t.prototype._createRenderVAO=function(e,t){var i={};i.position=e.createVertexBuffer("position",0,3,this._attributesStrideSize,!0),i.age=e.createVertexBuffer("age",3,1,this._attributesStrideSize,!0),i.life=e.createVertexBuffer("life",4,1,this._attributesStrideSize,!0),i.size=e.createVertexBuffer("size",9,3,this._attributesStrideSize,!0);var r=12;this._colorGradientsTexture||(i.color=e.createVertexBuffer("color",r,4,this._attributesStrideSize,!0),r+=4),this.billboardMode===G.BILLBOARDMODE_STRETCHED&&(i.direction=e.createVertexBuffer("direction",r,3,this._attributesStrideSize,!0)),r+=3,this._isBillboardBased||(i.initialDirection=e.createVertexBuffer("initialDirection",r,3,this._attributesStrideSize,!0),r+=3),i.angle=e.createVertexBuffer("angle",r,1,this._attributesStrideSize,!0),this._angularSpeedGradientsTexture?r++:r+=2,this._isAnimationSheetEnabled&&(i.cellIndex=e.createVertexBuffer("cellIndex",r,1,this._attributesStrideSize,!0),r+=1,this.spriteRandomStartCell&&(i.cellStartOffset=e.createVertexBuffer("cellStartOffset",r,1,this._attributesStrideSize,!0),r+=1)),this.noiseTexture&&(i.noiseCoordinates1=e.createVertexBuffer("noiseCoordinates1",r,3,this._attributesStrideSize,!0),r+=3,i.noiseCoordinates2=e.createVertexBuffer("noiseCoordinates2",r,3,this._attributesStrideSize,!0),r+=3),i.offset=t.createVertexBuffer("offset",0,2),i.uv=t.createVertexBuffer("uv",2,2);var n=this._engine.recordVertexArrayObject(i,null,this._renderEffect);return this._engine.bindArrayBuffer(null),n},t.prototype._initialize=function(e){if(void 0===e&&(e=!1),!this._buffer0||e){var t=this._scene.getEngine(),i=new Array;this._attributesStrideSize=21,this._targetIndex=0,this.isBillboardBased||(this._attributesStrideSize+=3),this._colorGradientsTexture&&(this._attributesStrideSize-=4),this._angularSpeedGradientsTexture&&(this._attributesStrideSize-=1),this._isAnimationSheetEnabled&&(this._attributesStrideSize+=1,this.spriteRandomStartCell&&(this._attributesStrideSize+=1)),this.noiseTexture&&(this._attributesStrideSize+=6);for(var r=0;r<this._capacity;r++)i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),i.push(0),i.push(0),i.push(0),this._colorGradientsTexture||(i.push(0),i.push(0),i.push(0),i.push(0)),i.push(0),i.push(0),i.push(0),this.isBillboardBased||(i.push(0),i.push(0),i.push(0)),i.push(0),this._angularSpeedGradientsTexture||i.push(0),this._isAnimationSheetEnabled&&(i.push(0),this.spriteRandomStartCell&&i.push(0)),this.noiseTexture&&(i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()));var n=new Float32Array([.5,.5,1,1,-.5,.5,0,1,-.5,-.5,0,0,.5,-.5,1,0]);this._buffer0=new v.Buffer(t,i,!1,this._attributesStrideSize),this._buffer1=new v.Buffer(t,i,!1,this._attributesStrideSize),this._spriteBuffer=new v.Buffer(t,n,!1,4),this._updateVAO=[],this._updateVAO.push(this._createUpdateVAO(this._buffer0)),this._updateVAO.push(this._createUpdateVAO(this._buffer1)),this._renderVAO=[],this._renderVAO.push(this._createRenderVAO(this._buffer1,this._spriteBuffer)),this._renderVAO.push(this._createRenderVAO(this._buffer0,this._spriteBuffer)),this._sourceBuffer=this._buffer0,this._targetBuffer=this._buffer1}},t.prototype._recreateUpdateEffect=function(){var e=this.particleEmitterType?this.particleEmitterType.getEffectDefines():"";this._isBillboardBased&&(e+="\n#define BILLBOARD"),this._colorGradientsTexture&&(e+="\n#define COLORGRADIENTS"),this._sizeGradientsTexture&&(e+="\n#define SIZEGRADIENTS"),this._angularSpeedGradientsTexture&&(e+="\n#define ANGULARSPEEDGRADIENTS"),this._velocityGradientsTexture&&(e+="\n#define VELOCITYGRADIENTS"),this._limitVelocityGradientsTexture&&(e+="\n#define LIMITVELOCITYGRADIENTS"),this._dragGradientsTexture&&(e+="\n#define DRAGGRADIENTS"),this.isAnimationSheetEnabled&&(e+="\n#define ANIMATESHEET",this.spriteRandomStartCell&&(e+="\n#define ANIMATESHEETRANDOMSTART")),this.noiseTexture&&(e+="\n#define NOISE"),this._updateEffect&&this._updateEffectOptions.defines===e||(this._updateEffectOptions.transformFeedbackVaryings=["outPosition","outAge","outLife","outSeed","outSize"],this._colorGradientsTexture||this._updateEffectOptions.transformFeedbackVaryings.push("outColor"),this._updateEffectOptions.transformFeedbackVaryings.push("outDirection"),this._isBillboardBased||this._updateEffectOptions.transformFeedbackVaryings.push("outInitialDirection"),this._updateEffectOptions.transformFeedbackVaryings.push("outAngle"),this.isAnimationSheetEnabled&&(this._updateEffectOptions.transformFeedbackVaryings.push("outCellIndex"),this.spriteRandomStartCell&&this._updateEffectOptions.transformFeedbackVaryings.push("outCellStartOffset")),this.noiseTexture&&(this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates1"),this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates2")),this._updateEffectOptions.defines=e,this._updateEffect=new M.a("gpuUpdateParticles",this._updateEffectOptions,this._scene.getEngine()))},t.prototype._recreateRenderEffect=function(){var e="";if(this._scene.clipPlane&&(e="\n#define CLIPPLANE"),this._scene.clipPlane2&&(e="\n#define CLIPPLANE2"),this._scene.clipPlane3&&(e="\n#define CLIPPLANE3"),this._scene.clipPlane4&&(e="\n#define CLIPPLANE4"),this.blendMode===G.BLENDMODE_MULTIPLY&&(e="\n#define BLENDMULTIPLYMODE"),this._isBillboardBased)switch(e+="\n#define BILLBOARD",this.billboardMode){case G.BILLBOARDMODE_Y:e+="\n#define BILLBOARDY";break;case G.BILLBOARDMODE_STRETCHED:e+="\n#define BILLBOARDSTRETCHED";break;case G.BILLBOARDMODE_ALL:}if(this._colorGradientsTexture&&(e+="\n#define COLORGRADIENTS"),this.isAnimationSheetEnabled&&(e+="\n#define ANIMATESHEET"),this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e+="\n"+this._imageProcessingConfigurationDefines.toString()),!this._renderEffect||this._renderEffect.defines!==e){var t=["view","projection","colorDead","invView","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","sheetInfos","translationPivot","eyePosition"],i=["textureSampler","colorGradientSampler"];o.a&&(o.a.PrepareUniforms(t,this._imageProcessingConfigurationDefines),o.a.PrepareSamplers(i,this._imageProcessingConfigurationDefines)),this._renderEffect=new M.a("gpuRenderParticles",["position","age","life","size","color","offset","uv","direction","initialDirection","angle","cellIndex"],t,i,this._scene.getEngine(),e)}},t.prototype.animate=function(e){void 0===e&&(e=!1),this._timeDelta=this.updateSpeed*(e?this.preWarmStepOffset:this._scene.getAnimationRatio()),this._actualFrame+=this._timeDelta,this._stopped||this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()},t.prototype._createFactorGradientTexture=function(e,t){var i=this[t];if(e&&e.length&&!i){for(var r=new Float32Array(this._rawTextureWidth),n=0;n<this._rawTextureWidth;n++){var o=n/this._rawTextureWidth;P.h.GetCurrentGradient(o,e,function(e,t,i){r[n]=a.a.Lerp(e.factor1,t.factor1,i)})}this[t]=A.a.CreateRTexture(r,this._rawTextureWidth,1,this._scene,!1,!1,T.a.NEAREST_SAMPLINGMODE)}},t.prototype._createSizeGradientTexture=function(){this._createFactorGradientTexture(this._sizeGradients,"_sizeGradientsTexture")},t.prototype._createAngularSpeedGradientTexture=function(){this._createFactorGradientTexture(this._angularSpeedGradients,"_angularSpeedGradientsTexture")},t.prototype._createVelocityGradientTexture=function(){this._createFactorGradientTexture(this._velocityGradients,"_velocityGradientsTexture")},t.prototype._createLimitVelocityGradientTexture=function(){this._createFactorGradientTexture(this._limitVelocityGradients,"_limitVelocityGradientsTexture")},t.prototype._createDragGradientTexture=function(){this._createFactorGradientTexture(this._dragGradients,"_dragGradientsTexture")},t.prototype._createColorGradientTexture=function(){if(this._colorGradients&&this._colorGradients.length&&!this._colorGradientsTexture){for(var e=new Uint8Array(4*this._rawTextureWidth),t=n.Tmp.Color4[0],i=0;i<this._rawTextureWidth;i++){var r=i/this._rawTextureWidth;P.h.GetCurrentGradient(r,this._colorGradients,function(r,o,s){n.Color4.LerpToRef(r.color1,o.color1,s,t),e[4*i]=255*t.r,e[4*i+1]=255*t.g,e[4*i+2]=255*t.b,e[4*i+3]=255*t.a})}this._colorGradientsTexture=A.a.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,T.a.NEAREST_SAMPLINGMODE)}},t.prototype.render=function(e){if(void 0===e&&(e=!1),!this._started)return 0;if(this._createColorGradientTexture(),this._createSizeGradientTexture(),this._createAngularSpeedGradientTexture(),this._createVelocityGradientTexture(),this._createLimitVelocityGradientTexture(),this._createDragGradientTexture(),this._recreateUpdateEffect(),this._recreateRenderEffect(),!this.isReady())return 0;if(!e){if(!this._preWarmDone&&this.preWarmCycles){for(var t=0;t<this.preWarmCycles;t++)this.animate(!0),this.render(!0);this._preWarmDone=!0}if(this._currentRenderId===this._scene.getFrameId())return 0;this._currentRenderId=this._scene.getFrameId()}if(this._initialize(),this._accumulatedCount+=this.emitRate*this._timeDelta,this._accumulatedCount>1){var i=0|this._accumulatedCount;this._accumulatedCount-=i,this._currentActiveCount=Math.min(this._activeCount,this._currentActiveCount+i)}if(!this._currentActiveCount)return 0;var r;if(this._engine.enableEffect(this._updateEffect),this._engine.setState(!1),this._updateEffect.setFloat("currentCount",this._currentActiveCount),this._updateEffect.setFloat("timeDelta",this._timeDelta),this._updateEffect.setFloat("stopFactor",this._stopped?0:1),this._updateEffect.setTexture("randomSampler",this._randomTexture),this._updateEffect.setTexture("randomSampler2",this._randomTexture2),this._updateEffect.setFloat2("lifeTime",this.minLifeTime,this.maxLifeTime),this._updateEffect.setFloat2("emitPower",this.minEmitPower,this.maxEmitPower),this._colorGradientsTexture||(this._updateEffect.setDirectColor4("color1",this.color1),this._updateEffect.setDirectColor4("color2",this.color2)),this._updateEffect.setFloat2("sizeRange",this.minSize,this.maxSize),this._updateEffect.setFloat4("scaleRange",this.minScaleX,this.maxScaleX,this.minScaleY,this.maxScaleY),this._updateEffect.setFloat4("angleRange",this.minAngularSpeed,this.maxAngularSpeed,this.minInitialRotation,this.maxInitialRotation),this._updateEffect.setVector3("gravity",this.gravity),this._sizeGradientsTexture&&this._updateEffect.setTexture("sizeGradientSampler",this._sizeGradientsTexture),this._angularSpeedGradientsTexture&&this._updateEffect.setTexture("angularSpeedGradientSampler",this._angularSpeedGradientsTexture),this._velocityGradientsTexture&&this._updateEffect.setTexture("velocityGradientSampler",this._velocityGradientsTexture),this._limitVelocityGradientsTexture&&(this._updateEffect.setTexture("limitVelocityGradientSampler",this._limitVelocityGradientsTexture),this._updateEffect.setFloat("limitVelocityDamping",this.limitVelocityDamping)),this._dragGradientsTexture&&this._updateEffect.setTexture("dragGradientSampler",this._dragGradientsTexture),this.particleEmitterType&&this.particleEmitterType.applyToShader(this._updateEffect),this._isAnimationSheetEnabled&&this._updateEffect.setFloat3("cellInfos",this.startSpriteCellID,this.endSpriteCellID,this.spriteCellChangeSpeed),this.noiseTexture&&(this._updateEffect.setTexture("noiseSampler",this.noiseTexture),this._updateEffect.setVector3("noiseStrength",this.noiseStrength)),this.emitter.position){r=this.emitter.getWorldMatrix()}else{var o=this.emitter;r=n.Matrix.Translation(o.x,o.y,o.z)}if(this._updateEffect.setMatrix("emitterWM",r),this._engine.bindVertexArrayObject(this._updateVAO[this._targetIndex],null),this._engine.bindTransformFeedbackBuffer(this._targetBuffer.getBuffer()),this._engine.setRasterizerState(!1),this._engine.beginTransformFeedback(!0),this._engine.drawArraysType(E.a.PointListDrawMode,0,this._currentActiveCount),this._engine.endTransformFeedback(),this._engine.setRasterizerState(!0),this._engine.bindTransformFeedbackBuffer(null),!e){this._engine.enableEffect(this._renderEffect);var s=this._scene.getViewMatrix();if(this._renderEffect.setMatrix("view",s),this._renderEffect.setMatrix("projection",this._scene.getProjectionMatrix()),this._renderEffect.setTexture("textureSampler",this.particleTexture),this._renderEffect.setVector2("translationPivot",this.translationPivot),this._colorGradientsTexture?this._renderEffect.setTexture("colorGradientSampler",this._colorGradientsTexture):this._renderEffect.setDirectColor4("colorDead",this.colorDead),this._isAnimationSheetEnabled&&this.particleTexture){var a=this.particleTexture.getBaseSize();this._renderEffect.setFloat3("sheetInfos",this.spriteCellWidth/a.width,this.spriteCellHeight/a.height,a.width/this.spriteCellWidth)}if(this._isBillboardBased){var c=this._scene.activeCamera;this._renderEffect.setVector3("eyePosition",c.globalPosition)}if(this._scene.clipPlane||this._scene.clipPlane2||this._scene.clipPlane3||this._scene.clipPlane4){var h=s.clone();h.invert(),this._renderEffect.setMatrix("invView",h),x.a.BindClipPlane(this._renderEffect,this._scene)}switch(this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._renderEffect),this.blendMode){case G.BLENDMODE_ADD:this._engine.setAlphaMode(g.a.ALPHA_ADD);break;case G.BLENDMODE_ONEONE:this._engine.setAlphaMode(g.a.ALPHA_ONEONE);break;case G.BLENDMODE_STANDARD:this._engine.setAlphaMode(g.a.ALPHA_COMBINE);break;case G.BLENDMODE_MULTIPLY:this._engine.setAlphaMode(g.a.ALPHA_MULTIPLY)}this.forceDepthWrite&&this._engine.setDepthWrite(!0),this._engine.bindVertexArrayObject(this._renderVAO[this._targetIndex],null),this._engine.drawArraysType(E.a.TriangleFanDrawMode,0,4,this._currentActiveCount),this._engine.setAlphaMode(g.a.ALPHA_DISABLE)}this._targetIndex++,2===this._targetIndex&&(this._targetIndex=0);var l=this._sourceBuffer;return this._sourceBuffer=this._targetBuffer,this._targetBuffer=l,this._currentActiveCount},t.prototype.rebuild=function(){this._initialize(!0)},t.prototype._releaseBuffers=function(){this._buffer0&&(this._buffer0.dispose(),this._buffer0=null),this._buffer1&&(this._buffer1.dispose(),this._buffer1=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null)},t.prototype._releaseVAOs=function(){if(this._updateVAO){for(var e=0;e<this._updateVAO.length;e++)this._engine.releaseVertexArrayObject(this._updateVAO[e]);this._updateVAO=[];for(e=0;e<this._renderVAO.length;e++)this._engine.releaseVertexArrayObject(this._renderVAO[e]);this._renderVAO=[]}},t.prototype.dispose=function(e){void 0===e&&(e=!0);var t=this._scene.particleSystems.indexOf(this);t>-1&&this._scene.particleSystems.splice(t,1),this._releaseBuffers(),this._releaseVAOs(),this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null),this._sizeGradientsTexture&&(this._sizeGradientsTexture.dispose(),this._sizeGradientsTexture=null),this._angularSpeedGradientsTexture&&(this._angularSpeedGradientsTexture.dispose(),this._angularSpeedGradientsTexture=null),this._velocityGradientsTexture&&(this._velocityGradientsTexture.dispose(),this._velocityGradientsTexture=null),this._limitVelocityGradientsTexture&&(this._limitVelocityGradientsTexture.dispose(),this._limitVelocityGradientsTexture=null),this._dragGradientsTexture&&(this._dragGradientsTexture.dispose(),this._dragGradientsTexture=null),this._randomTexture&&(this._randomTexture.dispose(),this._randomTexture=null),this._randomTexture2&&(this._randomTexture2.dispose(),this._randomTexture2=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()},t.prototype.clone=function(e,i){var r=new t(e,{capacity:this._capacity,randomTextureSize:this._randomTextureSize},this._scene);return s.a.DeepCopy(this,r),void 0===i&&(i=this.emitter),r.emitter=i,this.particleTexture&&(r.particleTexture=new T.a(this.particleTexture.url,this._scene)),r},t.prototype.serialize=function(){var e={};return G._Serialize(e,this),e.activeParticleCount=this.activeParticleCount,e},t.Parse=function(e,i,r,n){void 0===n&&(n=!1);var o=new t(e.name,{capacity:e.capacity,randomTextureSize:e.randomTextureSize},i);return e.activeParticleCount&&(o.activeParticleCount=e.activeParticleCount),G._Parse(e,o,i,r),e.preventAutoStart&&(o.preventAutoStart=e.preventAutoStart),n||o.preventAutoStart||o.start(),o},t}(y)),L=i(28),V=i(31),N=(function(){}(),function(){function e(){this.systems=new Array}return Object.defineProperty(e.prototype,"emitterNode",{get:function(){return this._emitterNode},enumerable:!0,configurable:!0}),e.prototype.setEmitterAsSphere=function(e,t,i){this._emitterNode&&this._emitterNode.dispose(),this._emitterCreationOptions={kind:"Sphere",options:e,renderingGroupId:t};var r=L.MeshBuilder.CreateSphere("emitterSphere",{diameter:e.diameter,segments:e.segments},i);r.renderingGroupId=t;var n=new V.StandardMaterial("emitterSphereMaterial",i);n.emissiveColor=e.color,r.material=n;for(var o=0,s=this.systems;o<s.length;o++){s[o].emitter=r}this._emitterNode=r},e.prototype.start=function(e){for(var t=0,i=this.systems;t<i.length;t++){var r=i[t];e&&(r.emitter=e),r.start()}},e.prototype.dispose=function(){for(var e=0,t=this.systems;e<t.length;e++){t[e].dispose()}this.systems=[],this._emitterNode&&(this._emitterNode.dispose(),this._emitterNode=null)},e.prototype.serialize=function(){for(var e={systems:[]},t=0,i=this.systems;t<i.length;t++){var r=i[t];e.systems.push(r.serialize())}return this._emitterNode&&(e.emitter=this._emitterCreationOptions),e},e.Parse=function(t,i,r){void 0===r&&(r=!1);var o=new e,s=g.a.PARTICLES_BaseAssetsUrl+"/textures/";i=i||C.a.LastCreatedScene;for(var a=0,c=t.systems;a<c.length;a++){var h=c[a];o.systems.push(r?w.Parse(h,i,s,!0):G.Parse(h,i,s,!0))}if(t.emitter){var l=t.emitter.options;switch(t.emitter.kind){case"Sphere":o.setEmitterAsSphere({diameter:l.diameter,segments:l.segments,color:n.Color3.FromArray(l.color)},t.emitter.renderingGroupId,i)}}return o},e}()),z=function(){function e(){}return e.CreateDefault=function(e,t,i,r){var o;return void 0===t&&(t=500),void 0===r&&(r=!1),(o=r?new w("default system",{capacity:t},i):new G("default system",t,i)).emitter=e,o.particleTexture=new T.a("https://www.babylonjs.com/assets/Flare.png",o.getScene()),o.createConeEmitter(.1,Math.PI/4),o.color1=new n.Color4(1,1,1,1),o.color2=new n.Color4(1,1,1,1),o.colorDead=new n.Color4(1,1,1,0),o.minSize=.1,o.maxSize=.1,o.minEmitPower=2,o.maxEmitPower=2,o.updateSpeed=1/60,o.emitRate=30,o},e.CreateAsync=function(t,i,r){void 0===r&&(r=!1),i||(i=C.a.LastCreatedScene);var n={};return i._addPendingData(n),new Promise(function(o,s){if(r&&!w.IsSupported)return i._removePendingData(n),s("Particle system with GPU is not supported.");P.h.LoadFile(e.BaseAssetsUrl+"/systems/"+t+".json",function(e){i._removePendingData(n);var t=JSON.parse(e.toString());return o(N.Parse(t,i,r))},void 0,void 0,void 0,function(){return i._removePendingData(n),s("An error occured while the creation of your particle system. Check if your type '"+t+"' exists.")})})},e.ExportSet=function(e){for(var t=new N,i=0,r=e;i<r.length;i++){var n=r[i];t.systems.push(n)}return t},e.BaseAssetsUrl=g.a.PARTICLES_BaseAssetsUrl,e}(),j=i(38),k=i(11),U=i(15);j.a.AddParser(U.a.NAME_PARTICLESYSTEM,function(e,t,i,r){var n=j.a.GetIndividualParser(U.a.NAME_PARTICLESYSTEM);if(n&&void 0!==e.particleSystems&&null!==e.particleSystems)for(var o=0,s=e.particleSystems.length;o<s;o++){var a=e.particleSystems[o];i.particleSystems.push(n(a,t,r))}}),j.a.AddIndividualParser(U.a.NAME_PARTICLESYSTEM,function(e,t,i){return e.activeParticleCount?w.Parse(e,t,i):G.Parse(e,t,i)}),k.Engine.prototype.createEffectForParticles=function(e,t,i,r,n,o,s){void 0===t&&(t=[]),void 0===i&&(i=[]),void 0===r&&(r="");var a=G._GetAttributeNamesOrOptions(),c=G._GetEffectCreationOptions();return-1===r.indexOf(" BILLBOARD")&&(r+="\n#define BILLBOARD\n"),-1===i.indexOf("diffuseSampler")&&i.push("diffuseSampler"),this.createEffect({vertex:"particles",fragmentElement:e},a,c.concat(t),i,r,n,o,s)},I.Mesh.prototype.getEmittedParticleSystems=function(){for(var e=new Array,t=0;t<this.getScene().particleSystems.length;t++){var i=this.getScene().particleSystems[t];i.emitter===this&&e.push(i)}return e},I.Mesh.prototype.getHierarchyEmittedParticleSystems=function(){var e=new Array,t=this.getDescendants();t.push(this);for(var i=0;i<this.getScene().particleSystems.length;i++){var r=this.getScene().particleSystems[i],n=r.emitter;n.position&&-1!==t.indexOf(n)&&e.push(r)}return e};var W=i(53),H=i(114),Q=function(){function e(e,t,i,r,o,s,a,c){void 0===c&&(c=null),this.idx=0,this.color=new n.Color4(1,1,1,1),this.position=n.Vector3.Zero(),this.rotation=n.Vector3.Zero(),this.scaling=n.Vector3.One(),this.uvs=new n.Vector4(0,0,1,1),this.velocity=n.Vector3.Zero(),this.pivot=n.Vector3.Zero(),this.translateFromPivot=!1,this.alive=!0,this.isVisible=!0,this._pos=0,this._ind=0,this.shapeId=0,this.idxInShape=0,this._stillInvisible=!1,this._rotationMatrix=[1,0,0,0,1,0,0,0,1],this.parentId=null,this.cullingStrategy=S.a.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this._globalPosition=n.Vector3.Zero(),this.idx=e,this._pos=t,this._ind=i,this._model=r,this.shapeId=o,this.idxInShape=s,this._sps=a,c&&(this._modelBoundingInfo=c,this._boundingInfo=new W.a(c.minimum,c.maximum))}return Object.defineProperty(e.prototype,"scale",{get:function(){return this.scaling},set:function(e){this.scaling=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"quaternion",{get:function(){return this.rotationQuaternion},set:function(e){this.rotationQuaternion=e},enumerable:!0,configurable:!0}),e.prototype.intersectsMesh=function(e){return!(!this._boundingInfo||!e._boundingInfo)&&(this._sps._bSphereOnly?H.a.Intersects(this._boundingInfo.boundingSphere,e._boundingInfo.boundingSphere):this._boundingInfo.intersects(e._boundingInfo,!1))},e.prototype.isInFrustum=function(e){return null!==this._boundingInfo&&this._boundingInfo.isInFrustum(e,this.cullingStrategy)},e.prototype.getRotationMatrix=function(e){var t;if(this.rotationQuaternion)t=this.rotationQuaternion;else{t=n.Tmp.Quaternion[0];var i=this.rotation;n.Quaternion.RotationYawPitchRollToRef(i.y,i.x,i.z,t)}t.toRotationMatrix(e)},e}(),J=function(){return function(e,t,i,r,n,o){this._indicesLength=0,this.shapeID=e,this._shape=t,this._indicesLength=i,this._shapeUV=r,this._positionFunction=n,this._vertexFunction=o}}(),Y=function(){return function(){this.ind=0,this.indicesLength=0,this.sqDistance=0}}(),X=i(24),Z=function(e,t){return t.sqDistance-e.sqDistance},K=function(){function e(e,t,i){this.particles=new Array,this.nbParticles=0,this.billboard=!1,this.recomputeNormals=!0,this.counter=0,this.vars={},this._bSphereOnly=!1,this._bSphereRadiusFactor=1,this._positions=new Array,this._indices=new Array,this._normals=new Array,this._colors=new Array,this._uvs=new Array,this._index=0,this._updatable=!0,this._pickable=!1,this._isVisibilityBoxLocked=!1,this._alwaysVisible=!1,this._depthSort=!1,this._shapeCounter=0,this._copy=new Q(0,0,0,null,0,0,this),this._color=new n.Color4(0,0,0,0),this._computeParticleColor=!0,this._computeParticleTexture=!0,this._computeParticleRotation=!0,this._computeParticleVertex=!1,this._computeBoundingBox=!1,this._depthSortParticles=!0,this._mustUnrotateFixedNormals=!1,this._particlesIntersect=!1,this._needs32Bits=!1,this.name=e,this._scene=t||C.a.LastCreatedScene,this._camera=t.activeCamera,this._pickable=!!i&&i.isPickable,this._depthSort=!!i&&i.enableDepthSort,this._particlesIntersect=!!i&&i.particleIntersection,this._bSphereOnly=!!i&&i.boundingSphereOnly,this._bSphereRadiusFactor=i&&i.bSphereRadiusFactor?i.bSphereRadiusFactor:1,i&&void 0!==i.updatable?this._updatable=i.updatable:this._updatable=!0,this._pickable&&(this.pickedParticles=[]),this._depthSort&&(this.depthSortedParticles=[])}return e.prototype.buildMesh=function(){if(0===this.nbParticles){var e=L.MeshBuilder.CreateDisc("",{radius:1,tessellation:3},this._scene);this.addShape(e,1),e.dispose()}this._indices32=this._needs32Bits?new Uint32Array(this._indices):new Uint16Array(this._indices),this._positions32=new Float32Array(this._positions),this._uvs32=new Float32Array(this._uvs),this._colors32=new Float32Array(this._colors),this.recomputeNormals&&X.VertexData.ComputeNormals(this._positions32,this._indices32,this._normals),this._normals32=new Float32Array(this._normals),this._fixedNormal32=new Float32Array(this._normals),this._mustUnrotateFixedNormals&&this._unrotateFixedNormals();var t=new X.VertexData;t.indices=this._depthSort?this._indices:this._indices32,t.set(this._positions32,v.VertexBuffer.PositionKind),t.set(this._normals32,v.VertexBuffer.NormalKind),this._uvs32.length>0&&t.set(this._uvs32,v.VertexBuffer.UVKind),this._colors32.length>0&&t.set(this._colors32,v.VertexBuffer.ColorKind);var i=new I.Mesh(this.name,this._scene);return t.applyToMesh(i,this._updatable),this.mesh=i,this.mesh.isPickable=this._pickable,this._depthSort||(this._indices=null),this._positions=null,this._normals=null,this._uvs=null,this._colors=null,this._updatable||(this.particles.length=0),i},e.prototype.digest=function(e,t){var i=t&&t.facetNb||1,r=t&&t.number||0,o=t&&t.delta||0,s=e.getVerticesData(v.VertexBuffer.PositionKind),a=e.getIndices(),c=e.getVerticesData(v.VertexBuffer.UVKind),h=e.getVerticesData(v.VertexBuffer.ColorKind),l=e.getVerticesData(v.VertexBuffer.NormalKind),u=0,p=a.length/3;r?(r=r>p?p:r,i=Math.round(p/r),o=0):i=i>p?p:i;for(var d=[],f=[],_=[],m=[],g=n.Vector3.Zero(),y=i;u<p;){u>p-(i=y+Math.floor((1+o)*Math.random()))&&(i=p-u),d.length=0,f.length=0,_.length=0,m.length=0;for(var P=0,b=3*u;b<3*(u+i);b++){f.push(P);var S=a[b];d.push(s[3*S],s[3*S+1],s[3*S+2]),c&&_.push(c[2*S],c[2*S+1]),h&&m.push(h[4*S],h[4*S+1],h[4*S+2],h[4*S+3]),P++}var E,x,T=this.nbParticles,A=this._posToShape(d),R=this._uvsToShapeUV(_);for(E=0;E<A.length;E++)g.addInPlace(A[E]);for(g.scaleInPlace(1/A.length),E=0;E<A.length;E++)A[E].subtractInPlace(g);this._particlesIntersect&&(x=new W.a(g,g));var C=new J(this._shapeCounter,A,3*i,R,null,null),O=this._positions.length,B=this._indices.length;this._meshBuilder(this._index,A,this._positions,f,this._indices,_,this._uvs,m,this._colors,l,this._normals,T,0,null),this._addParticle(T,O,B,C,this._shapeCounter,0,x),this.particles[this.nbParticles].position.addInPlace(g),this._index+=A.length,T++,this.nbParticles++,this._shapeCounter++,u+=i}return this},e.prototype._unrotateFixedNormals=function(){for(var e=0,t=0,i=n.Tmp.Vector3[0],r=n.Tmp.Quaternion[0],o=n.Tmp.Matrix[0],s=0;s<this.particles.length;s++){var a=this.particles[s],c=a._model._shape;if(a.rotationQuaternion)a.rotationQuaternion.conjugateToRef(r);else{var h=a.rotation;n.Quaternion.RotationYawPitchRollToRef(h.y,h.x,h.z,r),r.conjugateInPlace()}r.toRotationMatrix(o);for(var l=0;l<c.length;l++)t=e+3*l,n.Vector3.TransformNormalFromFloatsToRef(this._normals32[t],this._normals32[t+1],this._normals32[t+2],o,i),i.toArray(this._fixedNormal32,t);e=t+3}},e.prototype._resetCopy=function(){var e=this._copy;e.position.setAll(0),e.rotation.setAll(0),e.rotationQuaternion=null,e.scaling.setAll(1),e.uvs.copyFromFloats(0,0,1,1),e.color=null,e.translateFromPivot=!1},e.prototype._meshBuilder=function(e,t,i,r,o,s,a,c,h,l,u,p,d,f){var _,m=0,g=0,y=0;this._resetCopy();var P=this._copy;f&&f.positionFunction&&(f.positionFunction(P,p,d),this._mustUnrotateFixedNormals=!0);var b=n.Tmp.Matrix[0],v=n.Tmp.Vector3[0],S=n.Tmp.Vector3[1],E=n.Tmp.Vector3[2],x=n.Tmp.Vector3[3];for(P.getRotationMatrix(b),P.pivot.multiplyToRef(P.scaling,x),P.translateFromPivot?E.setAll(0):E.copyFrom(x),_=0;_<t.length;_++){if(v.copyFrom(t[_]),f&&f.vertexFunction&&f.vertexFunction(P,v,_),v.multiplyInPlace(P.scaling).subtractInPlace(x),n.Vector3.TransformCoordinatesToRef(v,b,S),S.addInPlace(E).addInPlace(P.position),i.push(S.x,S.y,S.z),s){var T=P.uvs;a.push((T.z-T.x)*s[m]+T.x,(T.w-T.y)*s[m+1]+T.y),m+=2}if(P.color)this._color=P.color;else{var A=this._color;c&&void 0!==c[g]?(A.r=c[g],A.g=c[g+1],A.b=c[g+2],A.a=c[g+3]):(A.r=1,A.g=1,A.b=1,A.a=1)}h.push(this._color.r,this._color.g,this._color.b,this._color.a),g+=4,!this.recomputeNormals&&l&&(v.x=l[y],v.y=l[y+1],v.z=l[y+2],n.Vector3.TransformNormalToRef(v,b,v),u.push(v.x,v.y,v.z),y+=3)}for(_=0;_<r.length;_++){var R=e+r[_];o.push(R),R>65535&&(this._needs32Bits=!0)}if(this._pickable){var C=r.length/3;for(_=0;_<C;_++)this.pickedParticles.push({idx:p,faceId:_})}return this._depthSort&&this.depthSortedParticles.push(new Y),P},e.prototype._posToShape=function(e){for(var t=[],i=0;i<e.length;i+=3)t.push(n.Vector3.FromArray(e,i));return t},e.prototype._uvsToShapeUV=function(e){var t=[];if(e)for(var i=0;i<e.length;i++)t.push(e[i]);return t},e.prototype._addParticle=function(e,t,i,r,n,o,s){void 0===s&&(s=null);var a=new Q(e,t,i,r,n,o,this,s);return this.particles.push(a),a},e.prototype.addShape=function(e,t,i){var r,n=e.getVerticesData(v.VertexBuffer.PositionKind),o=e.getIndices(),s=e.getVerticesData(v.VertexBuffer.UVKind),a=e.getVerticesData(v.VertexBuffer.ColorKind),c=e.getVerticesData(v.VertexBuffer.NormalKind);this._particlesIntersect&&(r=e.getBoundingInfo());for(var h,l,u=this._posToShape(n),p=this._uvsToShapeUV(s),d=i?i.positionFunction:null,f=i?i.vertexFunction:null,_=new J(this._shapeCounter,u,o.length,p,d,f),m=this.nbParticles,g=0;g<t;g++){var y=this._positions.length,P=this._indices.length;l=this._meshBuilder(this._index,u,this._positions,o,this._indices,s,this._uvs,a,this._colors,c,this._normals,m,g,i),this._updatable&&((h=this._addParticle(m,y,P,_,this._shapeCounter,g,r)).position.copyFrom(l.position),h.rotation.copyFrom(l.rotation),l.rotationQuaternion&&h.rotationQuaternion&&h.rotationQuaternion.copyFrom(l.rotationQuaternion),l.color&&h.color&&h.color.copyFrom(l.color),h.scaling.copyFrom(l.scaling),h.uvs.copyFrom(l.uvs)),this._index+=u.length,m++}return this.nbParticles+=t,this._shapeCounter++,this._shapeCounter-1},e.prototype._rebuildParticle=function(e){this._resetCopy();var t=this._copy;e._model._positionFunction&&e._model._positionFunction(t,e.idx,e.idxInShape);var i=n.Tmp.Matrix[0],r=n.Tmp.Vector3[0],o=n.Tmp.Vector3[1],s=n.Tmp.Vector3[2],a=n.Tmp.Vector3[3];t.getRotationMatrix(i),e.pivot.multiplyToRef(e.scaling,a),t.translateFromPivot?s.copyFromFloats(0,0,0):s.copyFrom(a);for(var c=e._model._shape,h=0;h<c.length;h++)r.copyFrom(c[h]),e._model._vertexFunction&&e._model._vertexFunction(t,r,h),r.multiplyInPlace(t.scaling).subtractInPlace(a),n.Vector3.TransformCoordinatesToRef(r,i,o),o.addInPlace(s).addInPlace(t.position).toArray(this._positions32,e._pos+3*h);e.position.setAll(0),e.rotation.setAll(0),e.rotationQuaternion=null,e.scaling.setAll(1),e.uvs.setAll(0),e.pivot.setAll(0),e.translateFromPivot=!1,e.parentId=null},e.prototype.rebuildMesh=function(){for(var e=0;e<this.particles.length;e++)this._rebuildParticle(this.particles[e]);return this.mesh.updateVerticesData(v.VertexBuffer.PositionKind,this._positions32,!1,!1),this},e.prototype.setParticles=function(e,t,i){if(void 0===e&&(e=0),void 0===t&&(t=this.nbParticles-1),void 0===i&&(i=!0),!this._updatable)return this;this.beforeUpdateParticles();var r=n.Tmp.Matrix[0],o=n.Tmp.Matrix[1],s=this.mesh,a=this._colors32,c=this._positions32,h=this._normals32,l=this._uvs32,u=this._indices32,p=this._indices,d=this._fixedNormal32,f=n.Tmp.Vector3,_=f[5].copyFromFloats(1,0,0),m=f[6].copyFromFloats(0,1,0),g=f[7].copyFromFloats(0,0,1),y=f[8].setAll(Number.MAX_VALUE),P=f[9].setAll(-Number.MAX_VALUE),b=f[10].setAll(0);if((this.billboard||this._depthSort)&&(this.mesh.computeWorldMatrix(!0),this.mesh._worldMatrix.invertToRef(o)),this.billboard){var S=f[0];this._camera.getDirectionToRef(n.Axis.Z,S),n.Vector3.TransformNormalToRef(S,o,g),g.normalize();var E=this._camera.getViewMatrix(!0);n.Vector3.TransformNormalFromFloatsToRef(E.m[1],E.m[5],E.m[9],o,m),n.Vector3.CrossToRef(m,g,_),m.normalize(),_.normalize()}this._depthSort&&n.Vector3.TransformCoordinatesToRef(this._camera.globalPosition,o,b),n.Matrix.IdentityToRef(r);var x=0,T=0,A=0,R=0,C=0,O=0,B=0;if(this.mesh.isFacetDataEnabled&&(this._computeBoundingBox=!0),t=t>=this.nbParticles?this.nbParticles-1:t,this._computeBoundingBox&&(0!=e||t!=this.nbParticles-1)){var I=this.mesh._boundingInfo;I&&(y.copyFrom(I.minimum),P.copyFrom(I.maximum))}var D=(T=this.particles[e]._pos)/3|0;R=4*D,O=2*D;for(var F=e;F<=t;F++){var G=this.particles[F];this.updateParticle(G);var M=G._model._shape,w=G._model._shapeUV,L=G._rotationMatrix,V=G.position,N=G.rotation,z=G.scaling,j=G._globalPosition;if(this._depthSort&&this._depthSortParticles){var k=this.depthSortedParticles[F];k.ind=G._ind,k.indicesLength=G._model._indicesLength,k.sqDistance=n.Vector3.DistanceSquared(G.position,b)}if(!G.alive||G._stillInvisible&&!G.isVisible)T+=3*(B=M.length),R+=4*B,O+=2*B;else{if(G.isVisible){G._stillInvisible=!1;var U=f[12];if(G.pivot.multiplyToRef(z,U),this.billboard&&(N.x=0,N.y=0),(this._computeParticleRotation||this.billboard)&&G.getRotationMatrix(r),null!==G.parentId){var H=this.particles[G.parentId],Q=H._rotationMatrix,J=H._globalPosition,Y=V.x*Q[1]+V.y*Q[4]+V.z*Q[7],K=V.x*Q[0]+V.y*Q[3]+V.z*Q[6],q=V.x*Q[2]+V.y*Q[5]+V.z*Q[8];if(j.x=J.x+K,j.y=J.y+Y,j.z=J.z+q,this._computeParticleRotation||this.billboard){var $=r.m;L[0]=$[0]*Q[0]+$[1]*Q[3]+$[2]*Q[6],L[1]=$[0]*Q[1]+$[1]*Q[4]+$[2]*Q[7],L[2]=$[0]*Q[2]+$[1]*Q[5]+$[2]*Q[8],L[3]=$[4]*Q[0]+$[5]*Q[3]+$[6]*Q[6],L[4]=$[4]*Q[1]+$[5]*Q[4]+$[6]*Q[7],L[5]=$[4]*Q[2]+$[5]*Q[5]+$[6]*Q[8],L[6]=$[8]*Q[0]+$[9]*Q[3]+$[10]*Q[6],L[7]=$[8]*Q[1]+$[9]*Q[4]+$[10]*Q[7],L[8]=$[8]*Q[2]+$[9]*Q[5]+$[10]*Q[8]}}else if(j.x=V.x,j.y=V.y,j.z=V.z,this._computeParticleRotation||this.billboard){$=r.m;L[0]=$[0],L[1]=$[1],L[2]=$[2],L[3]=$[4],L[4]=$[5],L[5]=$[6],L[6]=$[8],L[7]=$[9],L[8]=$[10]}var ee=f[11];for(G.translateFromPivot?ee.setAll(0):ee.copyFrom(U),B=0;B<M.length;B++){x=T+3*B,A=R+4*B,C=O+2*B,(S=f[0]).copyFrom(M[B]),this._computeParticleVertex&&this.updateParticleVertex(S);var te=S.x*z.x-U.x,ie=S.y*z.y-U.y,re=S.z*z.z-U.z;K=te*L[0]+ie*L[3]+re*L[6],Y=te*L[1]+ie*L[4]+re*L[7],q=te*L[2]+ie*L[5]+re*L[8];K+=ee.x,Y+=ee.y,q+=ee.z;var ne=c[x]=j.x+_.x*K+m.x*Y+g.x*q,oe=c[x+1]=j.y+_.y*K+m.y*Y+g.y*q,se=c[x+2]=j.z+_.z*K+m.z*Y+g.z*q;if(this._computeBoundingBox&&(y.minimizeInPlaceFromFloats(ne,oe,se),P.maximizeInPlaceFromFloats(ne,oe,se)),!this._computeParticleVertex){var ae=d[x],ce=d[x+1],he=d[x+2],le=ae*L[0]+ce*L[3]+he*L[6],ue=ae*L[1]+ce*L[4]+he*L[7],pe=ae*L[2]+ce*L[5]+he*L[8];h[x]=_.x*le+m.x*ue+g.x*pe,h[x+1]=_.y*le+m.y*ue+g.y*pe,h[x+2]=_.z*le+m.z*ue+g.z*pe}if(this._computeParticleColor&&G.color){var de=G.color,fe=this._colors32;fe[A]=de.r,fe[A+1]=de.g,fe[A+2]=de.b,fe[A+3]=de.a}if(this._computeParticleTexture){var _e=G.uvs;l[C]=w[2*B]*(_e.z-_e.x)+_e.x,l[C+1]=w[2*B+1]*(_e.w-_e.y)+_e.y}}}else for(G._stillInvisible=!0,B=0;B<M.length;B++){if(A=R+4*B,C=O+2*B,c[x=T+3*B]=c[x+1]=c[x+2]=0,h[x]=h[x+1]=h[x+2]=0,this._computeParticleColor&&G.color){de=G.color;a[A]=de.r,a[A+1]=de.g,a[A+2]=de.b,a[A+3]=de.a}if(this._computeParticleTexture){_e=G.uvs;l[C]=w[2*B]*(_e.z-_e.x)+_e.x,l[C+1]=w[2*B+1]*(_e.w-_e.y)+_e.y}}if(this._particlesIntersect){var me=G._boundingInfo,ge=me.boundingBox,ye=me.boundingSphere,Pe=G._modelBoundingInfo;if(!this._bSphereOnly){var be=Pe.boundingBox.vectors,ve=f[1],Se=f[2];ve.setAll(Number.MAX_VALUE),Se.setAll(-Number.MAX_VALUE);for(var Ee=0;Ee<8;Ee++){var xe=be[Ee].x*z.x,Te=be[Ee].y*z.y,Ae=be[Ee].z*z.z,Re=(K=xe*L[0]+Te*L[3]+Ae*L[6],Y=xe*L[1]+Te*L[4]+Ae*L[7],q=xe*L[2]+Te*L[5]+Ae*L[8],V.x+_.x*K+m.x*Y+g.x*q),Ce=V.y+_.y*K+m.y*Y+g.y*q,Oe=V.z+_.z*K+m.z*Y+g.z*q;ve.minimizeInPlaceFromFloats(Re,Ce,Oe),Se.maximizeInPlaceFromFloats(Re,Ce,Oe)}ge.reConstruct(ve,Se,s._worldMatrix)}var Be=Pe.minimum.multiplyToRef(z,f[1]),Ie=Pe.maximum.multiplyToRef(z,f[2]),De=Ie.addToRef(Be,f[3]).scaleInPlace(.5).addInPlace(j),Fe=Ie.subtractToRef(Be,f[4]).scaleInPlace(.5*this._bSphereRadiusFactor),Ge=De.subtractToRef(Fe,f[1]),Me=De.addToRef(Fe,f[2]);ye.reConstruct(Ge,Me,s._worldMatrix)}T=x+3,R=A+4,O=C+2}}if(i){if(this._computeParticleColor&&s.updateVerticesData(v.VertexBuffer.ColorKind,a,!1,!1),this._computeParticleTexture&&s.updateVerticesData(v.VertexBuffer.UVKind,l,!1,!1),s.updateVerticesData(v.VertexBuffer.PositionKind,c,!1,!1),!s.areNormalsFrozen||s.isFacetDataEnabled){if(this._computeParticleVertex||s.isFacetDataEnabled){var we=s.isFacetDataEnabled?s.getFacetDataParameters():null;X.VertexData.ComputeNormals(c,u,h,we);for(var Le=0;Le<h.length;Le++)d[Le]=h[Le]}s.areNormalsFrozen||s.updateVerticesData(v.VertexBuffer.NormalKind,h,!1,!1)}if(this._depthSort&&this._depthSortParticles){var Ve=this.depthSortedParticles;Ve.sort(Z);for(var Ne=Ve.length,ze=0,je=0;je<Ne;je++){var ke=Ve[je].indicesLength,Ue=Ve[je].ind;for(Le=0;Le<ke;Le++)u[ze]=p[Ue+Le],ze++}s.updateIndices(u)}}return this._computeBoundingBox&&(s._boundingInfo?s._boundingInfo.reConstruct(y,P,s._worldMatrix):s._boundingInfo=new W.a(y,P,s._worldMatrix)),this.afterUpdateParticles(),this},e.prototype.dispose=function(){this.mesh.dispose(),this.vars=null,this._positions=null,this._indices=null,this._normals=null,this._uvs=null,this._colors=null,this._indices32=null,this._positions32=null,this._normals32=null,this._fixedNormal32=null,this._uvs32=null,this._colors32=null,this.pickedParticles=null},e.prototype.refreshVisibleSize=function(){return this._isVisibilityBoxLocked||this.mesh.refreshBoundingInfo(),this},e.prototype.setVisibilityBox=function(e){var t=e/2;this.mesh._boundingInfo=new W.a(new n.Vector3(-t,-t,-t),new n.Vector3(t,t,t))},Object.defineProperty(e.prototype,"isAlwaysVisible",{get:function(){return this._alwaysVisible},set:function(e){this._alwaysVisible=e,this.mesh.alwaysSelectAsActiveMesh=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isVisibilityBoxLocked",{get:function(){return this._isVisibilityBoxLocked},set:function(e){this._isVisibilityBoxLocked=e,this.mesh.getBoundingInfo().isLocked=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"computeParticleRotation",{get:function(){return this._computeParticleRotation},set:function(e){this._computeParticleRotation=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"computeParticleColor",{get:function(){return this._computeParticleColor},set:function(e){this._computeParticleColor=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"computeParticleTexture",{get:function(){return this._computeParticleTexture},set:function(e){this._computeParticleTexture=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"computeParticleVertex",{get:function(){return this._computeParticleVertex},set:function(e){this._computeParticleVertex=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"computeBoundingBox",{get:function(){return this._computeBoundingBox},set:function(e){this._computeBoundingBox=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"depthSortParticles",{get:function(){return this._depthSortParticles},set:function(e){this._depthSortParticles=e},enumerable:!0,configurable:!0}),e.prototype.initParticles=function(){},e.prototype.recycleParticle=function(e){return e},e.prototype.updateParticle=function(e){return e},e.prototype.updateParticleVertex=function(e){return e},e.prototype.beforeUpdateParticles=function(){},e.prototype.afterUpdateParticles=function(){},e}();i.d(t,"a",function(){return y}),i.d(t,"b",function(){return c}),i.d(t,"c",function(){return h}),i.d(t,"e",function(){return u}),i.d(t,"d",function(){return p}),i.d(t,"h",function(){return d}),i.d(t,"n",function(){return f}),i.d(t,"r",function(){return _}),i.d(t,"q",function(){return m}),i.d(t,"g",function(){return w}),i.d(t,"j",function(){return B}),i.d(t,"k",function(){return z}),i.d(t,"l",function(){return G}),i.d(t,"u",function(){return 42}),i.d(t,"m",function(){return N}),i.d(t,"o",function(){return Q}),i.d(t,"i",function(){return J}),i.d(t,"f",function(){return Y}),i.d(t,"p",function(){return K}),i.d(t,"t",function(){return r}),i.d(t,"s",function(){return D})},252:function(e,t,i){"use strict";var r=i(93),n=i(9),o=i(7),s=i(23),a=i(15),c=i(19),h=i(45);c.Scene.prototype.getPhysicsEngine=function(){return this._physicsEngine},c.Scene.prototype.enablePhysics=function(e,t){if(void 0===e&&(e=null),this._physicsEngine)return!0;var i=this._getComponent(a.a.NAME_PHYSICSENGINE);i||(i=new p(this),this._addComponent(i));try{return this._physicsEngine=new r.a(e,t),!0}catch(e){return n.a.Error(e.message),!1}},c.Scene.prototype.disablePhysicsEngine=function(){this._physicsEngine&&(this._physicsEngine.dispose(),this._physicsEngine=null)},c.Scene.prototype.isPhysicsEnabled=function(){return void 0!==this._physicsEngine},c.Scene.prototype.deleteCompoundImpostor=function(e){var t=e.parts[0].mesh;t.physicsImpostor&&(t.physicsImpostor.dispose(),t.physicsImpostor=null)},c.Scene.prototype._advancePhysicsEngineStep=function(e){this._physicsEngine&&(this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(e/1e3),this.onAfterPhysicsObservable.notifyObservers(this))},Object.defineProperty(s.a.prototype,"physicsImpostor",{get:function(){return this._physicsImpostor},set:function(e){var t=this;this._physicsImpostor!==e&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsImpostor=e,e&&(this._disposePhysicsObserver=this.onDisposeObservable.add(function(){t.physicsImpostor&&(t.physicsImpostor.dispose(),t.physicsImpostor=null)})))},enumerable:!0,configurable:!0}),s.a.prototype.getPhysicsImpostor=function(){return this.physicsImpostor},s.a.prototype.applyImpulse=function(e,t){return this.physicsImpostor?(this.physicsImpostor.applyImpulse(e,t),this):this},s.a.prototype.setPhysicsLinkWith=function(e,t,i,r){return this.physicsImpostor&&e.physicsImpostor?(this.physicsImpostor.createJoint(e.physicsImpostor,h.e.HingeJoint,{mainPivot:t,connectedPivot:i,nativeParams:r}),this):this};var l,u,p=function(){function e(e){var t=this;this.name=a.a.NAME_PHYSICSENGINE,this.scene=e,this.scene.onBeforePhysicsObservable=new o.c,this.scene.onAfterPhysicsObservable=new o.c,this.scene.getDeterministicFrameTime=function(){return t.scene._physicsEngine?1e3*t.scene._physicsEngine.getTimeStep():1e3/60}}return e.prototype.register=function(){},e.prototype.rebuild=function(){},e.prototype.dispose=function(){this.scene.onBeforePhysicsObservable.clear(),this.scene.onAfterPhysicsObservable.clear(),this.scene._physicsEngine&&this.scene.disablePhysicsEngine()},e}(),d=i(0),f=i(28),_=i(35),m=function(){function e(e){this._scene=e,this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine||n.a.Warn("Physics engine not enabled. Please enable the physics before you can use the methods.")}return e.prototype.applyRadialExplosionImpulse=function(e,t,i,r){if(void 0===r&&(r=l.Constant),!this._physicsEngine)return n.a.Warn("Physics engine not enabled. Please enable the physics before you call this method."),null;var o=this._physicsEngine.getImpostors();if(0===o.length)return null;var s=new g(this._scene);return o.forEach(function(n){var o=s.getImpostorForceAndContactPoint(n,e,t,i,r);o&&n.applyImpulse(o.force,o.contactPoint)}),s.dispose(!1),s},e.prototype.applyRadialExplosionForce=function(e,t,i,r){if(void 0===r&&(r=l.Constant),!this._physicsEngine)return n.a.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper."),null;var o=this._physicsEngine.getImpostors();if(0===o.length)return null;var s=new g(this._scene);return o.forEach(function(n){var o=s.getImpostorForceAndContactPoint(n,e,t,i,r);o&&n.applyForce(o.force,o.contactPoint)}),s.dispose(!1),s},e.prototype.gravitationalField=function(e,t,i,r){if(void 0===r&&(r=l.Constant),!this._physicsEngine)return n.a.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper."),null;if(0===this._physicsEngine.getImpostors().length)return null;var o=new y(this,this._scene,e,t,i,r);return o.dispose(!1),o},e.prototype.updraft=function(e,t,i,r,o){if(void 0===o&&(o=u.Center),!this._physicsEngine)return n.a.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper."),null;if(0===this._physicsEngine.getImpostors().length)return null;var s=new P(this._scene,e,t,i,r,o);return s.dispose(!1),s},e.prototype.vortex=function(e,t,i,r){if(!this._physicsEngine)return n.a.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper."),null;if(0===this._physicsEngine.getImpostors().length)return null;var o=new b(this._scene,e,t,i,r);return o.dispose(!1),o},e}(),g=function(){function e(e){this._sphereOptions={segments:32,diameter:1},this._rays=[],this._dataFetched=!1,this._scene=e}return e.prototype.getData=function(){return this._dataFetched=!0,{sphere:this._sphere,rays:this._rays}},e.prototype.getImpostorForceAndContactPoint=function(e,t,i,r,n){if(0===e.mass)return null;if(!this._intersectsWithSphere(e,t,i))return null;if("Mesh"!==e.object.getClassName()&&"InstancedMesh"!==e.object.getClassName())return null;var o=e.getObjectCenter().subtract(t),s=new _.a(t,o,i);this._rays.push(s);var a=s.intersectsMesh(e.object).pickedPoint;if(!a)return null;var c=d.Vector3.Distance(t,a);if(c>i)return null;var h=n===l.Constant?r:r*(1-c/i);return{force:o.multiplyByFloats(h,h,h),contactPoint:a}},e.prototype.dispose=function(e){var t=this;void 0===e&&(e=!0),e?this._sphere.dispose():setTimeout(function(){t._dataFetched||t._sphere.dispose()},0)},e.prototype._prepareSphere=function(){this._sphere||(this._sphere=f.MeshBuilder.CreateSphere("radialExplosionEventSphere",this._sphereOptions,this._scene),this._sphere.isVisible=!1)},e.prototype._intersectsWithSphere=function(e,t,i){var r=e.object;return this._prepareSphere(),this._sphere.position=t,this._sphere.scaling=new d.Vector3(2*i,2*i,2*i),this._sphere._updateBoundingInfo(),this._sphere.computeWorldMatrix(!0),this._sphere.intersectsMesh(r,!0)},e}(),y=function(){function e(e,t,i,r,n,o){void 0===o&&(o=l.Constant),this._dataFetched=!1,this._physicsHelper=e,this._scene=t,this._origin=i,this._radius=r,this._strength=n,this._falloff=o,this._tickCallback=this._tick.bind(this)}return e.prototype.getData=function(){return this._dataFetched=!0,{sphere:this._sphere}},e.prototype.enable=function(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)},e.prototype.disable=function(){this._scene.unregisterBeforeRender(this._tickCallback)},e.prototype.dispose=function(e){var t=this;void 0===e&&(e=!0),e?this._sphere.dispose():setTimeout(function(){t._dataFetched||t._sphere.dispose()},0)},e.prototype._tick=function(){if(this._sphere)this._physicsHelper.applyRadialExplosionForce(this._origin,this._radius,-1*this._strength,this._falloff);else{var e=this._physicsHelper.applyRadialExplosionForce(this._origin,this._radius,-1*this._strength,this._falloff);e&&(this._sphere=e.getData().sphere.clone("radialExplosionEventSphereClone"))}},e}(),P=function(){function e(e,t,i,r,n,o){this._scene=e,this._origin=t,this._radius=i,this._strength=r,this._height=n,this._updraftMode=o,this._originTop=d.Vector3.Zero(),this._originDirection=d.Vector3.Zero(),this._cylinderPosition=d.Vector3.Zero(),this._dataFetched=!1,this._physicsEngine=this._scene.getPhysicsEngine(),this._origin.addToRef(new d.Vector3(0,this._height/2,0),this._cylinderPosition),this._origin.addToRef(new d.Vector3(0,this._height,0),this._originTop),this._updraftMode===u.Perpendicular&&(this._originDirection=this._origin.subtract(this._originTop).normalize()),this._tickCallback=this._tick.bind(this),this._prepareCylinder()}return e.prototype.getData=function(){return this._dataFetched=!0,{cylinder:this._cylinder}},e.prototype.enable=function(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)},e.prototype.disable=function(){this._scene.unregisterBeforeRender(this._tickCallback)},e.prototype.dispose=function(e){var t=this;void 0===e&&(e=!0),this._cylinder&&(e?this._cylinder.dispose():setTimeout(function(){t._dataFetched||t._cylinder.dispose()},0))},e.prototype.getImpostorForceAndContactPoint=function(e){if(0===e.mass)return null;if(!this._intersectsWithCylinder(e))return null;var t=e.getObjectCenter();if(this._updraftMode===u.Perpendicular)var i=this._originDirection;else i=t.subtract(this._originTop);var r=-1*this._strength;return{force:i.multiplyByFloats(r,r,r),contactPoint:t}},e.prototype._tick=function(){var e=this;this._physicsEngine.getImpostors().forEach(function(t){var i=e.getImpostorForceAndContactPoint(t);i&&t.applyForce(i.force,i.contactPoint)})},e.prototype._prepareCylinder=function(){this._cylinder||(this._cylinder=f.MeshBuilder.CreateCylinder("updraftEventCylinder",{height:this._height,diameter:2*this._radius},this._scene),this._cylinder.isVisible=!1)},e.prototype._intersectsWithCylinder=function(e){var t=e.object;return this._cylinder.position=this._cylinderPosition,this._cylinder.intersectsMesh(t,!0)},e}(),b=function(){function e(e,t,i,r,n){this._scene=e,this._origin=t,this._radius=i,this._strength=r,this._height=n,this._originTop=d.Vector3.Zero(),this._centripetalForceThreshold=.7,this._updraftMultiplier=.02,this._cylinderPosition=d.Vector3.Zero(),this._dataFetched=!1,this._physicsEngine=this._scene.getPhysicsEngine(),this._origin.addToRef(new d.Vector3(0,this._height/2,0),this._cylinderPosition),this._origin.addToRef(new d.Vector3(0,this._height,0),this._originTop),this._tickCallback=this._tick.bind(this),this._prepareCylinder()}return e.prototype.getData=function(){return this._dataFetched=!0,{cylinder:this._cylinder}},e.prototype.enable=function(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)},e.prototype.disable=function(){this._scene.unregisterBeforeRender(this._tickCallback)},e.prototype.dispose=function(e){var t=this;void 0===e&&(e=!0),e?this._cylinder.dispose():setTimeout(function(){t._dataFetched||t._cylinder.dispose()},0)},e.prototype.getImpostorForceAndContactPoint=function(e){if(0===e.mass)return null;if(!this._intersectsWithCylinder(e))return null;if("Mesh"!==e.object.getClassName()&&"InstancedMesh"!==e.object.getClassName())return null;var t=e.getObjectCenter(),i=new d.Vector3(this._origin.x,t.y,this._origin.z),r=t.subtract(i),n=new _.a(i,r,this._radius).intersectsMesh(e.object),o=n.pickedPoint;if(!o)return null;var s=n.distance/this._radius,a=d.Vector3.Cross(i,t).normalize(),c=o.normalize();if(s>this._centripetalForceThreshold&&(c=c.negate()),s>this._centripetalForceThreshold)var h=c.x*this._strength/8,l=c.y*this._updraftMultiplier,u=c.z*this._strength/8;else h=(a.x+c.x)/2,l=this._originTop.y*this._updraftMultiplier,u=(a.z+c.z)/2;var p=new d.Vector3(h,l,u);return{force:p=p.multiplyByFloats(this._strength,this._strength,this._strength),contactPoint:t}},e.prototype._tick=function(){var e=this;this._physicsEngine.getImpostors().forEach(function(t){var i=e.getImpostorForceAndContactPoint(t);i&&t.applyForce(i.force,i.contactPoint)})},e.prototype._prepareCylinder=function(){this._cylinder||(this._cylinder=f.MeshBuilder.CreateCylinder("vortexEventCylinder",{height:this._height,diameter:2*this._radius},this._scene),this._cylinder.isVisible=!1)},e.prototype._intersectsWithCylinder=function(e){var t=e.object;return this._cylinder.position=this._cylinderPosition,this._cylinder.intersectsMesh(t,!0)},e}();!function(e){e[e.Constant=0]="Constant",e[e.Linear=1]="Linear"}(l||(l={})),function(e){e[e.Center=0]="Center",e[e.Perpendicular=1]="Perpendicular"}(u||(u={}));var v=i(37),S=i(199),E=i(3),x=function(){function e(e,t){void 0===e&&(e=!0),void 0===t&&(t=Ammo);var i=this;this._useDeltaForWorldStep=e,this.name="AmmoJSPlugin",this._timeStep=1/60,this._fixedTimeStep=1/60,this._maxSteps=5,this._tmpQuaternion=new d.Quaternion,this._tmpContactCallbackResult=!1,"function"==typeof t&&t(),this.bjsAMMO=t,this.isSupported()?(this._collisionConfiguration=new this.bjsAMMO.btDefaultCollisionConfiguration,this._dispatcher=new this.bjsAMMO.btCollisionDispatcher(this._collisionConfiguration),this._overlappingPairCache=new this.bjsAMMO.btDbvtBroadphase,this._solver=new this.bjsAMMO.btSequentialImpulseConstraintSolver,this.world=new this.bjsAMMO.btDiscreteDynamicsWorld(this._dispatcher,this._overlappingPairCache,this._solver,this._collisionConfiguration),this._tmpAmmoConcreteContactResultCallback=new this.bjsAMMO.ConcreteContactResultCallback,this._tmpAmmoConcreteContactResultCallback.addSingleResult=function(){i._tmpContactCallbackResult=!0},this._tmpAmmoTransform=new this.bjsAMMO.btTransform,this._tmpAmmoTransform.setIdentity(),this._tmpAmmoQuaternion=new this.bjsAMMO.btQuaternion(0,0,0,1),this._tmpAmmoVectorA=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorB=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorC=new this.bjsAMMO.btVector3(0,0,0)):n.a.Error("AmmoJS is not available. Please make sure you included the js file.")}return e.prototype.setGravity=function(e){this._tmpAmmoVectorA.setValue(e.x,e.y,e.z),this.world.setGravity(this._tmpAmmoVectorA)},e.prototype.setTimeStep=function(e){this._timeStep=e},e.prototype.setFixedTimeStep=function(e){this._fixedTimeStep=e},e.prototype.setMaxSteps=function(e){this._maxSteps=e},e.prototype.getTimeStep=function(){return this._timeStep},e.prototype._isImpostorInContact=function(e){return this._tmpContactCallbackResult=!1,this.world.contactTest(e.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult},e.prototype._isImpostorPairInContact=function(e,t){return this._tmpContactCallbackResult=!1,this.world.contactPairTest(e.physicsBody,t.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult},e.prototype._stepSimulation=function(e,t,i){if(void 0===e&&(e=1/60),void 0===t&&(t=10),void 0===i&&(i=1/60),0==t)this.world.stepSimulation(e,0);else for(;t>0&&e>0;)e-i<i?(this.world.stepSimulation(e,0),e=0):(e-=i,this.world.stepSimulation(i,0)),t--},e.prototype.executeStep=function(e,t){for(var i=0,r=t;i<r.length;i++){r[i].beforeStep()}this._stepSimulation(this._useDeltaForWorldStep?e:this._timeStep,this._maxSteps,this._fixedTimeStep);for(var n=0,o=t;n<o.length;n++){var s=o[n];if(s.afterStep(),s._onPhysicsCollideCallbacks.length>0&&this._isImpostorInContact(s))for(var a=0,c=s._onPhysicsCollideCallbacks;a<c.length;a++)for(var h=0,l=c[a].otherImpostors;h<l.length;h++){var u=l[h];(s.physicsBody.isActive()||u.physicsBody.isActive())&&this._isImpostorPairInContact(s,u)&&(s.onCollide({body:u.physicsBody}),u.onCollide({body:s.physicsBody}))}}},e.prototype.applyImpulse=function(e,t,i){var r=this._tmpAmmoVectorA,n=this._tmpAmmoVectorB;r.setValue(i.x,i.y,i.z),n.setValue(t.x,t.y,t.z),e.physicsBody.applyImpulse(n,r)},e.prototype.applyForce=function(e,t,i){var r=this._tmpAmmoVectorA,n=this._tmpAmmoVectorB;r.setValue(i.x,i.y,i.z),n.setValue(t.x,t.y,t.z),e.physicsBody.applyForce(n,r)},e.prototype.generatePhysicsBody=function(t){if(t._pluginData={toDispose:[]},t.parent)t.physicsBody&&(this.removePhysicsBody(t),t.forceUpdate());else if(t.isBodyInitRequired()){var i=this._createShape(t),r=t.getParam("mass");t._pluginData.mass=r;var n=new Ammo.btVector3(0,0,0),o=new Ammo.btTransform;o.setIdentity(),0!==r&&i.calculateLocalInertia(r,n),this._tmpAmmoVectorA.setValue(t.object.position.x,t.object.position.y,t.object.position.z),this._tmpAmmoQuaternion.setValue(t.object.rotationQuaternion.x,t.object.rotationQuaternion.y,t.object.rotationQuaternion.z,t.object.rotationQuaternion.w),o.setOrigin(this._tmpAmmoVectorA),o.setRotation(this._tmpAmmoQuaternion);var s=new Ammo.btDefaultMotionState(o),a=new Ammo.btRigidBodyConstructionInfo(r,s,i,n),c=new Ammo.btRigidBody(a);0===r&&(c.setCollisionFlags(c.getCollisionFlags()|e.KINEMATIC_FLAG),c.setActivationState(e.DISABLE_DEACTIVATION_FLAG)),t.type!=v.a.NoImpostor||i.getChildShape||c.setCollisionFlags(c.getCollisionFlags()|e.DISABLE_COLLISION_FLAG),this.world.addRigidBody(c),t.physicsBody=c,this.setBodyRestitution(t,t.getParam("restitution")),this.setBodyFriction(t,t.getParam("friction")),t._pluginData.toDispose.concat([c,a,s,o,n,i])}},e.prototype.removePhysicsBody=function(e){var t=this;this.world&&(this.world.removeRigidBody(e.physicsBody),e._pluginData.toDispose.forEach(function(e){t.bjsAMMO.destroy(e)}))},e.prototype.generateJoint=function(e){var t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(t&&i){var r,o=e.joint.jointData;switch(o.mainPivot||(o.mainPivot=new d.Vector3(0,0,0)),o.connectedPivot||(o.connectedPivot=new d.Vector3(0,0,0)),e.joint.type){case h.e.DistanceJoint:var s=o.maxDistance;s&&(o.mainPivot=new d.Vector3(0,-s/2,0),o.connectedPivot=new d.Vector3(0,s/2,0)),r=new Ammo.btPoint2PointConstraint(t,i,new Ammo.btVector3(o.mainPivot.x,o.mainPivot.y,o.mainPivot.z),new Ammo.btVector3(o.connectedPivot.x,o.connectedPivot.y,o.connectedPivot.z));break;case h.e.HingeJoint:o.mainAxis||(o.mainAxis=new d.Vector3(0,0,0)),o.connectedAxis||(o.connectedAxis=new d.Vector3(0,0,0));var a=new Ammo.btVector3(o.mainAxis.x,o.mainAxis.y,o.mainAxis.z),c=new Ammo.btVector3(o.connectedAxis.x,o.connectedAxis.y,o.connectedAxis.z);r=new Ammo.btHingeConstraint(t,i,new Ammo.btVector3(o.mainPivot.x,o.mainPivot.y,o.mainPivot.z),new Ammo.btVector3(o.connectedPivot.x,o.connectedPivot.y,o.connectedPivot.z),a,c);break;case h.e.BallAndSocketJoint:r=new Ammo.btPoint2PointConstraint(t,i,new Ammo.btVector3(o.mainPivot.x,o.mainPivot.y,o.mainPivot.z),new Ammo.btVector3(o.connectedPivot.x,o.connectedPivot.y,o.connectedPivot.z));break;default:n.a.Warn("JointType not currently supported by the Ammo plugin, falling back to PhysicsJoint.BallAndSocketJoint"),r=new Ammo.btPoint2PointConstraint(t,i,new Ammo.btVector3(o.mainPivot.x,o.mainPivot.y,o.mainPivot.z),new Ammo.btVector3(o.connectedPivot.x,o.connectedPivot.y,o.connectedPivot.z))}this.world.addConstraint(r,!e.joint.jointData.collision),e.joint.physicsJoint=r}},e.prototype.removeJoint=function(e){this.world&&this.world.removeConstraint(e.joint.physicsJoint)},e.prototype._addMeshVerts=function(e,t,i){var r=this,n=0;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){var o=i.getIndices();o||(o=[]);var s=i.getVerticesData(E.VertexBuffer.PositionKind);s||(s=[]),i.computeWorldMatrix(!1);for(var a=o.length/3,c=0;c<a;c++){for(var h=[],l=0;l<3;l++){var u,p=new d.Vector3(s[3*o[3*c+l]+0],s[3*o[3*c+l]+1],s[3*o[3*c+l]+2]);(p=d.Vector3.TransformCoordinates(p,i.getWorldMatrix())).subtractInPlace(t.position),(u=0==l?this._tmpAmmoVectorA:1==l?this._tmpAmmoVectorB:this._tmpAmmoVectorC).setValue(p.x,p.y,p.z),h.push(u)}e.addTriangle(h[0],h[1],h[2]),n++}i.getChildMeshes().forEach(function(i){n+=r._addMeshVerts(e,t,i)})}return n},e.prototype._createShape=function(e,t){var i=this;void 0===t&&(t=!1);var r,o=e.object,s=e.getObjectExtendSize();if(!t){var a=e.object.getChildMeshes?e.object.getChildMeshes(!0):[];r=new Ammo.btCompoundShape;var c=0;if(a.forEach(function(e){var t=e.getPhysicsImpostor();if(t){var n=i._createShape(t),o=e.parent.getWorldMatrix().clone(),s=new d.Vector3;o.decompose(s),i._tmpAmmoTransform.getOrigin().setValue(e.position.x*s.x,e.position.y*s.y,e.position.z*s.z),i._tmpAmmoQuaternion.setValue(e.rotationQuaternion.x,e.rotationQuaternion.y,e.rotationQuaternion.z,e.rotationQuaternion.w),i._tmpAmmoTransform.setRotation(i._tmpAmmoQuaternion),r.addChildShape(i._tmpAmmoTransform,n),t.dispose(),c++}}),c>0){if(e.type!=v.a.NoImpostor){var h=this._createShape(e,!0);h&&(this._tmpAmmoTransform.getOrigin().setValue(0,0,0),this._tmpAmmoQuaternion.setValue(0,0,0,1),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),r.addChildShape(this._tmpAmmoTransform,h))}return r}Ammo.destroy(r),r=null}switch(e.type){case v.a.SphereImpostor:r=new Ammo.btSphereShape(s.x/2);break;case v.a.CylinderImpostor:this._tmpAmmoVectorA.setValue(s.x/2,s.y/2,s.z/2),r=new Ammo.btCylinderShape(this._tmpAmmoVectorA);break;case v.a.PlaneImpostor:case v.a.BoxImpostor:this._tmpAmmoVectorA.setValue(s.x/2,s.y/2,s.z/2),r=new Ammo.btBoxShape(this._tmpAmmoVectorA);break;case v.a.MeshImpostor:var l=new Ammo.btTriangleMesh;e._pluginData.toDispose.concat([l]);var u=this._addMeshVerts(l,o,o);r=0==u?new Ammo.btCompoundShape:new Ammo.btBvhTriangleMeshShape(l);break;case v.a.NoImpostor:r=new Ammo.btSphereShape(s.x/2);break;default:n.a.Warn("The impostor type is not currently supported by the ammo plugin.")}return r},e.prototype.setTransformationFromPhysicsBody=function(e){e.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),e.object.position.set(this._tmpAmmoTransform.getOrigin().x(),this._tmpAmmoTransform.getOrigin().y(),this._tmpAmmoTransform.getOrigin().z()),e.object.rotationQuaternion?e.object.rotationQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()):e.object.rotation&&(this._tmpQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()),this._tmpQuaternion.toEulerAnglesToRef(e.object.rotation))},e.prototype.setPhysicsBodyTransformation=function(e,t,i){var r=e.physicsBody.getWorldTransform();if(r.getOrigin().x()!=t.x||r.getOrigin().y()!=t.y||r.getOrigin().z()!=t.z||r.getRotation().x()!=i.x||r.getRotation().y()!=i.y||r.getRotation().z()!=i.z||r.getRotation().w()!=i.w)if(this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),r.setOrigin(this._tmpAmmoVectorA),this._tmpAmmoQuaternion.setValue(i.x,i.y,i.z,i.w),r.setRotation(this._tmpAmmoQuaternion),e.physicsBody.setWorldTransform(r),0==e.mass){var n=e.physicsBody.getMotionState();n&&n.setWorldTransform(r)}else e.physicsBody.activate()},e.prototype.isSupported=function(){return void 0!==this.bjsAMMO},e.prototype.setLinearVelocity=function(e,t){this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),e.physicsBody.setLinearVelocity(this._tmpAmmoVectorA)},e.prototype.setAngularVelocity=function(e,t){this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),e.physicsBody.setAngularVelocity(this._tmpAmmoVectorA)},e.prototype.getLinearVelocity=function(e){var t=e.physicsBody.getLinearVelocity();return t?new d.Vector3(t.x(),t.y(),t.z()):null},e.prototype.getAngularVelocity=function(e){var t=e.physicsBody.getAngularVelocity();return t?new d.Vector3(t.x(),t.y(),t.z()):null},e.prototype.setBodyMass=function(e,t){e.physicsBody.setMassProps(t),e._pluginData.mass=t},e.prototype.getBodyMass=function(e){return e._pluginData.mass},e.prototype.getBodyFriction=function(e){return e._pluginData.friction},e.prototype.setBodyFriction=function(e,t){e.physicsBody.setFriction(t),e._pluginData.friction=t},e.prototype.getBodyRestitution=function(e){return e._pluginData.restitution},e.prototype.setBodyRestitution=function(e,t){e.physicsBody.setRestitution(t),e._pluginData.restitution=t},e.prototype.sleepBody=function(e){n.a.Warn("sleepBody is not currently supported by the Ammo physics plugin")},e.prototype.wakeUpBody=function(e){e.physicsBody.activate()},e.prototype.updateDistanceJoint=function(e,t,i){n.a.Warn("updateDistanceJoint is not currently supported by the Ammo physics plugin")},e.prototype.setMotor=function(e,t,i,r){e.physicsJoint.enableAngularMotor(!0,t,i)},e.prototype.setLimit=function(e,t,i){n.a.Warn("setLimit is not currently supported by the Ammo physics plugin")},e.prototype.syncMeshWithImpostor=function(e,t){t.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),e.position.x=this._tmpAmmoTransform.getOrigin().x(),e.position.y=this._tmpAmmoTransform.getOrigin().y(),e.position.z=this._tmpAmmoTransform.getOrigin().z(),e.rotationQuaternion&&(e.rotationQuaternion.x=this._tmpAmmoTransform.getRotation().x(),e.rotationQuaternion.y=this._tmpAmmoTransform.getRotation().y(),e.rotationQuaternion.z=this._tmpAmmoTransform.getRotation().z(),e.rotationQuaternion.w=this._tmpAmmoTransform.getRotation().w())},e.prototype.getRadius=function(e){return e.getObjectExtendSize().x/2},e.prototype.getBoxSizeToRef=function(e,t){var i=e.getObjectExtendSize();t.x=i.x,t.y=i.y,t.z=i.z},e.prototype.dispose=function(){Ammo.destroy(this.world),Ammo.destroy(this._solver),Ammo.destroy(this._overlappingPairCache),Ammo.destroy(this._dispatcher),Ammo.destroy(this._collisionConfiguration),Ammo.destroy(this._tmpAmmoVectorA),Ammo.destroy(this._tmpAmmoVectorB),Ammo.destroy(this._tmpAmmoVectorC),Ammo.destroy(this._tmpAmmoTransform),Ammo.destroy(this._tmpAmmoQuaternion),Ammo.destroy(this._tmpAmmoConcreteContactResultCallback),this.world=null},e.DISABLE_COLLISION_FLAG=4,e.KINEMATIC_FLAG=2,e.DISABLE_DEACTIVATION_FLAG=4,e}(),T=i(200);i.d(t,"h",function(){return r.a}),i.d(t,"i",function(){return p}),i.d(t,"k",function(){return m}),i.d(t,"n",function(){return g}),i.d(t,"j",function(){return y}),i.d(t,"p",function(){return P}),i.d(t,"r",function(){return b}),i.d(t,"o",function(){return l}),i.d(t,"q",function(){return u}),i.d(t,"l",function(){return v.a}),i.d(t,"m",function(){return h.e}),i.d(t,"c",function(){return h.a}),i.d(t,"f",function(){return h.d}),i.d(t,"e",function(){return h.c}),i.d(t,"d",function(){return h.b}),i.d(t,"b",function(){return S.a}),i.d(t,"a",function(){return x}),i.d(t,"g",function(){return T.a})},37:function(e,t,i){"use strict";i.d(t,"a",function(){return c});var r=i(9),n=i(43),o=i(0),s=i(23),a=i(45),c=function(){function e(e,t,i,n){void 0===i&&(i={mass:0});var s=this;this.object=e,this.type=t,this._options=i,this._scene=n,this._bodyUpdateRequired=!1,this._onBeforePhysicsStepCallbacks=new Array,this._onAfterPhysicsStepCallbacks=new Array,this._onPhysicsCollideCallbacks=[],this._deltaPosition=o.Vector3.Zero(),this._isDisposed=!1,this._tmpQuat=new o.Quaternion,this._tmpQuat2=new o.Quaternion,this.beforeStep=function(){s._physicsEngine&&(s.object.translate(s._deltaPosition,-1),s._deltaRotationConjugated&&s.object.rotationQuaternion&&s.object.rotationQuaternion.multiplyToRef(s._deltaRotationConjugated,s.object.rotationQuaternion),s.object.computeWorldMatrix(!1),s.object.parent&&s.object.rotationQuaternion?(s.getParentsRotation(),s._tmpQuat.multiplyToRef(s.object.rotationQuaternion,s._tmpQuat)):s._tmpQuat.copyFrom(s.object.rotationQuaternion||new o.Quaternion),s._options.disableBidirectionalTransformation||s.object.rotationQuaternion&&s._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(s,s.object.getAbsolutePosition(),s._tmpQuat),s._onBeforePhysicsStepCallbacks.forEach(function(e){e(s)}))},this.afterStep=function(){s._physicsEngine&&(s._onAfterPhysicsStepCallbacks.forEach(function(e){e(s)}),s._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(s),s.object.parent&&s.object.rotationQuaternion&&(s.getParentsRotation(),s._tmpQuat.conjugateInPlace(),s._tmpQuat.multiplyToRef(s.object.rotationQuaternion,s.object.rotationQuaternion)),s.object.setAbsolutePosition(s.object.position),s._deltaRotation&&s.object.rotationQuaternion&&s.object.rotationQuaternion.multiplyToRef(s._deltaRotation,s.object.rotationQuaternion),s.object.translate(s._deltaPosition,1))},this.onCollideEvent=null,this.onCollide=function(e){if((s._onPhysicsCollideCallbacks.length||s.onCollideEvent)&&s._physicsEngine){var t=s._physicsEngine.getImpostorWithPhysicsBody(e.body);t&&(s.onCollideEvent&&s.onCollideEvent(s,t),s._onPhysicsCollideCallbacks.filter(function(e){return-1!==e.otherImpostors.indexOf(t)}).forEach(function(e){e.callback(s,t)}))}},this.object?(!this._scene&&e.getScene&&(this._scene=e.getScene()),this._scene&&(this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine?(this.object.rotationQuaternion||(this.object.rotation?this.object.rotationQuaternion=o.Quaternion.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z):this.object.rotationQuaternion=new o.Quaternion),this._options.mass=void 0===i.mass?0:i.mass,this._options.friction=void 0===i.friction?.2:i.friction,this._options.restitution=void 0===i.restitution?.2:i.restitution,this._joints=[],!this.object.parent||this._options.ignoreParent?this._init():this.object.parent.physicsImpostor&&r.a.Warn("You must affect impostors to children before affecting impostor to parent.")):r.a.Error("Physics not enabled. Please use scene.enablePhysics(...) before creating impostors."))):r.a.Error("No object was provided. A physics object is obligatory")}return Object.defineProperty(e.prototype,"isDisposed",{get:function(){return this._isDisposed},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"mass",{get:function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyMass(this):0},set:function(e){this.setMass(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"friction",{get:function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyFriction(this):0},set:function(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyFriction(this,e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"restitution",{get:function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyRestitution(this):0},set:function(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyRestitution(this,e)},enumerable:!0,configurable:!0}),e.prototype._init=function(){this._physicsEngine&&(this._physicsEngine.removeImpostor(this),this.physicsBody=null,this._parent=this._parent||this._getPhysicsParent(),this._isDisposed||this.parent&&!this._options.ignoreParent||this._physicsEngine.addImpostor(this))},e.prototype._getPhysicsParent=function(){return this.object.parent instanceof s.a?this.object.parent.physicsImpostor:null},e.prototype.isBodyInitRequired=function(){return this._bodyUpdateRequired||!this._physicsBody&&!this._parent},e.prototype.setScalingUpdated=function(){this.forceUpdate()},e.prototype.forceUpdate=function(){this._init(),this.parent&&!this._options.ignoreParent&&this.parent.forceUpdate()},Object.defineProperty(e.prototype,"physicsBody",{get:function(){return this._parent&&!this._options.ignoreParent?this._parent.physicsBody:this._physicsBody},set:function(e){this._physicsBody&&this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this),this._physicsBody=e,this.resetUpdateFlags()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"parent",{get:function(){return!this._options.ignoreParent&&this._parent?this._parent:null},set:function(e){this._parent=e},enumerable:!0,configurable:!0}),e.prototype.resetUpdateFlags=function(){this._bodyUpdateRequired=!1},e.prototype.getObjectExtendSize=function(){if(this.object.getBoundingInfo){var t=this.object.rotationQuaternion;this.object.rotationQuaternion=e.IDENTITY_QUATERNION,this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0);var i=this.object.getBoundingInfo().boundingBox.extendSizeWorld.scale(2);return this.object.rotationQuaternion=t,this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0),i}return e.DEFAULT_OBJECT_SIZE},e.prototype.getObjectCenter=function(){return this.object.getBoundingInfo?this.object.getBoundingInfo().boundingBox.centerWorld:this.object.position},e.prototype.getParam=function(e){return this._options[e]},e.prototype.setParam=function(e,t){this._options[e]=t,this._bodyUpdateRequired=!0},e.prototype.setMass=function(e){this.getParam("mass")!==e&&this.setParam("mass",e),this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyMass(this,e)},e.prototype.getLinearVelocity=function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this):o.Vector3.Zero()},e.prototype.setLinearVelocity=function(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this,e)},e.prototype.getAngularVelocity=function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this):o.Vector3.Zero()},e.prototype.setAngularVelocity=function(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this,e)},e.prototype.executeNativeFunction=function(e){this._physicsEngine&&e(this._physicsEngine.getPhysicsPlugin().world,this.physicsBody)},e.prototype.registerBeforePhysicsStep=function(e){this._onBeforePhysicsStepCallbacks.push(e)},e.prototype.unregisterBeforePhysicsStep=function(e){var t=this._onBeforePhysicsStepCallbacks.indexOf(e);t>-1?this._onBeforePhysicsStepCallbacks.splice(t,1):r.a.Warn("Function to remove was not found")},e.prototype.registerAfterPhysicsStep=function(e){this._onAfterPhysicsStepCallbacks.push(e)},e.prototype.unregisterAfterPhysicsStep=function(e){var t=this._onAfterPhysicsStepCallbacks.indexOf(e);t>-1?this._onAfterPhysicsStepCallbacks.splice(t,1):r.a.Warn("Function to remove was not found")},e.prototype.registerOnPhysicsCollide=function(e,t){var i=e instanceof Array?e:[e];this._onPhysicsCollideCallbacks.push({callback:t,otherImpostors:i})},e.prototype.unregisterOnPhysicsCollide=function(e,t){var i=e instanceof Array?e:[e],n=-1;this._onPhysicsCollideCallbacks.some(function(e,r){if(e.callback===t&&e.otherImpostors.length===i.length){var o=e.otherImpostors.every(function(e){return i.indexOf(e)>-1});return o&&(n=r),o}return!1})?this._onPhysicsCollideCallbacks.splice(n,1):r.a.Warn("Function to remove was not found")},e.prototype.getParentsRotation=function(){var e=this.object.parent;for(this._tmpQuat.copyFromFloats(0,0,0,1);e;)e.rotationQuaternion?this._tmpQuat2.copyFrom(e.rotationQuaternion):o.Quaternion.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,e.rotation.z,this._tmpQuat2),this._tmpQuat.multiplyToRef(this._tmpQuat2,this._tmpQuat),e=e.parent;return this._tmpQuat},e.prototype.applyForce=function(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyForce(this,e,t),this},e.prototype.applyImpulse=function(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyImpulse(this,e,t),this},e.prototype.createJoint=function(e,t,i){var r=new a.e(t,i);return this.addJoint(e,r),this},e.prototype.addJoint=function(e,t){return this._joints.push({otherImpostor:e,joint:t}),this._physicsEngine&&this._physicsEngine.addJoint(this,e,t),this},e.prototype.sleep=function(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().sleepBody(this),this},e.prototype.wakeUp=function(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().wakeUpBody(this),this},e.prototype.clone=function(t){return t?new e(t,this.type,this._options,this._scene):null},e.prototype.dispose=function(){var e=this;this._physicsEngine&&(this._joints.forEach(function(t){e._physicsEngine&&e._physicsEngine.removeJoint(e,t.otherImpostor,t.joint)}),this._physicsEngine.removeImpostor(this),this.parent&&this.parent.forceUpdate(),this._isDisposed=!0)},e.prototype.setDeltaPosition=function(e){this._deltaPosition.copyFrom(e)},e.prototype.setDeltaRotation=function(e){this._deltaRotation||(this._deltaRotation=new o.Quaternion),this._deltaRotation.copyFrom(e),this._deltaRotationConjugated=this._deltaRotation.conjugate()},e.prototype.getBoxSizeToRef=function(e){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().getBoxSizeToRef(this,e),this},e.prototype.getRadius=function(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getRadius(this):0},e.prototype.syncBoneWithImpostor=function(t,i,r,n,s){var a=e._tmpVecs[0],c=this.object;if(c.rotationQuaternion)if(s){var h=e._tmpQuat;c.rotationQuaternion.multiplyToRef(s,h),t.setRotationQuaternion(h,o.Space.WORLD,i)}else t.setRotationQuaternion(c.rotationQuaternion,o.Space.WORLD,i);a.x=0,a.y=0,a.z=0,r&&(a.x=r.x,a.y=r.y,a.z=r.z,t.getDirectionToRef(a,i,a),null==n&&(n=r.length()),a.x*=n,a.y*=n,a.z*=n),t.getParent()?(a.addInPlace(c.getAbsolutePosition()),t.setAbsolutePosition(a,i)):(i.setAbsolutePosition(c.getAbsolutePosition()),i.position.x-=a.x,i.position.y-=a.y,i.position.z-=a.z)},e.prototype.syncImpostorWithBone=function(t,i,r,n,s,a){var c=this.object;if(c.rotationQuaternion)if(s){var h=e._tmpQuat;t.getRotationQuaternionToRef(o.Space.WORLD,i,h),h.multiplyToRef(s,c.rotationQuaternion)}else t.getRotationQuaternionToRef(o.Space.WORLD,i,c.rotationQuaternion);var l=e._tmpVecs[0],u=e._tmpVecs[1];a||((a=e._tmpVecs[2]).x=0,a.y=1,a.z=0),t.getDirectionToRef(a,i,u),t.getAbsolutePositionToRef(i,l),null==n&&r&&(n=r.length()),null!=n&&(l.x+=u.x*n,l.y+=u.y*n,l.z+=u.z*n),c.setAbsolutePosition(l)},e.DEFAULT_OBJECT_SIZE=new o.Vector3(1,1,1),e.IDENTITY_QUATERNION=o.Quaternion.Identity(),e._tmpVecs=n.a.BuildArray(3,o.Vector3.Zero),e._tmpQuat=o.Quaternion.Identity(),e.NoImpostor=0,e.SphereImpostor=1,e.BoxImpostor=2,e.PlaneImpostor=3,e.MeshImpostor=4,e.CylinderImpostor=7,e.ParticleImpostor=8,e.HeightmapImpostor=9,e}()},45:function(e,t,i){"use strict";i.d(t,"e",function(){return n}),i.d(t,"a",function(){return o}),i.d(t,"d",function(){return s}),i.d(t,"c",function(){return a}),i.d(t,"b",function(){return c});var r=i(1),n=function(){function e(e,t){this.type=e,this.jointData=t,t.nativeParams=t.nativeParams||{}}return Object.defineProperty(e.prototype,"physicsJoint",{get:function(){return this._physicsJoint},set:function(e){this._physicsJoint,this._physicsJoint=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"physicsPlugin",{set:function(e){this._physicsPlugin=e},enumerable:!0,configurable:!0}),e.prototype.executeNativeFunction=function(e){e(this._physicsPlugin.world,this._physicsJoint)},e.DistanceJoint=0,e.HingeJoint=1,e.BallAndSocketJoint=2,e.WheelJoint=3,e.SliderJoint=4,e.PrismaticJoint=5,e.UniversalJoint=6,e.Hinge2Joint=e.WheelJoint,e.PointToPointJoint=8,e.SpringJoint=9,e.LockJoint=10,e}(),o=function(e){function t(t){return e.call(this,n.DistanceJoint,t)||this}return r.d(t,e),t.prototype.updateDistance=function(e,t){this._physicsPlugin.updateDistanceJoint(this,e,t)},t}(n),s=function(e){function t(t,i){return e.call(this,t,i)||this}return r.d(t,e),t.prototype.setMotor=function(e,t){this._physicsPlugin.setMotor(this,e||0,t)},t.prototype.setLimit=function(e,t){this._physicsPlugin.setLimit(this,e,t)},t}(n),a=function(e){function t(t){return e.call(this,n.HingeJoint,t)||this}return r.d(t,e),t.prototype.setMotor=function(e,t){this._physicsPlugin.setMotor(this,e||0,t)},t.prototype.setLimit=function(e,t){this._physicsPlugin.setLimit(this,e,t)},t}(s),c=function(e){function t(t){return e.call(this,n.Hinge2Joint,t)||this}return r.d(t,e),t.prototype.setMotor=function(e,t,i){void 0===i&&(i=0),this._physicsPlugin.setMotor(this,e||0,t,i)},t.prototype.setLimit=function(e,t,i){void 0===i&&(i=0),this._physicsPlugin.setLimit(this,e,t,i)},t}(s)},50:function(e,t,i){"use strict";i.d(t,"a",function(){return a});var r=i(1),n=i(18),o=i(6),s=i(4),a=(i(322),i(325),function(e){function t(t,i,r,n,a,c,h,l,u,p,d){void 0===c&&(c=o.a.BILINEAR_SAMPLINGMODE),void 0===u&&(u=s.a.TEXTURETYPE_UNSIGNED_INT),void 0===p&&(p=""),void 0===d&&(d=!1);var f=e.call(this,t,"kernelBlur",["delta","direction","cameraMinMaxZ"],["circleOfConfusionSampler"],n,a,c,h,l,null,u,"kernelBlur",{varyingCount:0,depCount:0},!0)||this;return f.direction=i,f.blockCompilation=d,f._packedFloat=!1,f._staticDefines="",f._staticDefines=p,f.onApplyObservable.add(function(e){f._outputTexture?e.setFloat2("delta",1/f._outputTexture.width*f.direction.x,1/f._outputTexture.height*f.direction.y):e.setFloat2("delta",1/f.width*f.direction.x,1/f.height*f.direction.y)}),f.kernel=r,f}return r.d(t,e),Object.defineProperty(t.prototype,"kernel",{get:function(){return this._idealKernel},set:function(e){this._idealKernel!==e&&(e=Math.max(e,1),this._idealKernel=e,this._kernel=this._nearestBestKernel(e),this.blockCompilation||this._updateParameters())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"packedFloat",{get:function(){return this._packedFloat},set:function(e){this._packedFloat!==e&&(this._packedFloat=e,this.blockCompilation||this._updateParameters())},enumerable:!0,configurable:!0}),t.prototype.updateEffect=function(e,t,i,r,n,o){void 0===e&&(e=null),void 0===t&&(t=null),void 0===i&&(i=null),this._updateParameters(n,o)},t.prototype._updateParameters=function(t,i){for(var r=this._kernel,n=(r-1)/2,o=[],s=[],a=0,c=0;c<r;c++){var h=c/(r-1),l=this._gaussianWeight(2*h-1);o[c]=c-n,s[c]=l,a+=l}for(c=0;c<s.length;c++)s[c]/=a;var u=[],p=[],d=[];for(c=0;c<=n;c+=2){var f=Math.min(c+1,Math.floor(n));if(c===f)d.push({o:o[c],w:s[c]});else{var _=f===n,m=s[c]+s[f]*(_?.5:1),g=o[c]+1/(1+s[c]/s[f]);0===g?(d.push({o:o[c],w:s[c]}),d.push({o:o[c+1],w:s[c+1]})):(d.push({o:g,w:m}),d.push({o:-g,w:m}))}}for(c=0;c<d.length;c++)p[c]=d[c].o,u[c]=d[c].w;o=p,s=u;var y=this.getEngine().getCaps().maxVaryingVectors,P=Math.max(y,0)-1,b=Math.min(o.length,P),v="";v+=this._staticDefines,-1!=this._staticDefines.indexOf("DOF")&&(v+="#define CENTER_WEIGHT "+this._glslFloat(s[b-1])+"\r\n",b--);for(c=0;c<b;c++)v+="#define KERNEL_OFFSET"+c+" "+this._glslFloat(o[c])+"\r\n",v+="#define KERNEL_WEIGHT"+c+" "+this._glslFloat(s[c])+"\r\n";var S=0;for(c=P;c<o.length;c++)v+="#define KERNEL_DEP_OFFSET"+S+" "+this._glslFloat(o[c])+"\r\n",v+="#define KERNEL_DEP_WEIGHT"+S+" "+this._glslFloat(s[c])+"\r\n",S++;this.packedFloat&&(v+="#define PACKEDFLOAT 1"),this.blockCompilation=!1,e.prototype.updateEffect.call(this,v,null,null,{varyingCount:b,depCount:S},t,i)},t.prototype._nearestBestKernel=function(e){for(var t=Math.round(e),i=0,r=[t,t-1,t+1,t-2,t+2];i<r.length;i++){var n=r[i];if(n%2!=0&&Math.floor(n/2)%2==0&&n>0)return Math.max(n,3)}return Math.max(t,3)},t.prototype._gaussianWeight=function(e){var t=-e*e/(1/3*2*(1/3));return 1/(Math.sqrt(2*Math.PI)*(1/3))*Math.exp(t)},t.prototype._glslFloat=function(e,t){return void 0===t&&(t=8),e.toFixed(t).replace(/0+$/,"")},t}(n.a))},69:function(e,t,i){"use strict";i.d(t,"b",function(){return a}),i.d(t,"a",function(){return c});var r=i(1),n=i(4),o=i(18),s=i(11),a=(i(270),i(271),function(e){function t(t,i,r,o,s,a,c,h){return void 0===r&&(r=null),void 0===c&&(c=n.a.TEXTURETYPE_UNSIGNED_INT),void 0===h&&(h=!1),e.call(this,t,"pass",null,null,i,r,o,s,a,void 0,c,void 0,null,h)||this}return r.d(t,e),t}(o.a)),c=function(e){function t(t,i,r,o,s,a,c,h){void 0===r&&(r=null),void 0===c&&(c=n.a.TEXTURETYPE_UNSIGNED_INT),void 0===h&&(h=!1);var l=e.call(this,t,"passCube",null,null,i,r,o,s,a,"#define POSITIVEX",c,void 0,null,h)||this;return l._face=0,l}return r.d(t,e),Object.defineProperty(t.prototype,"face",{get:function(){return this._face},set:function(e){if(!(e<0||e>5))switch(this._face=e,this._face){case 0:this.updateEffect("#define POSITIVEX");break;case 1:this.updateEffect("#define NEGATIVEX");break;case 2:this.updateEffect("#define POSITIVEY");break;case 3:this.updateEffect("#define NEGATIVEY");break;case 4:this.updateEffect("#define POSITIVEZ");break;case 5:this.updateEffect("#define NEGATIVEZ")}},enumerable:!0,configurable:!0}),t}(o.a);s.Engine._RescalePostProcessFactory=function(e){return new a("rescale",1,null,s.Engine.TEXTURE_BILINEAR_SAMPLINGMODE,e,!1,s.Engine.TEXTURETYPE_UNSIGNED_INT)}},93:function(e,t,i){"use strict";i.d(t,"a",function(){return n});var r=i(0),n=function(){function e(t,i){if(void 0===i&&(i=e.DefaultPluginFactory()),this._physicsPlugin=i,this._impostors=[],this._joints=[],!this._physicsPlugin.isSupported())throw new Error("Physics Engine "+this._physicsPlugin.name+" cannot be found. Please make sure it is included.");t=t||new r.Vector3(0,-9.807,0),this.setGravity(t),this.setTimeStep()}return e.DefaultPluginFactory=function(){throw"Import CannonJSPlugin or Fill DefaultPluginFactory static property on PhysicsEngine before relying on default physics plugin."},e.prototype.setGravity=function(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)},e.prototype.setTimeStep=function(e){void 0===e&&(e=1/60),this._physicsPlugin.setTimeStep(e)},e.prototype.getTimeStep=function(){return this._physicsPlugin.getTimeStep()},e.prototype.dispose=function(){this._impostors.forEach(function(e){e.dispose()}),this._physicsPlugin.dispose()},e.prototype.getPhysicsPluginName=function(){return this._physicsPlugin.name},e.prototype.addImpostor=function(e){e.uniqueId=this._impostors.push(e),e.parent||this._physicsPlugin.generatePhysicsBody(e)},e.prototype.removeImpostor=function(e){var t=this._impostors.indexOf(e);if(t>-1){var i=this._impostors.splice(t,1);i.length&&(i[0].physicsBody=null)}},e.prototype.addJoint=function(e,t,i){var r={mainImpostor:e,connectedImpostor:t,joint:i};i.physicsPlugin=this._physicsPlugin,this._joints.push(r),this._physicsPlugin.generateJoint(r)},e.prototype.removeJoint=function(e,t,i){var r=this._joints.filter(function(r){return r.connectedImpostor===t&&r.joint===i&&r.mainImpostor===e});r.length&&this._physicsPlugin.removeJoint(r[0])},e.prototype._step=function(e){var t=this;this._impostors.forEach(function(e){e.isBodyInitRequired()&&t._physicsPlugin.generatePhysicsBody(e)}),e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._impostors)},e.prototype.getPhysicsPlugin=function(){return this._physicsPlugin},e.prototype.getImpostors=function(){return this._impostors},e.prototype.getImpostorForPhysicsObject=function(e){for(var t=0;t<this._impostors.length;++t)if(this._impostors[t].object===e)return this._impostors[t];return null},e.prototype.getImpostorWithPhysicsBody=function(e){for(var t=0;t<this._impostors.length;++t)if(this._impostors[t].physicsBody===e)return this._impostors[t];return null},e.Epsilon=.001,e}()}}]);